{% extends "wb_base_site.html" %}
{% load i18n %}

{% block extrastyle %}
    {{ block.super }}
    <style type="text/css">
        #top-container, #site-content{
            width: 1000px;
        }
        #map_canvas{
            height: 400px;
        }
        #log {
            height: 200px;
            padding-left: 5px;
            overflow-y: scroll;
            background: black;
            list-style: none;
        }

        .log-entry {
            color: white;
            font-weight: bold;
            font-family: "Courier New";
        }
    </style>
{% endblock %}

{% block top_left %}
    Track Ongoing Rides
{% endblock %}

{% block content %}
    <div id="rides_container">
        <ul id="rides">
            <li class="ride"></li>
        </ul>
    </div>
    <div id="map_canvas"></div>
    <div id="log_console">
        <ul id="log">
            <li class="log-entry">Logging Started</li>
        </ul>
    </div>
{% endblock %}

{% block doc_ready %}
    {{ block.super }}
    <script type="text/javascript">
        var map;
        var infowindow;
        var markers = {};
        var positions = {};

        function renderLogs(logs) {
            var $log = $("#log");
            $.each(logs, function (i, entry) {
                var $li = $("<li></li>").addClass("log-entry").text(entry);
                $log.append($li);
            });
            $log.scrollTop($log.height());
        }
        function updatePositions(pp){
            $.each(pp, function (i, p) {
                positions[p.taxi_id] = p;
                var latLng = new google.maps.LatLng(p.lat, p.lon);
                var marker = markers[p.taxi_id];
                if (marker){
                    marker.setPosition(latLng);
                }
                else{
                    marker = new google.maps.Marker({
                        flat: true,
//                        'icon': '',
                        map: map,
                        position: latLng,
                        title: "#" + p.taxi_id,
                        icon: "/static/images/wb_site/taxi_marker.png"
                    });
                    google.maps.event.addListener(marker, 'click', function () {
                        console.log("click");
                        openInfoWindow(p.taxi_id);
                    });

                    markers[p.taxi_id] = marker;
                }

                // update info window with new content
                if (infowindow.active_taxi && infowindow.active_taxi == p.taxi_id){
                    openInfoWindow(p.taxi_id);
                }
            });
        }
        function openInfoWindow(taxi_id){
            var position = positions[taxi_id];
            var contentString = 'taxi #' + position.taxi_id;
            if (position.ride_id) {
                contentString += '\nassigned to ride #' + position.ride_id;
            }
            infowindow["active_taxi"] = taxi_id;
            infowindow.setContent(contentString);
            infowindow.open(map, markers[taxi_id]);
        }
        function updateRide(fmr){

        }
        $(function () {
            map = new google.maps.Map(document.getElementById("map_canvas"), {
                        center:new google.maps.LatLng(32.054026720778126, 34.790465719238234),
                        zoom:12,
                        mapTypeId:google.maps.MapTypeId.ROADMAP
                    }
            );

            infowindow = new google.maps.InfoWindow({
            });
            var channel_opened = false;
            var channel;
            var socket;
            var token = "{{ token }}";

            channel = new goog.appengine.Channel(token);
            socket = channel.open();
            socket.onerror = function () {
                log("socket: onerror");
            };
            socket.onclose = function () {
                log("socket: onclose");
            };
            socket.onopen = function () {
                log("socket: onopen", token);
                channel_opened = true;
            };
            socket.onmessage = function (msg) {
                log("socket: onmessage", msg);
                try {
                    var data = $.parseJSON(msg.data);
                    if (data.logs) {
                        renderLogs(data.logs);
                    }
                    if (data.positions){
                        updatePositions(data.positions);
                    }
                    if (data.ride){
                        // todo
                    }
                    if (data.fmr){
                        // todo
                    }
                } catch (e) {
                    log("error parsing: " + JSON.stringify(e), e)
                }
            };
        });
    </script>
{% endblock %}