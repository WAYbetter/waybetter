{% extends "connected_page.html" %}
{% load i18n %}

{% block title %}
        {% trans "Workstation page" %}
{% endblock title %}

{% block content %}

    <script type="text/javascript">
        var polling_enabled = true;
        $(document).ready(function() {
            initConnection();
            initAcceptOrders();
            initOrderTable();
            setStationDetails("{{ station_name }}", {{ station_rating }});
        });




        function setAcceptOrders(status) {
            $.post(
                    "{% url ordering.station_controller.update_online_status %}",
                    { status: status },
                    function(data, textStatus, XMLHttpRequest) {
                      var accept_orders = XMLHttpRequest.responseText == "True";
//                      checkbox.attr("checked", accept_orders);
                      pollingEnabled(accept_orders);
                    }
            );
        }


        function initAcceptOrders() {
            var init_val = "{{ work_station.accept_orders }}" == "True";
            $("#accept_orders input").attr("checked", init_val);
            pollingEnabled(init_val);

            $("#accept_orders input").click(function() {
                var checkbox = $(this);
                var status = checkbox.attr("checked") ? "{{ online }}" : "{{ offline }}";
                setAcceptOrders(status);
                return false;
            });
        }

        function initConnection() {
            restoreState();
        }

        function pollingEnabled(val) {
            if (val) {
                $('#accept_orders').removeClass('offline');
                $('#accept_orders').addClass('online');
                polling_enabled = true;
                //pollOrders();

                $(document).everyTime({{ polling_interval }}, function() {
                    pollOrders();
                });

            } else {
                $('#accept_orders').removeClass('online');
                $('#accept_orders').addClass('offline');

                polling_enabled = false;
            }
        }

        function pollServer(url) {
            $.ajax({
                url: url,
                dataType: "json",
                complete: function(XMLHttpRequest, textStatus) {
                    if (XMLHttpRequest.status == 0) { // no response from server
                        onError();
                    }
                    /*
                    $(document).oneTime({{ polling_interval }}, function() {
                        pollOrders();
                    });
                    */
                },
                success: onOrder,
                error: onError

                });
        }

        function pollOrders() {
//            if (polling_enabled) {
            if (parentSandboxBridge && parentSandboxBridge.is_online()) {
                pollServer("{% url ordering.station_controller.get_orders %}");
            }
        }
        
        function restoreState() {
            $.ajax({
                url: "{% url ordering.station_controller.get_workstation_orders %}",
                dataType: "json",
                complete: function(XMLHttpRequest, textStatus) {
                    if (XMLHttpRequest.status == 0) { // no response from server
                        onError();
                    }
                },
                success: onOrder,
                error: onError
            });
        }

        
        function onOrder(incoming_orders) {
            clearError();
            if (incoming_orders) {
                for (var count = 0; count < incoming_orders.length; count++) {
                    renderOrder(incoming_orders[count]);
                    handleAddRow();
                }
            }
        }

        function initOrderTable() {
            var order_table = $("<table></table>").attr('width', '80%')
                .append($("<tr></tr>")
{#                    .append($("<th></th>").append("{% trans 'Order ID' %}"))#}
{#                    .append($("<th></th>").append("{% trans 'Status' %}"))#}
                    .append($("<th></th>").append("{% trans 'From' %}"))
                    .append($("<th></th>").append("{% trans 'To' %}"))
                    .append($("<th></th>").attr('colspan', 5).append("{% trans 'Actions' %}"))
                );

            $("#orders").empty().append(order_table);
        }

        function renderOrder(order) {
            if ($("#orders table").length == 0) {
                initOrderTable();
            }
            
            var select = $("<select name='pickup_time'></select>").attr('id', 'pickup_time_for_' + order.pk);
           {% for n in pickup_times %}
            select.append($("<option>").val('{{ n }}').append("{{ n }} {% trans 'minutes' %}"));
           {% endfor %}

            var send_button = $("<button></button").append('{% trans 'Send' %}').button().click(function() {
                acceptOrder(order.pk);
            });

            var reject_button = $("<button></button").append('{% trans 'Reject' %}').button().click(function() {
                rejectOrder(order.pk);
            });

            var progress_indicator = $("<span class='indicator'></span>").append("<img src='/static/img/indicator_small.gif'>").hide();

            var timer = $("<div class='timer'></div>").progressbar({ value: 0 });
            timer.everyTime(1000, function() {
                var cur_value = timer.progressbar("value") / 100.0;
                var increment = 1.0 / {{ timout_interval }};
                timer.progressbar("value", (cur_value + increment) * 100);
                if (timer.progressbar("value") >= 100) {
                    rendered_order.fadeOut("normal", function() {
                        rendered_order.remove();
                        handleRemoveRow();
                    });
                }
            }, {{ timout_interval }});
            
            var rendered_order = $("<tr class='order'></tr>").attr('id', order.pk)
//                .append($("<td></td>").append(order.pk))
//                .append($("<td></td>").append('&nbsp;'))
                .append($("<td></td>").append(order.fields.from_raw))
                .append($("<td></td>").append(order.fields.to_raw))
                .append($("<td></td>").append("{% trans 'Pickup in' %} ").append(select))
                .append($("<td></td>").append(send_button))
                .append($("<td></td>").append(reject_button))
                .append($("<td></td>").append(timer))
                .append($("<td></td>").append(progress_indicator));

            $("#orders table").append(rendered_order);
            rendered_order.show().effect("highlight", {}, 1300);

            handleOrder();
        }

        function acceptOrder(order_id) {
            $("#orders #" + order_id + " .indicator").show();
            var pickup_time = $("#pickup_time_for_" + order_id).val();
            $.ajax({"url": "{% url ordering.station_controller.update_order_status %}", "type":"post", "data":{"status": "{{ accept }}", "pickup_time": pickup_time, "order_id": order_id},
                "success": updateOrderCallback, "error": onError
            });
        }

        function rejectOrder(order_id) {
            $("#orders #" + order_id + " .indicator").show();
            $.ajax({"url": "{% url ordering.station_controller.update_order_status %}", "type":"post", "data":{"status": "{{ reject }}", "order_id": order_id},
                "success": updateOrderCallback, "error": onError
            });
        }

        function updateOrderCallback(json) {
            var data = eval("(" + json + ")");
            $("#orders #" + data.order_id).fadeOut("normal", function() {
                $(this).remove();
                handleRemoveRow();
            });
        }

        function handleOrder() {
            try {
                parentSandboxBridge.onIncomingOrder();
            }
            catch (e) {
                alert(e);
            }
        }

        function handleRemoveRow() {
            try {
                parentSandboxBridge.removeRow();
            }
            catch (e) {
                alert(e);
            }
        }

        function handleAddRow() {
            try {
                parentSandboxBridge.addRow();
            }
            catch (e) {
                alert(e);
            }
        }

        function resizeContainer(nrows) {
            try {
                parentSandboxBridge.resizeWindow(nrows);
            }
            catch (e) {
                alert(e);
            }
        }

        function setStationDetails(name, rating) {
            try {
                parentSandboxBridge.setStationDetails(name, rating);
            }
            catch (e) {
                alert(e);
            }
        }
      
    </script>
    <div id ="accept_orders">
        <input type="checkbox" name="accept_orders" value="Accept Orders" />  {% trans 'Accept Orders' %}
    </div>

    <div id="orders">
        No orders yet...
    </div>

{% endblock content %}