{% extends "connected_page.html" %}
{% load i18n %}

{% block title %}
        {% trans "Workstation page" %}
{% endblock title %}
{% block extrastyle %}
    <style type="text/css">
    *  {
		font-family: Arial, Calibri, sans-serif;
		font-weight: Bold;
	}
    table {
		border: 0 solid;
		width: 320px;
		border-spacing: 0;
	}
	tr {
		background: -webkit-gradient(linear, left top, left bottom, from(#565656), to(#000000));
		height: 44px;
	}
	td:first-child {
		padding-left: 7px;
	}
	td:last-child {
		padding-right: 7px;
	}
	td {
		padding: 0 3px;
	}
	.button_txt {
		color: black;
		text-shadow: #e6e6e6 0 1px 0;
	}
    .button_txt:disabled {
        color: gray;
    }
	.button_bg {
		background: -webkit-gradient(linear, left top, left bottom, from(#ececec), to(#8f8f8f));
		/* border: 1px solid  black; */
		-webkit-border-radius: 5px;
		width: 36px;
		height: 23px;
		padding-top: 5px;
		padding-left: 6px;
	}
	.button_bg:hover{
		background: -webkit-gradient(linear, left top, left bottom, from(#ffffff), to(#b9b9b9));
		cursor: pointer;
		/* border: 1px solid  black; */
	}
	.button_bg:active{
		color: white;
		background: -webkit-gradient(linear, left top, left bottom, from(#929292), to(#929292));
		text-shadow: none;
		/* border: 1px solid  black; */
	}
	.reject_button_bg {
		/* background-color: blue ; */
		background: -webkit-gradient(linear, left top, left bottom, from(#ececec), to(#8f8f8f)) ;
		/* border: 1px solid  black; */
		-webkit-border-radius: 5px;
		width: 23px;
		height: 23px;
		padding-top: 5px;
		padding-left: 6px;
	}
	.reject_button_bg:hover{
		background: -webkit-gradient(linear, left top, left bottom, from(#ffffff), to(#b9b9b9));
		cursor: pointer;
		/* border: 1px solid  black; */
	}
	.reject_button_bg:active{
		color: white;
		background: -webkit-gradient(linear, left top, left bottom, from(#929292), to(#929292));
		text-shadow: none;
		/* border: 1px solid  black; */
	}
	.reject_image{
		background-image: url(/static/images/reject.png) ;
		background-repeat: no-repeat;
		background-position: center center;
		width: 12px;
		height: 12px;
		padding-left: 5px;
		padding-top: 7px;
	}
	input, textarea, select {
		background-image: url(/static/images/combo02.png) ;
		text-shadow: #e6e6e6 0 1px 0;
		text-align: right;
		padding-top: 2px;
        padding-left: 21px;
		font-size: 16px;
		width: 85px;
		height: 29px;
		/* background: -webkit-gradient(linear, left top, left bottom,  from(#ececec), to(#8f8f8f)) ; */
		-webkit-appearance: none;
		/* -webkit-box-shadow: 1px 1px 1px #fff; */
		-webkit-border-radius: 5px;
		 border: none;
	}
	.combo:hover{
		background-image: url(/static/images/combo_hover02.png) ;
		cursor: pointer;
	}
	.from_address{
		color: white;
		text-align: right;
	}
	.from_address:hover{
		color: yellow;
		text-decoration:underline;
		cursor: pointer;
	}
	.pb-row {
		height: 7px;
	}
	.pb-row > td {
		padding-bottom: 4px;
		padding-top: 1px;
		background: black;
	}
	.pb {
		background: -webkit-gradient(linear, left top, left bottom, from(#000000), to(#615b5b));
		border: 1px solid  #1b1b1b;
		-webkit-border-radius: 3px;
		height: 7px;
		position: relative;
	}

	.pb > .ui-progressbar-value {
		background: -webkit-gradient(
			linear,
			left bottom,
			left top,
			color-stop(0, rgb(154,20,20)),
			color-stop(0.46, rgb(255,2,2)),
			color-stop(0.55, rgb(248,94,94)),
			color-stop(1, rgb(255,175,175))
		);
		position: absolute;
		right: 0;
		-webkit-border-radius: 3px;
		height: 7px;
		width:30%;
	}

	.loader{
		background-image: url(/static/images/loader3.gif) ;
		background-repeat: no-repeat;
		background-position: center center;
		width:48px;
		height: 58px;
		padding-left:45px;
	}

	.sending{
		color: white;
		text-align: left;
	}

	.reject_sending{
		background-image: url(/static/images/loader4.gif) ;
		background-repeat: no-repeat;
		background-position: center center;
		width: 24px;
		height: 24px;
	}
	.pb_green {
		background: -webkit-gradient(linear, left top, left bottom, from(#000000), to(#615b5b));
		border: 1px solid  #1b1b1b;
		-webkit-border-radius: 3px;
		height: 7px;
		position: relative;
	}

	.pb_green > .ui-progressbar-value {
	background: -webkit-gradient(
		linear,
		left bottom,
		left top,
		color-stop(0, rgb(71,153,20)),
		color-stop(0.45, rgb(15,255,2)),
		color-stop(0.55, rgb(112,248,94)),
		color-stop(0.93, rgb(176,255,175))
		);
		position: absolute;
		right: 0;
		-webkit-border-radius: 3px;
		height: 7px;
		width:30%;
	}

	.order_sent{
		color: yellow;
		text-align: left;
        height: 48px;
        padding-top: 10px;
	}

	.pb_sent {
		background: -webkit-gradient(linear, left top, left bottom, from(#000000), to(#615b5b));
		border: 1px solid  #1b1b1b;
		-webkit-border-radius: 3px;
		height: 7px;
		position: relative;
	}

	.pb_sent > .ui-progressbar-value {
	background: -webkit-gradient(
		linear,
		left bottom,
		left top,
		color-stop(0, rgb(71,153,20)),
		color-stop(0.45, rgb(15,255,2)),
		color-stop(0.55, rgb(112,248,94)),
		color-stop(0.93, rgb(176,255,175))
		);
		position: absolute;
		right: 0;
		-webkit-border-radius: 3px;
		height: 7px;
		width:30%;
	}
	.finish_button_bg {
		/* background-color: blue ; */
		background: -webkit-gradient(linear, left top, left bottom, from(#ececec), to(#8f8f8f)) ;
		/* border: 1px solid  black; */
		-webkit-border-radius: 5px;
		width: 23px;
		height: 23px;
		padding-top: 5px;
		padding-left: 6px;
	}
	.finish_button_bg:hover{
		background: -webkit-gradient(linear, left top, left bottom, from(#ffffff), to(#b9b9b9));
		cursor: pointer;
		/* border: 1px solid  black; */
	}
	.finish_button_bg:active{
		color: white;
		background: -webkit-gradient(linear, left top, left bottom, from(#929292), to(#929292));
		text-shadow: none;
		/* border: 1px solid  black; */
	}
	.sent_image{
		background-image: url(/static/images/sent.png) ;
		background-repeat: no-repeat;
		background-position: center center;
		width: 16px;
		height: 16px;
		padding-left: 0;
		padding-top: 2px;
	}
}
</style>

{% endblock extrastyle %}
{% block content %}

    <script type="text/javascript">
        var polling_enabled = true;
        $(document).ready(function() {
            initConnection();
            initAcceptOrders();
            initOrderTable();
            setStationDetails("{{ station_name }}", {{ station_rating }});
        });

        function setAcceptOrders(status) {
            $.post(
                    "{% url ordering.station_controller.update_online_status %}",
                    { status: status },
                    function(data, textStatus, XMLHttpRequest) {
                      var accept_orders = XMLHttpRequest.responseText == "True";
                      pollingEnabled(accept_orders);
                    }
            );
        }


        function initAcceptOrders() {
            var init_val = "{{ work_station.accept_orders }}" == "True";
            $("#accept_orders input").attr("checked", init_val);
            pollingEnabled(init_val);

            $("#accept_orders input").click(function() {
                var checkbox = $(this);
                var status = checkbox.attr("checked") ? "{{ online }}" : "{{ offline }}";
                setAcceptOrders(status);
                return false;
            });
        }

        function initConnection() {
            restoreState();
        }

        function pollingEnabled(val) {
            if (val) {
                $('#accept_orders').removeClass('offline');
                $('#accept_orders').addClass('online');
                polling_enabled = true;
                //pollOrders();

                $(document).everyTime({{ polling_interval }}, function() {
                    pollOrders();
                });

            } else {
                $('#accept_orders').removeClass('online');
                $('#accept_orders').addClass('offline');

                polling_enabled = false;
            }
        }

        function pollServer(url) {
            $.ajax({
                url: url,
                dataType: "json",
                complete: function(XMLHttpRequest, textStatus) {
                    if (XMLHttpRequest.status == 0) { // no response from server
                        onError();
                    }
                    /*
                    $(document).oneTime({{ polling_interval }}, function() {
                        pollOrders();
                    });
                    */
                },
                success: onOrder,
                error: onError

                });
        }

        function pollOrders() {
//            if (polling_enabled) {
            if (polling_enabled || window.parentSandboxBridge && (parentSandboxBridge.is_online() || parentSandboxBridge.is_error())) {
                pollServer("{% url ordering.station_controller.get_orders %}");
            }
        }

        function restoreState() {
            $.ajax({
                url: "{% url ordering.station_controller.get_workstation_orders %}",
                dataType: "json",
                complete: function(XMLHttpRequest, textStatus) {
                    if (XMLHttpRequest.status == 0) { // no response from server
                        onError();
                    }
                },
                success: onOrder,
                error: onError
            });
        }


        function onOrder(incoming_orders) {
            clearError();
            if (incoming_orders) {
                for (var count = 0; count < incoming_orders.length; count++) {
                    renderOrder(incoming_orders[count]);
                    handleAddRow();
                }
            }
        }

        function initOrderTable() {
            var order_table = $("<table></table>");
            $("#orders").empty().append(order_table);
        }

        function renderOrder(order) {
            if ($("#orders table").length == 0) {
                initOrderTable();
            }

            var select = $("<select name='pickup_time' class='combo'></select>").attr('id', 'pickup_time_for_' + order.pk);
            select.append($("<option>").val('').append("{% trans 'Define time' %}"));
           {% for n in pickup_times %}
            select.append($("<option>").val('{{ n }}').append("{{ n }} {% trans 'minutes' %}"));
           {% endfor %}
            select.change(function() {
                if($(this).val()) {
                    send_button.attr("disabled", "");
                } else {
                    send_button.attr("disabled", "disabled");
                }
            });

            var send_button = $('<div disabled=disabled class="button_txt button_bg" title="{% trans 'Send message to passenger' %}"></div>').text('{% trans 'Send' %}').click(function() {
                if ($(this).attr("disabled")) {
                    return false;
                }
                acceptOrder(order.pk);
            });

            var reject_button = $("<div class='reject_button_bg'><div class='reject_image'></div></div>").click(function() {
                rejectOrder(order.pk);
            });

            var progress_indicator = $("<div class='pb'></div>").progressbar({ value: 100 });

            progress_indicator.everyTime(1000, function() {
                var cur_value = progress_indicator.progressbar("value") / 100.0;
                var increment = 1.0 / {{ timout_interval }};
                progress_indicator.progressbar("value", (cur_value - increment) * 100);
                if (progress_indicator.progressbar("value") < 0.1) {
                    removeOrderRow(order.pk);
                }
            }, {{ timout_interval }});

            var rendered_order = $("<tr class='order'></tr>").attr('id', order.pk)
                    .append($("<td></td>").append(send_button))
                    .append($("<td></td>").append(select))
                    .append($("<td class='from_address'></td>").append(order.fields.from_raw))
                    .append($("<td></td>").append(reject_button));

            var progress_bar = $("<tr class='pb-row'></tr>")
                .append($("<td colspan=4></td>").append(progress_indicator));

            $("#orders table").append(rendered_order).append(progress_bar);
            rendered_order.show();

            handleOrder();
        }

        function setStateSending(order_id) {
            var order_row = $("#orders #" + order_id);
            $(order_row.children()[0]).empty().append("<div class='sending'>{% trans 'Sending...' %}</div>");
            $(order_row.children()[1]).empty().append("<div class='loader'></div>");
            $(order_row.children()[3]).empty().append("<div class='reject_sending'></div>");
            order_row.next().hide();
        }

        function setStateSent(data) {
            var order_row = $("#orders #" + data.order_id);
            $(order_row.children()[0]).empty().append("<div class='button_txt button_bg'>{% trans 'Close' %}</div>").click(function() {
                removeOrderRow(data.order_id);
            });
            $(order_row.children()[1]).empty().append($("<div class='order_sent'></div>").text(data.pickup_message));
            $(order_row.children()[3]).empty().append("<div class='finish_button_bg' title='{% trans 'End' %}'><div class='sent_image'></div></div>").click(function() {
                removeOrderRow(data.order_id);
            });
//            order_row.next().find("div").removeClass(function() { $(this).attr('class')}).addClass("pb_sent");
            order_row.next().hide();
        }
        function removeOrderRow(order_id) {
            var order_row  = $("#orders #" + order_id);
            var actual_rows = order_row.add(order_row.next());
            actual_rows.fadeOut("normal", function() {
                actual_rows.remove();
            });
            handleRemoveRow();
        }
        function acceptOrder(order_id) {
            var pickup_time = $("#pickup_time_for_" + order_id).val();
            setStateSending(order_id);
            $.ajax({"url": "{% url ordering.station_controller.update_order_status %}", "type":"post", "data":{"status": "{{ accept }}", "pickup_time": pickup_time, "order_id": order_id},
                "success": updateOrderCallback, "error": onError
            });
        }


        function rejectOrder(order_id) {
            $("#orders #" + order_id + " .indicator").show();
            $.ajax({"url": "{% url ordering.station_controller.update_order_status %}", "type":"post", "data":{"status": "{{ reject }}", "order_id": order_id},
                "success": updateOrderCallback, "error": onError
            });
        }

        function updateOrderCallback(json) {
            var data = eval("(" + json + ")");
            if (data.order_status == "stale") {
                removeOrderRow(data.orde_id);
            } else {
                setStateSent(data);
            }
        }

        function handleOrder() {
            try {
                if (window.parentSandboxBridge)
                    parentSandboxBridge.onIncomingOrder();
            }
            catch (e) {
                alert(e);
            }
        }

        function handleRemoveRow() {
            try {
                if (window.parentSandboxBridge)
                    parentSandboxBridge.removeRow();
            }
            catch (e) {
                alert(e);
            }
        }

        function handleAddRow() {
            try {
                if (window.parentSandboxBridge)
                    parentSandboxBridge.addRow();
            }
            catch (e) {
                alert(e);
            }
        }

        function resizeContainer(nrows) {
            try {
                if (window.parentSandboxBridge)
                    parentSandboxBridge.resizeWindow(nrows);
            }
            catch (e) {
                alert(e);
            }
        }

        function setStationDetails(name, rating) {
            try {
                if (window.parentSandboxBridge)
                    parentSandboxBridge.setStationDetails(name, rating);
            }
            catch (e) {
                alert(e);
            }
        }

    </script>
    <div id="orders">
        No orders yet...
    </div>

{% endblock content %}