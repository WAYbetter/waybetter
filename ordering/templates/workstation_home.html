{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}
        {% trans "Workstation page" %}
{% endblock title %}

{% block content %}
    <script type="text/javascript">
        var orders = [];
        var is_in_error = false;
        
        $(document).ready(function() {
            initConnection();
        });
        
        function initConnection() {
            restoreState();
        }

        function pollServer(url) {
            $.ajax({
                url: url,
                dataType: "json",
                complete: function(XMLHttpRequest, textStatus) {
                    if (XMLHttpRequest.status == 0) { // no response from server
                        onError();
                    }
                    $(document).oneTime({{ polling_interval }}, function() {
                        pollOrders();
                    });
                },
                success: onOrder,
                error: onError

            });
        }
        function pollOrders() {
            pollServer("{% url ordering.station_controller.get_orders %}");
        }
        
        function restoreState() {
            pollServer("{% url ordering.station_controller.get_workstation_orders %}");
        }

        function onError(XMLHttpRequest, textStatus, errorThrown) {
            is_in_error = true;
            renderStatus();
        }

        function onOrder(incoming_orders) {
            is_in_error = false;
            renderStatus();
            if (incoming_orders) {
                for (var order_index in incoming_orders) {
                    renderOrder(incoming_orders[order_index]);
                }
            }
        }

        function renderStatus() {
            if (is_in_error) {
                $("#connection_status").html("an error occured...");
                $("#connection_status").show();

            } else {
                $("#connection_status").hide();
            }
        }
        function initOrderTable() {
            var order_table = $("<table></table>").attr('width', '60%')
                .append($("<tr></tr>")
                    .append($("<th></th>").append("{% trans 'Status' %}"))
                    .append($("<th></th>").append("{% trans 'From' %}"))
                    .append($("<th></th>").append("{% trans 'To' %}"))
                    .append($("<th></th>").attr('colspan', 3).append("{% trans 'Actions' %}"))
                );

            $("#orders").empty().append(order_table);
        }

        function renderOrder(order) {
            if ($("#orders table").length == 0) {
                initOrderTable();
            }
            
            var select = $("<select name='pickup_time'></select>").attr('id', 'pickup_time_for_' + order.pk);
           {% for n in pickup_times %}
            select.append($("<option>").val('{{ n }}').append("{{ n }} {% trans 'minutes' %}"));
           {% endfor %}

            var send_button = $("<button></button").append('{% trans 'Send' %}').button().click(function() {
                acceptOrder(order.pk);
            });

            var reject_button = $("<button></button").append('{% trans 'Reject' %}').button().click(function() {
                rejectOrder(order.pk);
            });
            
            var rendered_order = $("<tr class='order'></tr>").attr('id', order.pk).hide()
                .append($("<td></td>").append('&nbsp;'))
                .append($("<td></td>").append(order.fields.from_raw))
                .append($("<td></td>").append(order.fields.to_raw))
                .append($("<td></td>").append("{% trans 'Pickup in' %} ").append(select))
                .append($("<td></td>").append(send_button))
                .append($("<td></td>").append(reject_button));

            $("#orders table").append(rendered_order);
            rendered_order.effect("highlight", {}, 1300);

        }

        function acceptOrder(order_id) {
            var pickup_time = $("#pickup_time_for_" + order_id).val();
            $.ajax({"url": "{% url ordering.station_controller.update_order_status %}", "type":"post", "data":{"status": "{{ accept }}", "pickup_time": pickup_time, "order_id": order_id},
                "success": updateOrderCallback, "error": function(xhr, status_code) {
//                    if (xhr.status == 500)
                    alert('Oops: ' + xhr.status);   
                }
            });
        }

        function rejectOrder(order_id) {
            $.ajax({"url": "{% url ordering.station_controller.update_order_status %}", "type":"post", "data":{"status": "{{ reject }}", "order_id": order_id},
                "success": updateOrderCallback, "error": function(xhr, status_code) {
//                    if (xhr.status == 500)
                    alert('Oops: ' + xhr.status);
                }
            });
        }

        function updateOrderCallback(json) {
            var data = eval("(" + json + ")");
            $("#orders #" + data.order_id).fadeOut("normal", function() {
                $(this).remove();
            });
        }
      
    </script>
    <div id="connection_status"></div>
    <div id="orders">
        No orders yet...
    </div>
{% endblock content %}