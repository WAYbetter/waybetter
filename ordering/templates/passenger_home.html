{% extends "base_passenger.html" %}
{% load i18n %}
{% block page_specific_head %}
<script type="text/javascript" src="/static/js/jquery.form.js"></script>
{% endblock %}

{% block content %}
        <script language="javascript">
            $.widget("custom.catcomplete", $.ui.autocomplete, {
                options: {
                    minLength: 3,
                    delay: 400
                },
                _renderMenu: function(ul, items) {
                    var self = this,
                        currentCategory = undefined;

                    $.each(items, function(index, item) {
                        if (item.category != currentCategory) {
                            ul.append("<li class='ui-autocomplete-category'>" + item.category + "</li>");
                            currentCategory = item.category;
                        }
                        self._renderItem(ul, item);
                    });
                }
            });


            var ADDRESS_FIELD_ID_BY_TYPE = {"from": "id_from_raw", "to": "id_to_raw"};

            var map_markers = {};
            var map_markers_popups = {};
            var choices = {};   // address_type -> list of address choices
            var selected_choices = {};  //  address_type -> index of selected choice

            function initPoints() {
                for (var address_type in ADDRESS_FIELD_ID_BY_TYPE) {
                    var address = Address.fromFields(address_type);

                    if (address.lon && address.lat) {
                        addPoint(address_type);
                    }
                }
            }

            $(document).ready(function() {
                $("input:text").each(function(i, element) {
                    var address_type = element.name.split("_")[0];
                    $(element).catcomplete({
                        source: function (request, response) {
                            var params = { "term":request.term };  //TODO_WB: add max_size parameter, when "More..." is requested
                            $.ajax({
                                url: '{% url ordering.passenger_controller.resolve_address %}',
                                data: params,
                                dataType: "json",
                                success: function(resolve_results) {
                                    if (resolve_results.geocode.length == 0 && resolve_results.history.length == 0) {
                                        response([{
                                            label: "{% trans 'Could not resolve address' %}",
                                            value: request.term
                                        }]);

                                    } else { // create autocomplete items from server response
                                        var items = $.map(resolve_results.history, function(item) {
                                            return {
                                                label: item.name,
                                                value: item.name,
                                                category: "{% trans 'History Suggestions' %}",
                                                address: Address.fromServerResponse(item, address_type)
                                            }
                                        });

                                        response(items.concat($.map(resolve_results.geocode, function(item) {
                                            return {
                                                label: item.name,
                                                value: item.name,
                                                category: "{% trans 'Map Suggestions' %}",
                                                address: Address.fromServerResponse(item, address_type)
                                            }
                                        })));
                                    }
                                }
                            });
                        },
                        select: function (event, ui) {
                            if (ui.item.address) {
                                updateAddressChoice(ui.item.address);
                            }
                        },
                        open: function(event, ui) {
                            $('ul.ui-autocomplete').css("z-index", 3000);
                        }
                    });
                });
                
                $("input:button, input:submit").button();

                $("#order_button").button("disable");
                $("#id_from_raw, #id_to_raw").change(function() {
                    validateForBooking();
                });

                $("#order_form").submit(function() {
                    if ($("#order_button").attr("disabled")) {
                        return false;
                    }
                    
                    $(this).ajaxSubmit({
                        dataType: "json",
                        success: function(order_status) {
                            clearError();
                            if (order_status.status == "booked") {
                                window.location.href = order_status.order_status_url;
                            } else {
                                alert("error: " + order_status.errors);
                            }
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            if (XMLHttpRequest.status == 403) {
                                if (XMLHttpRequest.responseText == "{{ not_a_user }}") {
                                    Registrator.openRegistrationDialog(bookOrder);
                                } else if (XMLHttpRequest.responseText == "{{ not_a_passenger }}") {
                                    Registrator.openPhoneDialog(bookOrder);
                                }
                            } else {
                                onError(XMLHttpRequest, textStatus, errorThrown);
                            }
                        }
                    });

                    return false;
                }); // submit

                //TODO_WB:add a check for map, timeout and check again.
                setTimeout('initPoints()', 100);
            });

            function bookOrder() {
                $("#order_form").submit();
            }
            
            // Address object constructor
            function Address(name, street, city, country, geohash, lon, lat, address_type) {
                this.name = name;
                this.street = street;
                this.city = city;
                this.country = country;
                this.geohash = geohash;
                this.lon = lon;
                this.lat = lat;
                this.address_type = address_type;
            }

            // static factory method
            Address.fromFields = function (address_type) {
                var name = $('#id_' + address_type + '_raw').val();
                var city = $('#id_' + address_type + '_city').val();
                var street = $('#id_' + address_type + '_street_address').val();
                var country = $('#id_' + address_type + '_country').val();
                var geohash = $('#id_' + address_type + '_geohash').val();
                var lon = $('#id_' + address_type + '_lon').val();
                var lat = $('#id_' + address_type + '_lat').val();

                return new Address(name, street, city, country, geohash, lon, lat, address_type);
            };

            Address.fromServerResponse = function (address_result, address_type) {
                return new Address(address_result["name"], address_result["street"], address_result["city"],
                        address_result["country"], address_result["geohash"], address_result["lon"], address_result["lat"], address_type);
            };


            // instance methods
            Address.prototype.isResolved = function() {
                return (this.lon && this.lat) && (this.name == $('#id_geocoded_' + this.address_type + '_raw').val());
            };
            Address.prototype.populateFields = function () {
                $('#id_' + this.address_type + '_raw').val(this.name);
                $('#id_geocoded_' + this.address_type + '_raw').val(this.name);
                $('#id_' + this.address_type + '_city').val(this.city);
                $('#id_' + this.address_type + '_street_address').val(this.street);
                $('#id_' + this.address_type + '_country').val(this.country);
                $('#id_' + this.address_type + '_geohash').val(this.geohash);
                $('#id_' + this.address_type + '_lon').val(this.lon);
                $('#id_' + this.address_type + '_lat').val(this.lat);
            };


            function MapMarker(lon, lat, location_name, icon_image, is_center) {
                this.lon = lon;
                this.lat = lat;
                this.location_name = location_name;
                this.icon_image = icon_image;
                this.is_center = is_center;
            }

            function addPoint(address_type) {
                var address = Address.fromFields(address_type);
                var location_name = address_type + ": " + $('#id_' + address_type + '_raw').val();

                var icon_image = "/static/img/" + address_type + "_map_marker.png";

                //TODO_WB:fix center behavior to show both points
                var center = true;
                var point = new MapMarker(address.lon, address.lat, location_name, icon_image, center);
                map_markers[address_type] = point;
                renderMapMarkers();
            }

            function renderMapMarkers() {
			    var map = g_waze_map.map;
                var markers = map.getLayersByName("Markers")[0];
                if (!markers) {
                    markers = new OpenLayers.Layer.Markers( "Markers" );
                    map.addLayer(markers);
                }
                markers.clearMarkers();
                var bounds = new OpenLayers.Bounds();
                for (var location_name in map_markers) {
                    var point = map_markers[location_name];
                    var lonlat = new OpenLayers.LonLat(point.lon + 20, point.lat + 20);
                    bounds.extend(lonlat);

                    var size = new OpenLayers.Size(15,34);
                    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
                    var icon = new OpenLayers.Icon(point.icon_image,size,offset);
                    markers.addMarker(new OpenLayers.Marker(lonlat,icon));
                    if (map_markers_popups[location_name]) {
                        map.removePopup(map_markers_popups[location_name]);
                    }
                    map_markers_popups[location_name] = new OpenLayers.Popup.FramedCloud("test",lonlat,null,
                                "<div style='font-family:Arial,sans-serif;font-size:0.8em;'>"+point.location_name+"<div>",
                                anchor=null,true,null);
                    map.addPopup(map_markers_popups[location_name]);
                }
                map.zoomToExtent(bounds);
			}

            function invokeResolveAddress(address_field, address_type) {
                var params = {"address": address_field};  //TODO_WB: add max_size parameter, when "More..." is requested
                $.getJSON('{% url ordering.passenger_controller.resolve_address %}', params, function(resolve_result) {
                    $('#indicator_for_' + address_type + '_raw').hide();
                    if (resolve_result.length == 0) {
                        $("#choices_for_" + address_type + "_raw").html("{% trans "Can't resolve address" %}").addClass("ui-state-error");
                    }
                    else if (resolve_result.length == 1) {
                        updateAddressChoice(Address.fromServerResponse(resolve_result[0], address_type));
                    } else {
                        showAddressCandidates(address_type, resolve_result);
                    }
                });
            }

            function setAddresses() {
                for (var address_type in ADDRESS_FIELD_ID_BY_TYPE) {
                    var address = Address.fromFields(address_type);
                    if (!address.isResolved()) {
                        var address_field = $("#" + ADDRESS_FIELD_ID_BY_TYPE[address_type]).val();
                        $('#indicator_for_' + address_type + '_raw').show();
                        invokeResolveAddress(address_field, address_type);
                    }
                }
            }

            function chooseAddress(address_type, i) {
                selected_choices[address_type] = i;
                updateAddressChoice(choices[address_type][i]);
                renderAddressChoices(address_type);
            }

            function updateAddressChoice(address) {
                address.populateFields();
                addPoint(address.address_type);
                if (address.address_type == "from") {
                    $("#id_to_raw").focus();
                }
                getRideCostEstimate();
                validateForBooking();
            }

            function validateForBooking() {
                for (var address_type in ADDRESS_FIELD_ID_BY_TYPE) {
                    var address = Address.fromFields(address_type);
                    if (!address.isResolved()) {
                        $("#order_button").button("disable");
                        return;
                    }
                }
                $("#order_button").button("enable");
            }

            function getRideCostEstimate() {
                var from_x = $("#id_from_lon").val();
                var from_y = $("#id_from_lat").val();
                var to_x = $("#id_to_lon").val();
                var to_y = $("#id_to_lat").val();
                if (from_x && from_y && to_x && to_y) {
                    $.ajax({
                       url: '{% url ordering.passenger_controller.estimate_ride_cost %}',
                       type: 'get',
                       dataType: 'json',
                       data: { from_x: from_x, from_y: from_y, to_x: to_x, to_y: to_y},
                       success: renderRideEstimatedCost
                    });
                }
            }

            function renderRideEstimatedCost(data) {
                var label = "<img src='/static/img/cost.jpg'> {% trans 'Estimated ride cost' %}: ";
                label += data.estimated_cost + "{% trans "NIS" %}";
                label += " (" + data.estimated_duration + ")";
                $("#ride_cost_estimate").html(label);
            }

            function renderAddressChoices(address_type) {
                var layer = $("#choices_for_" + address_type + "_raw").removeClass("ui-state-error");
                var choices_list = "";
                for (var i in choices[address_type]) {
                    var address_result = choices[address_type][i];
                    var link = "javascript:chooseAddress('" + address_type + "', " + i + ")";
                    var choice_name = choices[address_type][i]["name"];
                    var element_class = "";
                    if (i == selected_choices[address_type]) {
                        element_class = "style='background-color: lightBlue'";
                    }
                    choices_list += "<a href=\"" + link + "\" " + element_class + ">" + choice_name + "</a><br/>";
                }
                layer.html(choices_list);
            }
            function showAddressCandidates(address_type, resolve_result) {
                var results = eval(resolve_result);
                choices[address_type] = new Array();
                for (var i in results) {
                    var address_result = results[i];
                    var address = Address.fromServerResponse(address_result, address_type);
                    choices[address_type][i] = address;
                }
                renderAddressChoices(address_type);
            }

        </script>
        <div id="greeting">
            {% trans "Welcome" %} {{ user.username }}!
        </div>
        <div class="form_container" style="width:500px">

            <form method="post" id="order_form" name="order_form" action="{% url ordering.passenger_controller.book_order %}">
                {% csrf_token %}
                {% for field in form %}
                    <div class="fieldWrapper">
                        {% if field.name in hidden_fields %}
                            {{ field.as_hidden }}
                        {% else %}
                            {{ field.errors }}
                            {{ field.label_tag }} {{ field }}
                            <div id="indicator_for_{{ field.name }}" style="display:none;"><img src="/static/img/indicator.gif"></div>
                            <input type="hidden" id="id_geocoded_{{ field.name }}" name="geocoded_{{ field.name }}">
                            <p id="choices_for_{{ field.name }}"></p>
                        {%  endif %}
                    </div>

                {% endfor %}
                <hr>
                <div id="map" style="width:300px;height:300px;">
                </div>
                <div id="ride_cost_estimate"></div>
                <input id="order_button" type="submit" value="{% trans "Book" %}">
            </form>
        </div>
        <script type="text/javascript">
		<!--
		    g_waze_config = {
				div_id:"map",
				locale : "israel",
				center_lon:34.7898,
				center_lat:32.08676,
				zoom:8,
				token:"e0df20e6-6d69-487b-a010-fd32b8ab6066",
				alt_base_layer:"israel_colors",
				alt_map_servers:"http://ymap1.waze.co.il/wms-c/",
                //callback:onInit//,
				//framed_cloud_image_url:"http://www.waze.co.il/test_api/cloud.png"
			};
		-->
		</script>
        <script type="text/javascript" src="http://www.waze.co.il/js/WazeEmbeddedMapNoJQuery.js"></script>
{% endblock content %}
{% block footer %}
 {{ block.super}}
<a href="{% url stations.views.stations_home %}">{% trans 'Taxi Stations' %}</a>
{% if request.user.is_authenticated %}
    | <a href="{% url ordering.passenger_controller.get_passenger_orders %}">{% trans 'My orders' %}</a>
{% endif %}
{% endblock footer %}