{% extends "wb_base_site.html" %}
{% block extrastyle %}
    {{ block.super }}
    <style type="text/css">
        #map {
            width: 300px;
            height: 250px;
        }
    </style>
{% endblock %}

{% block content %}
    <div id="content" ng-app="PlacePlaygroundApp" ng-cloak>
        <div class="container" ng-controller="PlaygroundCtrl">
            <div class="row">
                <div class="span8">
                    <div class="input-prepend">
                        <span class="add-on"><i class="icon-map-marker"></i></span>
                        <input type="text" ng-model="user_input">
                    </div>

                    <div class="row">
                        <ul ng-repeat="place in places| emptyifblank:user_input | filter:user_input">
                            <li>(( place.name )) <span class="badge badge-success">wb</span></li>
                        </ul>
                        <ul ng-repeat="suggestion in suggestions">
                            <li>
                                <span>(( pprint(suggestion) ))</span>
                                <span ng-show="suggestion.missing_hn" class="badge badge-important">invalid</span>
                                <span ng-show="suggestion.missing_hn" class="badge badge-warning">missing hn</span>
                            </li>
                        </ul>
                    </div>

                </div>
                <div class="span4">
                    <div id="map" wb-map></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script type="text/javascript">
        var app = angular.module('PlacePlaygroundApp', ['wbDefaults', 'wbGeoDirectives', 'wbGeoServices']);

        app.config(function ($interpolateProvider) {
            $interpolateProvider.startSymbol('((');
            $interpolateProvider.endSymbol('))');
        });
        app.filter("emptyifblank", function(){ return function(object, query){
            if(!query)
                return {};
            else
                return object;
        }});
        app.controller('PlaygroundCtrl', function ($scope, $http, $q, GeocodingService, AutocompleteService, PlacesService, wbEvents) {
            $scope.autocomplete_service = AutocompleteService;

            $scope.user_input = undefined;
            $scope.suggestions = [];

            {% autoescape off %}
            $scope.places = {{ places }};
            {% endautoescape %}

            $scope.pprint = function(suggestion){
                if (suggestion && suggestion.place){
                    return suggestion.place.formatted_address;
                }
                return "undefined";
            };

            $scope.$watch("user_input", function (val) {
                if (!val){
                    $scope.suggestions = [];
                    return;
                }

                AutocompleteService.get_suggestions(val).then(function (results) {
                    $scope.suggestions = results;
                }, function(){ });
            });

        });
    </script>
{% endblock %}