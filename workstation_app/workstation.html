<html>
<head>
    <title>wayBetter workstation</title>

    <script src="js/AIRAliases.js" type="text/javascript"></script>
    <script src="js/jquery-1.4.2.min.js" type="text/javascript"></script>
    <script src="js/jquery.preloader.js" type="text/javascript"></script>

    <script>


        var BASE_HEIGHT = 70;
        var ROW_HEIGHT = 100;
        var ROW_WIDTH = 331;

        var numberOfRows = 0;

        var Exposed = {};

        Exposed.trace = function(str) {
            air.trace(str);
        };

        Exposed.playNotificationSound = function() {
            try {
                var soundPath = new air.URLRequest("notify_sound.mp3");
                var s = new air.Sound();
                s.load(soundPath);
                s.play();
            } catch (e) {
                try {
                    alert(e);
                } catch (e1) {
                    alert(e1);
                }
            }

        }

        Exposed.drawAttention = function() {
            this.trace("Popping up workstation app...");
            var win = window.nativeWindow;
            win.visible = true;
	        win.activate();
	        win.notifyUser('critical');
            air.NativeWindowDisplayState = "normal";
            win.alwaysInFront = true;
            win.alwaysInFront = false;
        }

        Exposed.addRow = function() {
            Exposed.resizeWindow(++numberOfRows);
        }

        Exposed.removeRow = function() {
            Exposed.resizeWindow(--numberOfRows);
        }

        Exposed.resizeWindow = function(nrows) {

            numberOfRows = nrows;

            var bounds = new air.Rectangle();

            bounds.x = ( air.Capabilities.screenResolutionX - 1024 ) / 2;
            bounds.y = ( air.Capabilities.screenResolutionY - 768 ) / 2;
            bounds.width = ROW_WIDTH;
            var appHeight = numberOfRows * ROW_HEIGHT;
            bounds.height = BASE_HEIGHT + appHeight;

            window.nativeWindow.bounds = bounds;

            $("#app").height(appHeight);
        }

        Exposed.onIncomingOrder = function() {
            Exposed.playNotificationSound();
            Exposed.drawAttention();
        }

        Exposed.setStationDetails = function(name, rating) {
            $("#title").html(name);
        }


        function setupApp() {
            air.NativeApplication.nativeApplication.autoExit = false;
            var iconLoad = new air.Loader();
            var iconMenu = new air.NativeMenu();
            var acceptOrdersCommand = iconMenu.addItem(new air.NativeMenuItem("Accept Orders"));
            acceptOrdersCommand.addEventListener(air.Event.SELECT,function(event){
                // todo implement
            });
            var exitCommand = iconMenu.addItem(new air.NativeMenuItem("Exit"));
            exitCommand.addEventListener(air.Event.SELECT,function(event){
                air.NativeApplication.nativeApplication.icon.bitmaps = [];
                air.NativeApplication.nativeApplication.exit();
            });

            if (air.NativeApplication.supportsSystemTrayIcon) {
                Exposed.trace("supportsSystemTrayIcon");
                air.NativeApplication.nativeApplication.autoExit = false;
                iconLoad.contentLoaderInfo.addEventListener(air.Event.COMPLETE,iconLoadComplete);
                iconLoad.load(new air.URLRequest("icons/AIRApp_16.png"));
                air.NativeApplication.nativeApplication.icon.tooltip = "AIR application";
                air.NativeApplication.nativeApplication.icon.menu = iconMenu;
            }

            if (air.NativeApplication.supportsDockIcon) {
                Exposed.trace("supportsDockIcon");
                iconLoad.contentLoaderInfo.addEventListener(air.Event.COMPLETE,iconLoadComplete);
                iconLoad.load(new air.URLRequest("icons/AIRApp_128.png"));
                air.NativeApplication.nativeApplication.icon.menu = iconMenu;
            }


//            $.preloadImages(
//                'images/icon_minimize_over13.png',
//                'images/icon_maximize_over13.png',
//                'images/icon_close_over13.png'
//            );

            $( '#chrome_top' ).mousedown( function( e ) {
                window.nativeWindow.startMove();
            } );

            $( '#maximize' ).click( function( e ) {
                if( window.nativeWindow.displayState == air.NativeWindowDisplayState.NORMAL )
                {
                    window.nativeWindow.maximize();
                } else {
                    window.nativeWindow.restore();
                }
            } );

            $( '#minimize' ).click( function( e ) {
                window.nativeWindow.minimize();
            } );

            $( '#close' ).click( function( e ) {
                window.nativeWindow.close();
            } );

            $( '#grip' ).mousedown( function( e ) {
                window.nativeWindow.startResize( air.NativeWindowResize.BOTTOM_RIGHT );
            } );

            //window.nativeWindow.x = ( air.Capabilities.screenResolutionX - window.nativeWindow.width ) / 2;
            //window.nativeWindow.y = ( air.Capabilities.screenResolutionY - window.nativeWindow.height ) / 2;

            Exposed.resizeWindow(0);

            window.nativeWindow.visible = true;

        }

        function setupBridge() {
            var iframe = document.getElementById("app");
            // make a function on the parent available to the child window
            iframe.contentWindow.parentSandboxBridge = Exposed;
        }


        var iconLoadComplete = function(event)
        {
            air.NativeApplication.nativeApplication.icon.bitmaps = [event.target.content.bitmapData];
        }


    </script>

    <link href="css/chrome.css" rel="stylesheet" type="text/css" />


</head>
<body topmargin="0" leftmargin="0" style="overflow:hidden;" onload="setupApp()">

<div id="chrome_top"></div>
<div id="chrome_bottom">Service provided by WAYbetter LTD. All rights reserved.</div>


<div id="title"></div>


<img id="grip" src="images/icon_grip.png" width="14" height="14" />

<iframe src="http://1.latest.waybetter-app.appspot.com/workstation"
		    sandboxRoot="http://1.latest.waybetter-app.appspot.com/workstation"
            id="app"
            ondominitialize="setupBridge()">

</iframe>

</body>
</html>

