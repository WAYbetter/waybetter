{% extends "wb_base_site.html" %}
{% load i18n %}

{% block extrastyle %}
    {{ block.super }}
    <style type="text/css">
        table {
            width: 100%;
        }

        table td {
            width: 50%;
        }

        input {
            width: 100%;
            margin-bottom: 15px;
        }

        .align-top {
            vertical-align: top;
        }

        .result_data {
            border: 1px solid #778899;
            direction: ltr;
            min-height: 250px;
            max-height: 250px;
            overflow-y: auto;
            font-family: courier;
            white-space: pre;
            border-radius: 5px;
        }

        #map_canvas {
            height: 300px;
            width: 100%;
        }

        #totals {
            min-height: 30px;
            position: absolute;
            left: -135px;
            background: white;
            white-space: pre;
            width: 130px;
            top: 0;
            text-align: center;
            font-family: sans-serif;
        }

        #directions {
            display: none;
        }
        #more {
            color: #87ceeb;
        }
    </style>

{% endblock %}
{% block content %}
    <table>
        <tr class="align-top">
            <td>
                <input type="text" id="pickup" placeholder="{% trans "Enter Pickup address" %}">

                <div class="result_data">Choose Pickup</div>
            </td>

            <td>
                <input type="text" id="dropoff" placeholder="{% trans "Enter Dropoff Address" %}">

                <div class="result_data">Choose Dropoff</div>
            </td>
        </tr>
        <tr>
            <td colspan="2" style="position: relative;">
                <div id="map_canvas"></div>
                <div id="totals" class="result_data">
                    <div id="text"></div>
                    <div id="more">click for more</div>
                </div>

            </td>
        </tr>
    </table>
    <div id="directions" class="result_data"></div>
{% endblock %}

{% block doc_ready %}
    {{ block.super }}

    {# see Places autocomplete API - http://code.google.com/apis/maps/documentation/javascript/places.html#places_autocomplete #}
    <script type="text/javascript"
            src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false&language=he"></script>

    <script type="text/javascript">
        var directionsDisplay;
        var directionsService = new google.maps.DirectionsService();
        var map;
        function initGmap() {
            var mapOptions = {
                center:new google.maps.LatLng(32.058536, 34.79059),
                zoom:13,
                mapTypeId:google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

            directionsDisplay = new google.maps.DirectionsRenderer();
            directionsDisplay.setMap(map);

            $("#totals").hide().click(function () {
                $("#directions").toggle()
            });

            makeAddressACPlaces("pickup");
            makeAddressACPlaces("dropoff");

        }

        function makeAddressACPlaces(input_id) {
            var input = document.getElementById(input_id);

            var defaultBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(32.032819, 34.741859),
                    new google.maps.LatLng(32.132594, 34.83284));

            var autocomplete = new google.maps.places.Autocomplete(input,
                    {
                        bounds:defaultBounds,
//                        types:['geocode']
                    });

            var marker = new google.maps.Marker({
                map:map
            });
            google.maps.event.addListener(autocomplete, 'place_changed', function () {
                $("#directions, #totals").hide();

                var place = autocomplete.getPlace();

                $(input).data("address", place);

                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }

                var image = new google.maps.MarkerImage(
                        place.icon,
                        new google.maps.Size(71, 71),
                        new google.maps.Point(0, 0),
                        new google.maps.Point(17, 34),
                        new google.maps.Size(35, 35));
                marker.setIcon(image);
                marker.setPosition(place.geometry.location);

                // get geocoding data from server
                $.ajax({
                    url:"{% url sharing.staff_controller.gmaps_resolve_address %}",
                    data:{
                        address:$(input).val()
                    },
                    dataType:"json",
                    success:function (response) {
                        var o = JSON.parse(response.results[0].raw_data);
                        $(input).next(".result_data").text(JSON.stringify(o, null, 4));
                    },
                    error:function () {
                    }
                });

                var pickup_address = $("#pickup").data("address");
                var dropoff_address = $("#dropoff").data("address");

                if (pickup_address && dropoff_address) {
                    var request = {
                        origin:pickup_address.geometry.location.lat() + "," + pickup_address.geometry.location.lng(),
                        destination:dropoff_address.geometry.location.lat() + "," + dropoff_address.geometry.location.lng(),
                        travelMode:google.maps.TravelMode.DRIVING
                    };
                    directionsService.route(request, function (result, status) {
                        if (status == google.maps.DirectionsStatus.OK) {
                            var total_distance = 0;
                            var total_duration = 0;
                            $.each(result.routes[0].legs, function (i, leg) {
                                total_distance += leg.distance.value;
                                total_duration += leg.duration.value;
                            });

                            $("#directions").text(JSON.stringify(result, null, 4));
                            $("#totals #text").text("Duration = " + (total_duration / 60).toFixed(2) + " min\nDistance = " + (total_distance / 1000).toFixed(2) + " km");
                            $("#totals").show();
                            directionsDisplay.setDirections(result);
                        }
                    })
                }
            })
        }

        function toggleMapStyle() {
            var pinkParksStyles = [
                {
                    featureType:"all",
                    stylers:[
                        { saturation:-80 }
                    ]
                },
                {
                    featureType:"poi.park",
                    stylers:[
                        { hue:"#ff0023" },
                        { saturation:40 }
                    ]
                }
            ];

            map.setOptions({styles:pinkParksStyles});
        }
        function makeAddressACServer(input) {
            var $input = $(input);

            $input.autocomplete({
                autoFocus:true,
                minLength:2,
                source:function (request, response) {
                    $.ajax({
                        url:"{% url sharing.staff_controller.gmaps_resolve_address %}",
                        data:{address:$input.val()},
                        dataType:"json",
                        success:function (data) {
                            response($.map(data.results, function (item) {
                                return {
                                    label:item.description,
                                    raw_data:item.raw_data
                                }
                            }));
                        },
                        error:function () {
                            response([]);
                        }
                    });
                },
                select:function (event, ui) {
                    var o = JSON.parse(ui.item.raw_data);
                    $input.next(".result_data").text(JSON.stringify(o, null, 4));
                    $(this).blur().autocomplete("disable");
                }

            });

            $input.blur(
                    function () {
                        $(this).autocomplete("disable");
                    }).focus(
                    function () {
                        $(this).autocomplete("enable");
                        $(this).autocomplete("search");
                        $(this).data("old_val", $(this).val());
                    }).keyup(function (e) {
                        if ($(this).data("old_val") !== $(this).val()) {
                            $(this).data("resolved", false);
                        }
                    });
        }


        $(document).ready(function () {
            initGmap();
//            makeAddressACServer("#pickup");
//            makeAddressACServer("#dropoff");
        })
    </script>
{% endblock %}
