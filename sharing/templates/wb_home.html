{% extends "wb_base_site.html" %}
{% load i18n %}
{% load value_from_settings %}

{% block pre_content %}
    <div id="map_container">

        <div id="cm-map"></div>

        <div id="banner">
            <div id="banner_content" class="hidden">
                <div id="slides">
                    {% if LANGUAGE_CODE == "he" %}
                        <img src="/static/images/wb_site/banner01_he.png">
                        <img src="/static/images/wb_site/banner02_he.png">
                        <img id="order_now" class="clickable" src="/static/images/wb_site/banner03_he.png">
                    {% else %}
                        <img src="/static/images/wb_site/banner01.png">
                        <img src="/static/images/wb_site/banner02.png">
                        <img id="order_now" class="clickable" src="/static/images/wb_site/banner03.png">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div id="feedback"></div>
{% endblock %}

{% block content %}

    <div id="booking_container">

        <div id="booking_teaser" class="booking_step">
            <div class="text">ככה נוסעים וחוזרים ממקומות מרכזיים</div>
            <button class="order_button blue">{% trans "Book a Shared Taxi Ride" %}</button>
        </div>

        <div id="booking_content" class="hidden">

            <div id="hotspot_content" class="booking_step">
                <div class="title">1. {% trans "Choose Central Location" %}</div>

                <select id="id_hotspot_select" name="hotspot_id"></select>

                <div class="btn_cntr">
                    <button id="leave_hotspot" class="wb_button">LEAVE HOTSPOT</button>
                    <button id="goto_hotspot" class="wb_button">GOTO HOTSPOT</button>
                </div>
            </div>

            <div id="address_content" class="booking_step hidden">
                <div class="title">2. {% trans "Enter Address" %}</div>

                <table>
                    <tr>
                        <td>
                            <label for="id_city">{% trans "City" %}:</label>
                            <select id="id_city" name="id_city">
                                {% for city in cities %}
                                    <option value="{{ city.id }}">{{ city.name }}</option>
                                {% endfor %}
                            </select>

                        </td>
                        <td>
                            <label for="id_street_address">{% trans "Street" %}:</label>
                            <input type="text" id="id_street_address" name="street_address"/>
                            <div id="street_error" class="error"></div>
                        </td>
                        <td>
                            <label for="id_house_number">{% trans "House No" %}:</label>
                            <input type="text" id="id_house_number" name="house_number"/>
                            <div id="house_number_error" class="error"></div>
                        </td>
                        <td>
                            <button id="set_address" class="wb_button">{% trans "Next" %} >></button>
                        </td>
                        <td>
                            <div id="address_loader" class="small-loader"></div>
                        </td>
                    </tr>
                </table>

            </div>

            <div id="datetime_content" class="booking_step hidden">
                <div class="title">3. {% trans "Define Time" %}</div>

                <table>
                    <tr>
                        <td>
                            <label for="id_hotspot_datepicker">{% trans "Date" %}:</label>
                            <input type="text" id="id_hotspot_datepicker" name="hotspot_date" class="depart">
                        </td>
                        <td>
                            <label for="id_hotspot_time">{% trans "Time" %}:</label>
                            <select id="id_hotspot_time" name="hotspot_time"></select>
                            <div id="id_estimated_pickup">
                                (
                                <span class="text bold">{% trans "_pickup" %}: </span>
                                <span class="value"></span>
                                )
                            </div>
                        </td>
                        <td>
                            <button id="set_datetime" class="wb_button">{% trans "Next" %} >></button>
                        </td>
                        <td>
                            <div id="datetime_loader" class="small-loader"></div>
                        </td>
                    </tr>
                </table>
            </div>

            <div id="details_content" class="booking_step hidden">
                <div class="title">4. {% trans "Get Offer" %}</div>

                <div class="ride_details">
                    <div id="save_stamp" class="hidden">
                <span class="container">
                    <span class="txt">{% trans "SAVE" %}</span>
                    <span class="value"></span>
                </span>
                    </div>
                    <span class="price" id="sharing_price">
                            <span class="value">0</span>
                            <span class="label">₪</span>
                        </span>
                        <span class="time" id="sharing_time">
                            <span class="value">0</span>
                            <span class="label">{% trans "min" %}</span>
                        </span>
                        <span class="price" id="private_price">
                            <span class="value">0</span>
                            <span class="label">₪</span>
                        </span>
                        <span class="time" id="private_time">
                            <span class="value">0</span>
                            <span class="label">{% trans "min" %}</span>
                        </span>
                </div>
                <button class="order_button blue" id="book_ride">{% trans "Book a Shared Taxi Ride" %}</button>

            </div>
        </div>

        <div id="booking_progress" class="hidden">
            <table>
                <tr>
                    <td><a class="hotspot step current" data-name="hotspot">1. {% trans "Central Location" %}</a></td>
                    <td><a class="address step disabled" data-name="address">2. {% trans "Address" %}</a></td>
                    <td><a class="datetime step disabled" data-name="datetime">3. {% trans "Time" %}</a></td>
                    <td><a class="details step disabled" data-name="details">4. {% trans "Get Offer" %}</a></td>
                </tr>
            </table>

        </div>
    </div>

    <div id="myrides_container">
        <h1>{% trans "My Next Rides" %}</h1>
        <hr>
        <table id="my_next_rides" class="myrides-table">
            {% include "myrides_table.html" %}
        </table>
        <div id="myrides_tooltip" class="hidden tooltip">
            {% include "myrides_tooltips.html" %}
        </div>
    </div>

{% endblock %}

{% block post_footer %}
    <div id="partners">
        <table class="ltr">
            <tr>
                <td>WAYbetter is proudly supported and powered by:</td>
                <td class="hr-td">
                    <div class="hr"></div>
                </td>
            </tr>
        </table>
        <table id="partner_logos">
            <tr>
                <td class="ibm-logo"></td>
                <td class="ny-taxi-logo"></td>
                <td class="peregrine-logo"></td>
                <td class="its-logo"></td>
            </tr>
            <tr>
                <td class="telmap-logo"></td>
                <td class="google-logo"></td>
                <td class="cloudmade-logo"></td>
            </tr>
        </table>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script type="text/javascript" src="http://tile.cloudmade.com/wml/latest/web-maps-lite.js"></script>
    <script type="text/javascript" src="/static/js/mylibs/slides.js"></script>
{% endblock %}

{% block doc_ready %}
    {{ block.super }}
    <script type="text/javascript">

    {% autoescape off %}
        var order_types = {{ order_types }};
    {% endautoescape%}

    var PICKUP = "pickup",
            DROPOFF = "dropoff",
            SHARING_TIME_FACTOR = 1.2

    function showMap() {
        $("#banner").hide();
    }

    function toggleLoaders(state) {
        $("#address_loader, #datetime_loader").toggle(state);
    }

    function setDirectionButtonsText(){
        var hs_name = $("#id_hotspot_select option:selected").data("name");
        hs_name = " " + (hs_name || "Hotspot");
        $("#leave_hotspot").text("{% trans "Leave" %}" + hs_name);
        $("#goto_hotspot").text("{% trans "Goto" %}" + hs_name);
    }

    function clearRideDetails() {
        log("clearRideDetails");

        $(".order_button").disable();
        $("#save_stamp").hide();
        $("#sharing_price .value").text(0);
        $("#sharing_time .value").text(0);
        $("#private_price .value").text(0);
        $("#private_time .value").text(0);
    }

    function showError(msg, onClose) {
        Registrator.openWBErrorDialog("{% trans 'OOPS...' %}", msg, onClose);
    }

    function showBookingStep(step_name) {
        var steps = ["hotspot", "address", "datetime", "offer"];
        var index = $.inArray(step_name, steps);
        if (index > -1){
            log("showBookingStep: " + step_name);
            $("#booking_content .booking_step").hide("slide", { direction: "right" });
            $("#" + step_name + "_content").trigger("beforeshow").show("slide", { direction: "left" });

            // mark this step as current
            $("#booking_progress .step").removeClass("current");
            $("#booking_progress .step." + step_name).removeClass("disabled").addClass("current");

            for (var i=0; i<index; i++){
                // mark all previous steps as completed
                $("#booking_progress .step." + steps[i]).addClass("completed");
            }
        }
    }

    function getHotspotTimes(options) {
        log("getHotspotTimes");
        if (BookingHelper.address) {
            HotspotHelper.refreshHotspotSelector({
                refresh_intervals: true,
                get_intervals_data: {
                    hotspot_type: BookingHelper.hotspot_type,
                    time_type: BookingHelper.hotspot_type,
                    lat: BookingHelper.address.lat,
                    lon: BookingHelper.address.lon
                },
                beforeSend: function() {
                    toggleLoaders(true);
                    $("#id_estimated_pickup").toggle(false);
                },
                onGotTimes: function() {
                    log("onGotTimes");
                    if (options.select_first) {
                        // do something
                    }
                    if (options.onGotTimes){
                        options.onGotTimes();
                    }
                },
                onNoTimes: function() {
                    showError("{% trans 'Please choose another date' %}", undefined);
                },
                complete: function() {
                    toggleLoaders(false);
                    $("#id_estimated_pickup").toggle(BookingHelper.hotspot_type == DROPOFF);
                },
                error: function() {
                    showError("{% trans 'We had a problem getting available intervals. Please try again.' %}", undefined);
                }
            });
        }
        else {
            $("#id_hotspot_time").empty().disable();
        }
    }

    function getRideDetails(options) {
        clearRideDetails();
        $.ajax({
            url: "{% url sharing.passenger_controller.get_hotspot_price %}",
            dataType: "json",
            data: {
                'lon': BookingHelper.address.lon,
                'lat': BookingHelper.address.lat,
                'num_seats': BookingHelper.num_seats,
                'hotspot_id': $("#id_hotspot_select").val(),
                'hotspot_type': BookingHelper.hotspot_type,
                'day': $("#id_hotspot_datepicker").val(),
                'time': $("#id_hotspot_time").val()
            },
            beforeSend: function() {
                toggleLoaders(true);
            },
            success: function(response) {
                if (response.sharing_price && response.sharing_time && response.private_price && response.private_time) {
                    $("#sharing_price .value").text(response.sharing_price);
                    $("#sharing_time .value").text(response.sharing_time);
                    $("#private_price .value").text(response.private_price);
                    $("#private_time .value").text(response.private_time);
                    $("#save_stamp .value").text(response.savings + "%");
                    $("#save_stamp").fadeIn("fast");
                    $(".order_button").enable();

                    gaHitPage("order_ready.html");
                } else {
                    showError("{% trans "Currently, there is no service to this address at the selected hour." %}", undefined);
                }
                if (options.success){
                    options.success();
                }
            },
            error: function() {
                showError("{% trans "We have encountered an error. Please try again." %}", undefined);
            },
            complete: function() {
                toggleLoaders(false);
            }
        });
    }

    function bookRide(){

    }

    $(function() {

        {% if request.user.passenger %}
            MyRidesHelper.init({
                {% if LANGUAGE_BIDI %}
                    rtl: true,
                {% endif %}
                order_types: order_types,
                next_rides_table: "#my_next_rides",
                next_rides_container: "#myrides_container",
                urls: {
                    get_myrides_data: "{% url sharing.passenger_controller.get_myrides_data %}",
                    get_order_status: "{% url sharing.passenger_controller.get_order_status %}",
                    cancel_order: "{% url sharing.passenger_controller.cancel_order %}"
                },
                messages: {
                    ride_cancelled: "{% trans "Ride cancelled." %}",
                    cancel_text: "{% trans "Info/Cancel" %}",
                    report_text: "{% trans "Report Ride" %}"
                }
            });

            MyRidesHelper.getData({'get_next_rides': true}, {
                        success: function(has_next, has_previous) {
                            if (has_next) $("#myrides_container").fadeIn("fast");
                        },
                        error: function() {
                            flashError("{% trans "Error getting rides data" %}")
                        }
                    });
        {% endif %}


        CMHelper.init({
            api_key: "{% value_from_settings "CLOUDMADE_API_KEY" %}",
            center_lat: 32.115985,
            center_lon: 34.835441
        });

        HotspotHelper.init({
            selectors: {
                hotspotpicker: "#id_hotspot_select",
                datepicker: "#id_hotspot_datepicker",
                timepicker: "#id_hotspot_time"
            },
            labels: {
                choose_date: "{% trans "Choose Date" %}",
                updating: "{% trans "Updating..." %}"
            },
            urls: {
                get_hotspot_data: "{% url sharing.passenger_controller.get_hotspots_data %}",
                get_hotspot_dates: "{% url sharing.passenger_controller.get_hotspot_dates %}",
                get_hotspot_times: "{% url sharing.passenger_controller.get_hotspot_times %}"
            }
        });
        HotspotHelper.makeHotSpotSelector({
            onSelectDate: function(dateText, inst) {
                getHotspotTimes({});
            },
            onSelectTime: function() {
                if (BookingHelper.hotspot_type == DROPOFF) {
                    var d = new Date($("#id_hotspot_datepicker").datepicker("getDate"));
                    var hh = $("#id_hotspot_time option:selected").text().split(":")[0];
                    var mm = $("#id_hotspot_time option:selected").text().split(":")[1];
                    d.setHours(hh);
                    d.setMinutes(mm);

                    var ride_duration_ms = HotspotHelper.ride_duration * 1000;
                    var est_pickup_private = new Date(d - ride_duration_ms);
                    var est_pickup_shared = new Date(d - ride_duration_ms * SHARING_TIME_FACTOR);
                    var time_txt = getFullTime(est_pickup_shared) + " - " + getFullTime(est_pickup_private);
                    var text = (d.getDate() == est_pickup_shared.getDate()) ?
                            time_txt : getFullDate(est_pickup_shared) + " {% trans 'at' %} " + time_txt;

                    $("#id_estimated_pickup .value").text(text);
                }
            }
        });

        AddressHelper.init({
            urls:{
                structured_resolve_url: "{% url sharing.passenger_controller.resolve_structured_address %}"
            },
            messages:{
                choose_from_list: "{% trans "Please choose from list" %}"
            }
        });
        AddressHelper.makeStructuredAddressInput("#id_city", "#id_street_address", "#id_house_number", "#address_loader",
                {
                    success: function() {
                        $("#street_error").text("");
                    }
                }
        );

        Registrator.init({
            urls            : {
                feedback_form_template: '{% url common.registration.feedback %}',
                pilot_interest_form_template: '{% url interests.views.pilot_interest %}',
                error_form_template: '{% url common.views.error_dialog %}'
            }
        });

        // teaser
        $("#booking_teaser button").click(function() {
            $("#booking_teaser").fadeOut("fast", function(){
                $("#booking_content, #booking_progress").fadeIn("fast");
            });
        });

        // hotspot
        $("#hotspot_content").bind("beforeshow", function() {
            setDirectionButtonsText();
        });

        $("#id_hotspot_select").change(function() {
            setDirectionButtonsText();
        });

        $("#leave_hotspot").click(function() {
            BookingHelper.hotspot_type = PICKUP;
            showBookingStep("address");
        });
        $("#goto_hotspot").click(function() {
            BookingHelper.hotspot_type = DROPOFF;
            showBookingStep("address");
        });

        // address
        $("#set_address").disable();
        $("#address_content").bind("beforeshow", function() {
            var address = BookingHelper.address;
            var title = (BookingHelper.hotspot_type == PICKUP) ? "{% trans "Where are you going" %}?" : "{% trans "Where are you coming from" %}?";
            $(this).find(".title").text("2. " + title);
            if (address){
                $("#id_street_address").val(address.street_address);
                $("#id_house_number").val(address.house_number);
                $("#id_city").val(address.city);
                $("#set_address").enable();
            }
            else{
                $("#set_address").disable();
            }
        });
        $("#address_content input").keyup(function() {
            var valid = Boolean($("#id_house_number").val() && $("#id_street_address").val());
            if (valid) {
                $("#set_address").enable();
            }
            else {
                $("#set_address").disable();
            }
        });
        $("#id_street_address").change(function(){
            $("#street_error").text("");
        }).keydown(function(e) {
            if (e.keyCode == 9 && !e.shiftKey) { // on tab
                e.preventDefault();
                $("#id_house_number").focus();
            }
        });

        $("#id_house_number").change(function(){
            $("#house_number_error").text("");
        }).keydown(function(e) {
            // prevent jumping from house number on 'tab' if next_btn is disabled
            if (e.keyCode == 9 && !e.shiftKey && $("#set_address").is(":disabled")) {
                e.preventDefault();
            }
        });

        $("#set_address").click(function() {
            var $sa_input = $("#id_street_address");
            var $hn_input = $("#id_house_number");
            AddressHelper.resolveStructured({
                city_selector       : "#id_city",
                street_input        : $sa_input,
                hn_input            : $hn_input,
                callbacks           :{
                    beforeSend:function() {
                        toggleLoaders(true);
                        $("#set_address").disable();
                        $sa_input.siblings("#street_error").text("");
                        $hn_input.siblings("#house_number_error").text("");
                    },
                    complete:function() {
                        toggleLoaders(false);
                    },
                    resolved: function(address) {
                        BookingHelper.address = address;
                        if (BookingHelper.hotspot_type == PICKUP) {
                            CMHelper.addBMarker(address.lat, address.lon, {title: address.name})
                        }
                        else {
                            CMHelper.addAMarker(address.lat, address.lon, {title: address.name})
                        }
                        getHotspotTimes({
                            select_first: false,
                            onGotTimes: function() {
                                showBookingStep("datetime");
                            }
                        });
                    },
                    unresolved:function(errors) {
                        $(".ui-autocomplete").hide();
                        if (errors.house_number) {
                            $("#house_number_error").text(errors.house_number);
                        }
                        if (errors.street) {
                            $("#street_error").text(errors.street);
                        }
                    }
                }
            });

        });

        // datetime
        $("#set_datetime").click(function() {
            getRideDetails({
                success: function() {
                    showBookingStep("details");
                }
            });
        });

        // details

        // progress
        $("#booking_progress .step").not(".details").click(function() {
            if (!$(this).hasClass("disabled")) {
                showBookingStep($(this).data("name"));
            }
        });




        var colors = ["rgb(22, 172, 211)"];
//        $("#wb_values .header").each(function() {
//            colors.push($(this).css("color"));
//        });
        $("#banner").css("background", colors[getRandomInt(0, colors.length - 1)]);
        $("#banner_content").show();
        $('#slides').slides({
            width: 800,
            startAtSlide: 0,
            direction: "left",
            preload: {
                active: true,
                image: "../static/images/wb_site/loading_large.gif"
            },
            playInterval: 15000,
            pauseInterval: 7500,
            navigation: false,
            pagination: true
        });

        $("#slides").slides("play");

        $("#feedback").click(function() {
            Registrator.openFeedbackDialog();
        });

        $("#sitemap ul:last").append('<li><a href="#" onclick="Registrator.openPilotInterestDialog()">{% trans "Join the private Beta" %}</a></li>');
    });

    // debug
//    $("#booking_teaser").hide();
//    $("#booking_content").show();
//    showBookingStep("address");
    </script>

{% endblock %}