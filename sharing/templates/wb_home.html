{% extends "wb_base_site.html" %}
{% load i18n %}
{% load value_from_settings %}

{% block pre_content %}
    <div id="map_container">

        <div id="cm-map"></div>

        <div id="banner">
            <div id="banner_content" class="hidden">
                <div id="slides">
                    {% if LANGUAGE_CODE == "he" %}
                        <img src="/static/images/wb_site/banner01_he.png">
                        <img src="/static/images/wb_site/banner02_he.png">
                        <img src="/static/images/wb_site/banner03_he.png">
                    {% else %}
                        <img src="/static/images/wb_site/banner01.png">
                        <img src="/static/images/wb_site/banner02.png">
                        <img src="/static/images/wb_site/banner03.png">
                    {% endif %}
                </div>
                <div id="tryitnow" class="clickable">{% trans "Try It Now" %}</div>
            </div>
        </div>
    </div>

    <div id="feedback"></div>
{% endblock %}

{% block content %}

    <div id="booking_container">
        <div id="save_stamp" class="hidden">
                <span class="container">
                    <span class="txt">{% trans "SAVE" %}</span>
                    <span class="value"></span>
                </span>
        </div>

        <div id="order_form_container">
            <div class="ribbon">{% trans "Enter Your WAY" %}</div>

            <form id="order_form">
                {% csrf_token %}

                <div id="pickup_input" class="input from" type="address_input">
                    <span class="desc"></span>
                    <span class="text"></span>
                    <span class="resolved_as"></span>
                </div>


                <div id="dropoff_input" class="input to" type="address_input">
                    <span class="desc"></span>
                    <span class="text"></span>
                    <span class="resolved_as"></span>
                </div>

                <div id="datetime_input" class="input datetime disabled" type="datetime_input">
{#                    <span class="type">{% trans "When" %}</span>#}
                    <span class="desc">{% trans "When" %}</span>
                    <div class="loader"></div>
                </div>

                <div id="switch" class="clickable"></div>
            </form>
        </div>

        <div id="ride_data_container">
            <div id="private_data_container" class="ride_data">
                <span class="header_img"></span>
                <span class="header">{% trans "Private Taxi Ride" %}</span>

                <div class="ride_details">
                    <div class="price_row">
                        <span class="desc">{% trans "Ride Price" %}</span>
                        <span class="price" id="private_price">
                                <span class="value">0</span>
                                <span class="label">₪</span>
                        </span>
                    </div>
                    <div class="time_row">
                        <span class="desc">{% trans "Est. Ride Duration" %}</span>
                        <span class="time" id="private_time">
                                <span class="value">0</span>
                                <span class="label">{% trans "min" %}</span>
                        </span>
                    </div>
                </div>
                <button class="order_button orange" id="book_private"></button>
            </div>

            <div id="ticket-perforation"></div>

            <div id="sharing_data_container" class="ride_data">
                <span class="header_img"></span>
                <span class="header">{% trans "WAYbetter Taxi Ride" %}</span>

                <div class="ride_details">
                    <div class="price_row">
                        <span class="desc">{% trans "Ride Price" %}</span>
                        <span class="price" id="sharing_price">
                            <span class="value">0</span>
                            <span class="label">₪</span>
                        </span>
                    </div>
                    <div class="time_row">
                        <span class="desc">{% trans "Est. Ride Duration" %}</span>
                        <span class="time" id="sharing_time">
                            <span class="value">0</span>
                            <span class="label">{% trans "min" %}</span>
                        </span>
                    </div>
                </div>
                <button class="order_button blue" id="book_sharing"></button>
            </div>

            <div class="clear"></div>
        </div>
    </div>
    <div id="myrides_container">
        <h1>{% trans "My Next Rides" %}</h1>
        <hr>
        <table id="my_next_rides" class="myrides-table">
            {% include "myrides_table.html" %}
        </table>
        <div id="myrides_tooltip" class="hidden tooltip">
            {% include "myrides_tooltips.html" %}
        </div>
    </div>

    <!-- anchor tips with changing content -->
    <div id="pickup_input_tip" class="tooltip"></div>
    <div id="dropoff_input_tip" class="tooltip"></div>
    <div id="datetime_input_tip" class="tooltip"></div>

    <!-- hidden container to hold tooltips content -->
    <div id="tooltip_helpers_container" class="hidden">

{#        <div id="select_input_helper" class="tooltip-content">#}
{#            <div class="header"></div>#}
{#            <div class="content">#}
{#                <div id="sel_address" class="clickable">#}
{#                    <span class="img"></span>#}
{#                    <span class="wb_link">{% trans "Enter Address" %}</span>#}
{#                </div>#}
{#                <div id="sel_hotspot" class="clickable">#}
{#                    <span class="img"></span>#}
{#                    <span class="wb_link">{% trans "Select Hotspot" %}</span>#}
{#                </div>#}
{#                <div class="clear"></div>#}
{#            </div>#}
{#            <div class="footer">#}
{#                <div class="help">{% trans "Note: Orders are only possible between TLV and Ramat Hachail." %}</div>#}
{#            </div>#}
{#        </div>#}

        <div id="hotspot_input_helper" class="tooltip-content">
            <div class="header"></div>
            <div class="content">
                <div id="hotspot_help">
                    {% trans "Hotspots are centers of activity from which & to which we offer WAYbetter service." %}
                </div>
{#                <label class="city">#}
{#                    <div>{% trans "Select City" %}:</div>#}
{#                    <select id="id_hotspot_city" name="hotspot_city">#}
{#                        {% for city in cities %}#}
{#                            <option value="{{ city.id }}">{{ city.name }}</option>#}
{#                        {% endfor %}#}
{#                    </select>#}
{#                </label>#}
                <div class="select-hotspot-container">
                    <div class="label">{% trans "Select HotSpot" %}:</div>
                    <div class="select">
                        <select id="id_hotspot_select" name="hotspot_id"></select>
                        <div id="id_hotspot_description"></div>
                    </div>
                    <div class="clear"></div>
                </div>
            </div>
            <div class="footer">
{#                <div class="help wb_link" id="switch2address">{% trans 'Switch to "Enter Address"' %}</div>#}
                <div class="help wb_link switch_dir">{% trans 'Switch direction' %}</div>
                <button class="next_btn wb_button"></button>
            </div>
        </div>

        <div id="address_input_helper" class="tooltip-content">
            <div class="header"></div>
            <div class="content">
                <label class="city">
                    <div class="label">{% trans "Select City" %}:</div>
                    <select id="id_city" name="id_city">
                        {% for city in cities %}
                            <option value="{{ city.id }}">{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </label>
                <div class="clear"></div>
                <div class="street_address">
                    <div class="label">{% trans "Address" %}:</div>
                    <div class="container">
                        <div>
                            <input type="text" id="id_street_address" name="street_address"
                                   placeholder="{% trans "Enter Address" %}"/>

                            <div class="err address_error"></div>
                        </div>
                        <div>
                            <input type="text" id="id_house_number" name="house_number"
                                   placeholder="{% trans "House #" %}"/>

                            <div class="err hn_error"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
{#                <div class="help wb_link" id="switch2hotspot">{% trans 'Switch to "Select HotSpot"' %}</div>#}
                <div class="help wb_link switch_dir">{% trans 'Switch direction' %}</div>
                <button class="next_btn wb_button"></button>
                <div class="tooltip_loader"></div>
            </div>
        </div>

        <div id="datetime_input_helper" class="tooltip-content">
            <div class="header datetime">{% trans "When" %}?</div>
            <div class="content">
                <div id="pickup_time_container">
                    <span id="pickup_time">{% trans "Choose Pickup Time" %}:</span>
                    <input type="text" id="id_hotspot_datepicker" name="hotspot_date" class="depart">
                    <span class="at">{% trans "at" %}</span>
                    <select id="id_hotspot_time" name="hotspot_time"></select>
                </div>

{#                <div id="time_radio">#}
{#                    <label>#}
{#                        <input id="pickup_time" type="radio" name="datetime_type" checked="checked"/>#}
{#                        {% trans "Pickup Time" %}#}
{#                    </label>#}
{#                    <label>#}
{#                        <input id="dropoff_time" type="radio" name="datetime_type"/>#}
{#                        {% trans "Dropoff Time" %}#}
{#                    </label>#}
{#                </div>#}
{#                <div id="time_tools" class="depart">#}
{#                    <div class="img depart"></div>#}
{#                    <input type="text" id="id_hotspot_datepicker" name="hotspot_date" class="depart"> {% trans "at" %} #}
{#                    <select id="id_hotspot_time" name="hotspot_time"></select>#}
{#                </div>#}
{##}
{#                <div class="clear"></div>#}
            </div>
            <div class="footer">
                <div class="help">{% trans "*Times may vary due to traffic and stuff..." %}</div>
                <button class="next_btn wb_button"></button>
                <div class="tooltip_loader"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block post_footer %}
    <div id="partners">
        <table class="ltr">
            <tr>
                <td>WAYbetter is proudly supported and powered by:</td>
                <td class="hr-td">
                    <div class="hr"></div>
                </td>
            </tr>
        </table>
        <table id="partner_logos">
            <tr>
                <td class="ibm-logo"></td>
                <td class="ny-taxi-logo"></td>
                <td class="peregrine-logo"></td>
                <td class="its-logo"></td>
            </tr>
            <tr>
                <td class="telmap-logo"></td>
                <td class="google-logo"></td>
                <td class="cloudmade-logo"></td>
            </tr>
        </table>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script type="text/javascript" src="http://tile.cloudmade.com/wml/latest/web-maps-lite.js"></script>
    <script type="text/javascript" src="/static/js/mylibs/slides.js"></script>
{% endblock %}

{% block doc_ready %}
    {{ block.super }}
    <script type="text/javascript">

    {% autoescape off %}
        var order_types = {{ order_types }};
    {% endautoescape%}

    var PICKUP = "pickup",
            DROPOFF = "dropoff",
            hotspot_type = PICKUP,
            address_lat = undefined,
            address_lon = undefined,
            address_name = undefined,
            select_input_resolved = false,
            hotspot_resolved = false,
            address_resolved = false,
            datetime_resolved = false,
            HOTSPOT_TEXT_MAX_LENGTH = 34;


    function getAddressType(element) {
        var $element = $(element);
        var id = "";

        if ($element.attr("type") == "address_input" || $element.hasClass("tooltip")) {
            id = $element.attr("id");
        }
        else {
            id = $element.parents(".tooltip").attr("id");
        }

        if (id) {
            return (id.split("_")[0] == PICKUP) ? PICKUP : DROPOFF;
        }
        else {
            return undefined;
        }
    }

    function getAddressInput(element) {
        var $input = $("#" + getAddressType(element) + "_input");
        if ($input.length > 0){
            return $input.eq(0);
        }
        else{
            return undefined;
        }
    }

    function isAddressInputResolved(input){
        return window[$(input).data("resolved_as") + "_resolved"];
    }

    function closeTooltips(exclude) {
        exclude = exclude || undefined;
        try {
            exclude = $(exclude).data("tooltip").getTip();
        }
        catch (e) {
        }

        $("[type='address_input'], [type='datetime_input'], #my_next_rides .info").each(function() {
            var api = $(this).data("tooltip");
            if (api) {
                if (exclude == api.getTip()) {
                    return true; // do not hide
                }
                else {
                    $(this).removeClass("tooltip-visible");
                    api.hide();
                }
            }
        });
    }

    function openTooltipHelper(trigger, helper_type) {
        if (!Boolean(helper_type)){
            helper_type = $(trigger).data("resolved_as");
        }
        
        $(trigger).addClass("tooltip-visible").removeClass("disabled");
        var $helper = $("#" + helper_type + "_input_helper");

        // restore last saved values
        $helper.find("input, select").each(function(i, el) {
            if ($(el).data("saved_val")) {
                $(el).val($(el).data("saved_val"));
            }
        });

        // helper specific stuff
        if (helper_type == "datetime") {
            getHotspotTimes(false);
        } else {
            var address_type = getAddressType(trigger);
            var hdr_txt = (address_type == PICKUP) ? "{% trans "Your Pickup" %}" : "{% trans "Your Dropoff" %}";
            $helper.find(".header").text(hdr_txt).removeClass(PICKUP + " " + DROPOFF).addClass(address_type);
        }

        // set button text
{#        var predicates = [hotspot_resolved, address_resolved, datetime_resolved];#}
{#        var resolved_count = predicates.sum() - window[helper_type + "_resolved"];#}
{#        var btn_txt = (resolved_count === predicates.length - 1) ? "{% trans "Calculate" %}" : "{% trans "Next" %}";#}
//        $helper.find(".next_btn").text(btn_txt);
        $helper.find(".next_btn").text('{% trans "Next" %}');

        // show the damn thing
        closeTooltips(trigger);
        var api = $(trigger).data("tooltip");
        if (api) {
            var tip = api.getTip();
            if (! tip) { // initialize tip
                api.show();
                tip = api.getTip();
            }
            $("#tooltip_helpers_container").append(tip.find(".tooltip-content")); // move old content to container
            tip.append($helper); // append new content
            api.show();
            $helper.show();
        }

        // call validator if any
        ($helper.data("validator") || function() {}).call();

        // init state
        if (helper_type == "address") {
            $("#id_street_address").focus();
        }
        else{
            $helper.find(".next_btn").focus();
        }
    }

    function openNextTooltip(here, there) {
        var $here = $(here);
        var $there = $(there);
        var here_resolved = isAddressInputResolved($here);
        var there_resolved = isAddressInputResolved($there);

        if (!here_resolved){
            openTooltipHelper($here, "");
        }
        else{
            if (!there_resolved) {
                openTooltipHelper($there, "");
            }
            else {
                    getHotspotTimes(true);
                    closeTooltips();
            }
        }
    }

    function toggleLoaders(mode){
        if (mode){
            $("#datetime_input .loader, #datetime_input_helper .tooltip_loader").show();
            $(".order_button").text("{% trans 'Calculating' %}...");
        }
        else{
            $("#datetime_input .loader, #datetime_input_helper .tooltip_loader").hide();
            initOrderingButtonsText();
        }
    }

    function getHotspotTimes(select_first) {
        datetime_resolved = false;
        clearDetails();
        if (hotspot_resolved && address_resolved) {
            var time_type = PICKUP;
//            var time_type = ($("#pickup_time").attr("checked")) ? PICKUP : DROPOFF;
            HotspotHelper.refreshHotspotSelector({
                refresh_intervals: true,
                get_intervals_data: {
                    hotspot_type: hotspot_type,
                    time_type: time_type,
                    lat: address_lat,
                    lon: address_lon
                },
                beforeSend: function(){
                    toggleLoaders(true);
                },
                onGotTimes: function(){
                    if (select_first){
                        $("#datetime_input").removeClass("disabled");
                        $("#datetime_input_helper .next_btn").click();
                    }
                },
                onNoTimes: function(){
                    showError("{% trans 'Please choose another date' %}", undefined);
                },
                complete: function(){
                    toggleLoaders(false);
                },
                error: function(){
                    showError("{% trans 'We had a problem getting available intervals. Please try again.' %}", undefined);
                }
            });
        }
        else {
            $("#id_hotspot_time").empty().disable();
        }
    }

    function showRideDetails(options) {
        clearDetails();
        $.ajax({
            url: "{% url sharing.passenger_controller.get_hotspot_price %}",
            dataType: "json",
            data: {
                'lon': address_lon,
                'lat': address_lat,
                'hotspot_id': $("#id_hotspot_select").val(),
                'day': $("#id_hotspot_datepicker").val(),
                'time': $("#id_hotspot_time").val()
            },
            beforeSend: function(){
                toggleLoaders(true);
                if (options.beforeSend){
                    options.beforeSend();
                }
            },
            success: function(response) {
                if (response.sharing_price && response.sharing_time && response.private_price && response.private_time) {
                    var saved = (response.private_price - response.sharing_price) / response.private_price * 100;
                    $("#sharing_price .value").text(response.sharing_price);
                    $("#sharing_time .value").text(response.sharing_time);
                    $("#private_price .value").text(response.private_price);
                    $("#private_time .value").text(response.private_time);
                    $("#save_stamp .value").text(Math.round(saved) + "%");
                    $("#save_stamp").fadeIn("fast");
                    $(".order_button").enable();

                    gaHitPage("order_ready.html");
                } else {
                    showError("{% trans "Currently, there is no service to this address." %}", undefined);
                }
            },
            error: function() {
                showError("{% trans "We have encountered an error. Please try again." %}", undefined);
            },
            complete: function(){
                toggleLoaders(false);
                closeTooltips();
                if (options.complete){
                    options.complete();
                }
            }
        });
    }

    function bookRide(is_private) {
        var $form = $("#order_form");
        $(".tooltip-content").appendTo("#tooltip_helpers_container");
        $("#tooltip_helpers_container").appendTo($form);

        var hidden_inputs = {
            is_private: is_private,
            time_type: PICKUP,
//            time_type: ($("#pickup_time").attr("checked")) ? PICKUP : DROPOFF,
            ride_duration: $("#id_hotspot_time").data("ride_duration"),
            hotspot_type: hotspot_type,
            lat: address_lat,
            lon: address_lon
        };

        $.each(hidden_inputs, function(k, v) {
            $form.find("input[name='" + k + "']").remove();
            $form.append($('<input type="hidden"/>').attr("name", k).attr("value", v));
        });

        {% if is_debug %}
            $form.find("input[name='is_debug']").remove();
            $form.append($('<input type="hidden" name="is_debug" value="true"/>'));
        {% endif %}

        var err_msg = "{% trans "We have encountered an error. Please try again." %}";
        $form.ajaxSubmit({
            url: "{% url sharing.passenger_controller.book_ride %}",
            type: "POST",
            beforeSend: function() {
                $(".order_button").disable();
                var $btn = (is_private) ? $("#book_private") : $("#book_sharing");
                $btn.text("{% trans 'Sending' %}...");
            },
            success: function(response) {
                if (response.status) {
                    if (response.status == "forbidden")
                        Registrator.openPilotInterestDialog();
                    if (response.status == "booked" && response.redirect)
                        window.location.href = response.redirect;
                    if (response.status == "failed") {
                        showError(response.message || err_msg, function() {
                            if (response.redirect) {
                                window.location.href = response.redirect;
                            }
                        });
                    }
                }
                else{
                    showError(err_msg, undefined);
                }
            },
            error:  function() {
                showError(err_msg, undefined);
            }
        });
    }

    function showMap() {
        $("#banner").hide();
    }

    function showError(msg, onClose) {
        Registrator.openWBErrorDialog("{% trans 'OOPS...' %}", msg, onClose);
        clearDetails();
    }

    function clearDetails(){
        $(".order_button").disable();
        $("#save_stamp").hide();
        $("#sharing_price .value").text(0);
        $("#sharing_time .value").text(0);
        $("#private_price .value").text(0);
        $("#private_time .value").text(0);
        initOrderingButtonsText();
    }

    function initAddressInputs(){
        $("#pickup_input .desc").text("{% trans 'From' %}");
        $("#dropoff_input .desc").text("{% trans 'To' %}");
        $("#pickup_input").data("resolved_as", "address");
        $("#dropoff_input").data("resolved_as", "hotspot");
        $("#pickup_input .resolved_as").text("({% trans 'Address' %})");
        $("#dropoff_input .resolved_as").text("({% trans 'HotSpot' %})");
        $("#pickup_input .text").text("");
        $("#dropoff_input .text").text("");
    }

    function initOrderingButtonsText(){
        $("#book_private").text("{% trans 'Book Private' %}");
        $("#book_sharing").text("{% trans 'Book WAYbetter' %}");
    }

    function cloneAddressInput(source, target) {
        $(target).data("resolved_as", $(source).data("resolved_as"));
        $.each([".text", ".resolved_as"], function(i, el) {
            $(target).find(el).replaceWith($(source).find(el));
        });

        if ($(source).find(".desc").text() == "") {
            $(target).find(".desc").text("");
        } else {
            var type = getAddressType(target);
            var text = (type == PICKUP) ? "{% trans 'From' %}" : "{% trans 'To' %}";
            $(target).find(".desc").text(text);
        }

    }

    function addressValidator() {
        var $address_helper = $("#address_input_helper");
        $address_helper.find(".next_btn").disable();

        var only_digits = $("#id_house_number").val().split(/\D+/).join("");
        $("#id_house_number").val(only_digits);

        var is_valid = Boolean($("#id_street_address").data("resolved")) && Boolean($("#id_house_number").val());
        if (is_valid) {
            $address_helper.find(".next_btn").enable();
        }
        return is_valid;
    }

    function datetimeValidator() {
        var $datetime_helper = $("#datetime_input_helper");
        $datetime_helper.find(".next_btn").disable();

        var is_valid = Boolean(!$("#id_hotspot_time:disabled").length && $("#id_hotspot_time option:selected")) && Boolean($("#id_hotspot_datepicker").val());
        if (is_valid) {
            $datetime_helper.find(".next_btn").enable();
        }
        return is_valid;
    }

    $(function() {

        {% if request.user.passenger %}
            MyRidesHelper.init({
                {% if LANGUAGE_BIDI %}
                    rtl: true,
                {% endif %}
                order_types: order_types,
                next_rides_table: "#my_next_rides",
                next_rides_container: "#myrides_container",
                urls: {
                    get_myrides_data: "{% url sharing.passenger_controller.get_myrides_data %}",
                    get_order_status: "{% url sharing.passenger_controller.get_order_status %}",
                    cancel_order: "{% url sharing.passenger_controller.cancel_order %}"
                },
                messages: {
                    ride_cancelled: "{% trans "Ride cancelled." %}",
                    cancel_link: "{% trans "Info/Cancel" %}"
                }
            });

            MyRidesHelper.getData({'get_next_rides': true}, {
                        success: function(has_next, has_previous) {
                            if (has_next) $("#myrides_container").fadeIn("fast");
                        },
                        error: function() {
                            flashError("{% trans "Error getting rides data" %}")
                        }
                    });
        {% endif %}


        CMHelper.init({
            api_key: "{% value_from_settings "CLOUDMADE_API_KEY" %}",
            center_lat: 32.115985,
            center_lon: 34.835441
        });

        HotspotHelper.init({
            selectors: {
                    hotspotpicker: "#id_hotspot_select",
                    datepicker: "#id_hotspot_datepicker",
                    timepicker: "#id_hotspot_time",
                    hs_description: "#id_hotspot_description"
            },
            labels: {
                choose_date: "{% trans "Choose Date" %}",
                updating: "{% trans "Updating..." %}"
            },
            urls: {
                get_hotspot_data: "{% url sharing.passenger_controller.get_hotspots_data %}",
                get_hotspot_dates: "{% url sharing.passenger_controller.get_hotspot_dates %}",
                get_hotspot_times: "{% url sharing.passenger_controller.get_hotspot_times %}"
            }
        });
        HotspotHelper.makeHotSpotSelector();
        $("#id_hotspot_datepicker").datepicker("option", {
            onSelect: function(dateText, inst) {
                getHotspotTimes(false);
            }
        });

        AddressHelper.init({
            urls:{
                structured_resolve_url: "{% url sharing.passenger_controller.resolve_structured_address %}"
            }
        });
        AddressHelper.makeStructuredAddressInput("#id_city", "#id_street_address", "#id_house_number", "#address_input_helper .tooltip_loader");

        Registrator.init({
            urls            : {
                feedback_form_template: '{% url common.registration.feedback %}',
                pilot_interest_form_template: '{% url interests.views.pilot_interest %}',
                error_form_template: '{% url common.views.error_dialog %}'
            }
        });

        var tooltip_conf = {
            relative: true,
            effect: 'fade',
            {% if LANGUAGE_BIDI %}
                position: 'top left',
                offset: [94, 620],
            {% else %}
                position: 'top right',
                offset: [94, -160],
            {% endif %}
            events: {
                // "" is supposedly better for oldIE
                address_input: 'click, ""',
                datetime_input: ',',
                tooltip: 'mouseenter, ""'
            }
        };

        $("#pickup_input").tooltip($.extend({}, tooltip_conf, {tip: "#pickup_input_tip"}));
        $("#dropoff_input").tooltip($.extend({}, tooltip_conf, {tip: "#dropoff_input_tip"}));
        $("#datetime_input").tooltip($.extend({}, tooltip_conf, {tip: "#datetime_input_tip"}));

        initAddressInputs();
        initOrderingButtonsText();
        $(".order_button").disable();

        $("html").click(function(e) {
            var id_exceptions = ["switch", "tryitnow"];
            var $target = $(e.target);

            var close = $.inArray($target.attr("id"), id_exceptions) == -1;

            if (close) {
                // maybe clicked inside tooltip?
                var class_list = ["tooltip", "tooltip-content", "ui-datepicker", "ui-datepicker-header", "ui-autocomplete"];

                var inside_tooltip = false;
                $.each(class_list, function(i, class_name) {
                    if ($target.hasClass(class_name) || $target.parents("." + class_name).length) {
                        inside_tooltip = true;
                        return false; //break;
                    }
                });
                close = !inside_tooltip
            }

            if (close) {
                closeTooltips();
            }
        });

        $("[type='address_input']").click(function(e) {
            e.stopPropagation();
            openTooltipHelper($(this), "");
        });

        $("#datetime_input").click(function(e) {
            e.stopPropagation();
            if (!$(this).hasClass("disabled")){
                openTooltipHelper($(this), "datetime");
            }
        });

        $("#tryitnow").click(function() {
            openTooltipHelper("#pickup_input", "");
        });

        function switchInputs() {
            // clone existing data
            var $pickup_clone = $("#pickup_input").clone(true);
            var $dropoff_clone = $("#dropoff_input").clone(true);

            // swap contents
            cloneAddressInput($pickup_clone, "#dropoff_input");
            cloneAddressInput($dropoff_clone, "#pickup_input");

            $.each(["pickup", "dropoff"], function(i, name) {
                var $input = $("#" + name + "_input");
                $input.removeClass("resolved");
                if (isAddressInputResolved($input)) {
                    $input.addClass("resolved");
                }
            });

            // swap markers
            hotspot_type = (hotspot_type == PICKUP) ? DROPOFF : PICKUP;
            if (hotspot_resolved) {
                HotspotHelper.refreshHotspotMarker(hotspot_type);
            }
            if (address_resolved) {
                if (hotspot_type == PICKUP) {
                    CMHelper.addBMarker(address_lat, address_lon, {title: address_name});
                }
                else {
                    CMHelper.addAMarker(address_lat, address_lon, {title: address_name});
                }
            }
        }

        $("#switch, .switch_dir").click(function() {
            switchInputs();

            var $here = undefined;
            if ($(this).attr("id") == "switch"){
                $here = getAddressInput($(".input.tooltip-visible"));
            }
            if ($(this).hasClass("switch_dir")){
                $here = getAddressInput(this);
            }

            if($here) {
                var $there = (getAddressType($here) == PICKUP) ? $("#" + DROPOFF + "_input") : $("#" + PICKUP + "_input");
                openNextTooltip($here, $there); // will refresh times
            }
            else{
                getHotspotTimes(true);
            }

        });

//        $("#sel_hotspot, #sel_address").click(function(e) {
//            e.stopPropagation();
//
//            var sel_type = $(this).attr("id").split("_")[1];
//            openTooltipHelper(getAddressInput(this), sel_type);
//        });

{#        $("#switch2hotspot, #switch2address").click(function(e) {#}
{#            e.stopPropagation();#}
{##}
{#            hotspot_resolved = address_resolved = datetime_resolved = select_input_resolved = false;#}
{#            address_lat = address_lon = undefined;#}
{#            $("[type='address_input']").data("resolved_as", false).each(function() {#}
{#                $(this).text($(this).hasClass("from") ? "{% trans "From" %}" : "{% trans "To" %}");#}
{#            });#}
{#            $("#datetime_value").text("");#}
{#            CMHelper.removeMarker("all");#}
{#            var helper_type = this.id.split("2")[1];#}
{#            openTooltipHelper(getAddressInput(this), helper_type);#}
{#        });#}

//        $("#pickup_time, #dropoff_time").change(function() {
//            getHotspotTimes();
//            var time_type = ($("#pickup_time").attr("checked")) ? PICKUP : DROPOFF;
//            if (time_type == PICKUP) {
//                $("#time_tools, #time_tools .img").removeClass("arrive").addClass("depart");
//            }
//            else {
//                $("#time_tools, #time_tools .img").removeClass("depart").addClass("arrive");
//            }
//        });

        $("#hotspot_input_helper .next_btn, #address_input_helper .next_btn").click(function(e) {
            e.stopPropagation();

            select_input_resolved = true;
            showMap();

            var address_type = getAddressType(this);
            var $input = getAddressInput(this);
            var $other_input = (getAddressType(this) == PICKUP) ? $("#" + DROPOFF + "_input") : $("#" + PICKUP + "_input");

            $input.addClass("resolved");
            $input.find(".desc").text("");
            $input.find(".resolved_as").text("");

            var $helper = $(this).parents(".tooltip-content");
            var helper_type = $helper.attr("id").split("_")[0]; // what was clicked?
            $("#" + helper_type + "_input_helper").find("input, select").each(function(i, el) {
                $(el).data("saved_val", $(el).val());
            });
            if (helper_type == "hotspot") {
                hotspot_resolved = true;
                hotspot_type = address_type;
                var hotspot_text = $("#id_hotspot_select :selected").text();
                if (hotspot_text.length > HOTSPOT_TEXT_MAX_LENGTH) {
                    hotspot_text = hotspot_text.substr(0,HOTSPOT_TEXT_MAX_LENGTH) + "...";
                }
                $input.find(".text").text(hotspot_text);
                $input.data("resolved_as", "hotspot");
                HotspotHelper.refreshHotspotMarker(hotspot_type);
                openNextTooltip($input, $other_input);
            }
            else { // helper_type == "address"
                var $sa_input = $("#id_street_address"),
                        $hn_input = $("#id_house_number");
                AddressHelper.resolveStructured({
                    city_selector       : "#id_city",
                    street_input        : $sa_input,
                    hn_input            : $hn_input,
                    callbacks           :{
                        beforeSend:function() {
                            $helper.find(".tooltip_loader").show();
                            $sa_input.siblings(".street_error").text("");
                            $hn_input.siblings(".hn_error").text("");
                        },
                        complete:function() {
                            $helper.find(".tooltip_loader").hide();
                        },
                        resolved:function(result) {
                            address_resolved = true;
                            address_lat = result.lat;
                            address_lon = result.lon;
                            address_name = result.name;
                            $input.find(".text").text($sa_input.val() + " " + $hn_input.val() + " " + $("#id_city :selected").text());
                            $input.data("resolved_as", "address");
                            if (address_type == PICKUP){
                                CMHelper.addAMarker(address_lat, address_lon, {title: address_name})
                            }
                            else{
                                CMHelper.addBMarker(address_lat, address_lon, {title: address_name})
                            }
                            openNextTooltip($input, $other_input);
                        },
                        unresolved:function(errors) {
                            address_lat = undefined;
                            address_lon = undefined;
                            if (errors.house_number) {
                                $hn_input.siblings(".hn_error").text(errors.house_number);
                            }
                            if (errors.street) {
                                $sa_input.siblings(".street_error").text(errors.street);
                            }
                        }
                    }
                });
            }
        });

        $("#datetime_input_helper .next_btn").click(function() {
            datetime_resolved = true;
            $("#datetime_input_helper").find("input, select").each(function(i, el) {
                $(el).data("saved_val", $(el).val());
            });

{#            var time_type = ($("#pickup_time").attr("checked")) ? PICKUP : DROPOFF;#}
{#            if (time_type == PICKUP) {#}
{#                $("#datetime_input").removeClass("arrive").addClass("depart");#}
{#                $("#datetime_input .type").text("{% trans "Departure" %}");#}
{#            }#}
{#            else {#}
{#                $("#datetime_input").removeClass("depart").addClass("arrive");#}
{#                $("#datetime_input .type").text("{% trans "Arrival" %}");#}
{#            }#}
            $("#datetime_input").addClass("resolved");
            $("#datetime_input .desc").text("{% trans 'Pickup Time' %} " + $("#id_hotspot_datepicker").val() +
                    " {% trans 'at' %} " + $("#id_hotspot_time").val());

            showRideDetails({});
        });

        /**
         * Validation
         */
        var $address_helper = $("#address_input_helper").data("validator", addressValidator);
        var $datetime_helper = $("#datetime_input_helper").data("validator", datetimeValidator);

        $.each([$address_helper, $datetime_helper], function(i, helper) {
            $(helper).find("input[type=text]").bind("keyup blur", function() {
                $(helper).data("validator").call();
            });
        });
        $datetime_helper.find("input[type=radio], select").bind("change", function() {
            $datetime_helper.data("validator").call();
        });

        $("#id_house_number").keydown(function(e) {
            if (e.keyCode == 13 && addressValidator()) {
                $("#address_input_helper .next_btn").trigger("click");
            }
        });
        // end validation

        $("input[placeholder]").placeHeld();
        $(".order_button").disable();
        $("#save_stamp").hide();

        $("#book_sharing").click(function() {
            bookRide(false);
        });
        $("#book_private").click(function() {
            bookRide(true);
        });

        var colors = [];
        $("#wb_values .header").each(function() {
            colors.push($(this).css("color"));
        });
        $("#banner").css("background", colors[getRandomInt(0, colors.length - 1)]);
        $("#banner_content").show();
        $('#slides').slides({
            width: 800,
            startAtSlide: 0,
            direction: "Up",
            preload: {
                active: true,
                image: "../static/images/wb_site/loading_large.gif"
            },
            play: 5000,
            pause: 2500,
            navigation: false,
            pagination: false
        });

        $("#slides").slides("play");

        $("#feedback").click(function() {
            Registrator.openFeedbackDialog();
        });

        $("#sitemap ul:last").append('<li><a href="#" onclick="Registrator.openPilotInterestDialog()">{% trans "Join the private Beta" %}</a></li>');
    });

    </script>

{% endblock %}