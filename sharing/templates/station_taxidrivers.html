{#uncomment for debugging (open as non-tab page) #}
{#{% extends "base.html" %}#}
{##}
{#{% block bodyclass %}clean_body{% endblock %}#}
{#{% block mainclass %}full_screen_main clean_main{% endblock %}#}
{##}
{#{% block extrastyle %}#}
{#    <link rel="stylesheet" href="/static/css/jquery-ui-1.8.14.smoothness.css" type="text/css" media="all">#}
{#    <link rel="stylesheet" href="/static/css/sharing.css" type="text/css" media="all">#}
{#{% endblock %}#}

{% load i18n %}
{% block content %}
    <div id="header" class="ui-widget-header">

        <div id="taxidriver_buttons">
            {% trans "Show" %}:
            <a id="show_drivers">{% trans "Drivers" %}</a>
            <a id="show_taxis">{% trans "Taxis" %}</a>
        </div>

        <div id="title"></div>

        <div id="add_taxidriver_button">{% trans "New Driver/Taxi" %}</div>
        <div class="clear"></div>
    </div>

    <div class="loader"></div>
    <div id="ride_accordion_container">
        <div id="driver_accordion"></div>
        <div id="taxi_accordion"></div>
    </div>

    <div id="delete_taxidriver_dialog"></div>

    <form id="new_taxidriver_form">
        <div id="driver_form">
            <h3>{% trans "Driver Details" %}:</h3>
            <div class="formgroup">
                <input type="radio" name="driver" id="choose_driver"/>
                <label for="choose_driver">{% trans "Choose Existing" %}</label>
                <select id="select_driver">
                </select>
            </div>
            <div class="formgroup">
                <input type="radio" name="driver" id="new_driver"/>
                <label for="new_driver">{% trans "Add New" %}</label>
                <input type="text" id="new_driver_name" placeholder="{% trans "Name" %}">
                <input type="text" id="new_driver_phone" placeholder="{% trans "Phone number" %}">
            </div>

        </div>

        <div class="clear"></div>
        
        <div id="taxi_form">
            <h3>{% trans "Taxi Details" %}:</h3>
            <div class="formgroup">
                <input type="radio" name="taxi" id="choose_taxi"/>
                <label for="choose_taxi">{% trans "Choose Existing" %}</label>
                <select id="select_taxi">
                </select>
            </div>
            <div class="formgroup">
                <input type="radio" name="taxi" id="new_taxi"/>
                <label for="new_taxi">{% trans "Add New" %}</label>
                <input type="text" id="new_taxi_number" placeholder="{% trans "Taxi number" %}">
            </div>
        </div>
    </form>

{% endblock %}

{% block doc_ready %}
    <script type="text/javascript">
            var accordion_options = {
                collapsible: true,
                autoHeight: false
            };

        deleteElement = function(url, data, success) {
            $.ajax({
                url: url,
                type: "POST",
                data: data,
                success: success,
                error: function() {
                    alert("{% trans "Error" %}");
                }
            });
        };

        deleteTaxiDriverRelation = function(driver_id, taxi_id) {
            $.ajax({
                url: "{% url sharing.station_controller.delete_taxidriver_relation %}",
                type: "POST",
                data: {'driver_id': driver_id, 'taxi_id': taxi_id},
                success: function(response) {
                    renderTaxi(response.taxi);
                    renderDriver(response.driver);
                },
                error: function() {
                    alert("{% trans "Error" %}");
                }
            });
        };

        createTaxiDriverRelation = function(driver_data, taxi_data, callback) {
            var data = {};
            if (driver_data && driver_data.id) { // existing driver
                data.driver_id = driver_data.id;
            }
            else { // create new driver
                if (driver_data && driver_data.name && driver_data.phone) {
                    data.driver_phone = driver_data.phone;
                    data.driver_name = driver_data.name;
                }
            }

            if (taxi_data && taxi_data.id) { // existing taxi
                data.taxi_id = taxi_data.id;
            }
            else { // create new taxi
                if (taxi_data && taxi_data.number) {
                    data.taxi_number = taxi_data.number;
                }
            }

            $.ajax({
                url: "{% url sharing.station_controller.create_taxidriver_relation %}",
                type: "POST",
                data: data,
                success: function(response) {
                    renderTaxi(response.taxi);
                    renderDriver(response.driver);
                    if (callback){
                        callback();
                    }
                },
                error: function() {
                    alert("{% trans "Error" %}");
                }
            });
        };

        renderDriverDiv = function(driver) {
            var $taxis_div = $('<div class="driver_taxis"><div>');
            var $list = $('<ul></ul>').appendTo($taxis_div);
            var $add_taxi_link = $('<span class="action_link add">{% trans "Add Taxi" %}</span>').click(function() {
                showTaxiDriverDialog(driver, undefined);
            });

            var last = driver.taxis.length - 1;
            $.each(driver.taxis, function(i, taxi) {
                var $li = $('<li></li>').append('<span>{% trans "Taxi #" %}' + taxi.number + '</span');
                var $remove = $('<span class="action_link remove">{% trans "Remove" %}</span>').appendTo($li).click(
                        function() {
                            deleteTaxiDriverRelation(driver.id, taxi.id);
                        });
                $list.append($li);
            });
            $taxis_div.append($add_taxi_link);

            var $phone = $('<input type="text" value="' + driver.phone + '"/>').data("orig", driver.phone);
            var $name = $('<input type="text" value="' + driver.name + '"/>').data("orig", driver.name);
            var $save = $('<div>{% trans "Save" %}</div>').button().click(function() {
                $.ajax({
                    url: "{% url sharing.station_controller.change_driver_details %}",
                    type: "POST",
                    data: {'driver_id': driver.id, 'name': $name.val(), 'phone': $phone.val()},
                    success: function(response){
                        $phone.val(response.phone).data("orig", response.phone);
                        $name.val(response.name).data("orig", response.name);
                        alert("{% trans "Changes Saved" %}");
                    },
                    error: function(){
                      alert("{% trans "Error" %}");
                    }
                });
            });
            var $delete = $('<div>{% trans "Delete" %}</div>').button().click(function() {
                $("#delete_taxidriver_dialog").text("{% trans "Are you sure you want to delete driver:" %} " + driver.name + " ?")
                        .dialog({
                            title: "{% trans "Confirm driver deletion" %}",
                            buttons: [
                                {'text': "{% trans "Cancel" %}", 'click': function() {
                                    $(this).dialog("close");
                                }},
                                {'text': "{% trans "Delete" %}", 'click': function() {
                                    deleteElement("{% url sharing.station_controller.delete_driver %}", {'driver_id': driver.id},
                                            function(response) {
                                                $("#driver_header_" + driver.id + ", #driver_div_" + driver.id).remove();
                                                $("#delete_taxidriver_dialog").dialog("close");
                                                alert("{% trans "Driver deleted" %}");
                                            });
                                }}
                            ]
                        }).dialog("open");
            });

            var $driver_details = $('<div class="driver_details"><div>')
                    .append('<label for="">{% trans "Name" %}:</label>', $name, '<label for="">{% trans "Phone" %}:</label>', $phone)
                    .append($('<div class="driver_btns"></div>').append($delete, $save));

            return $('<div class="driver_div"></div>').attr("id", "driver_div_" + driver.id).data("name", driver.name).append($driver_details, $taxis_div);
        };

        renderTaxiDiv = function(taxi) {
            var $taxi_div = $('<div class="taxi_div"></div>').attr("id", "taxi_div_" + taxi.id).data("number", taxi.number);

            var count = taxi.drivers.length;
            if (count == 0) { // no drivers
                $taxi_div.append("<div>{% trans "No Drivers" %}</div>");
            }
            else{
                var $table = $('<table></table>');
                $.each(taxi.drivers, function(i, driver) {
                    var $tr = $('<tr></tr>');
                    var $remove = $('<a href="#" class="action_link remove">{% trans "Remove" %}</a>').click(function() {
                        deleteTaxiDriverRelation(driver.id, taxi.id);
                    });
                    var $driver_name = $('<a class="action_link">' + driver.name + '</a>').click(function() {
                        showDrivers(driver.id);
                    });

                    $tr.append($('<td></td>').append($driver_name))
                            .append('<td>' + driver.phone + '</td>')
                            .append($('<td></td>').append($remove))
                            .appendTo($table);
                });
                $taxi_div.append($table)
            }

            var $add_driver_link = $('<span class="action_link add">{% trans "Add Driver" %}</span>').click(function() {
                showTaxiDriverDialog(undefined, taxi);
            }).appendTo($taxi_div);

            var $delete = $('<div>{% trans "Delete" %}</div>').button().click(function() {
                $("#delete_taxidriver_dialog").text("{% trans "Are you sure you want to delete taxi:" %} " + taxi.number + " ?")
                        .dialog({
                            title: "{% trans "Confirm taxi deletion" %}",
                            buttons: [
                                {'text': "{% trans "Cancel" %}", 'click': function() {
                                    $(this).dialog("close");
                                }},
                                {'text': "{% trans "Delete" %}", 'click': function() {
                                    deleteElement("{% url sharing.station_controller.delete_taxi %}", {'taxi_id': taxi.id},
                                            function(response) {
                                                $("#taxi_header_" + taxi.id + ", #taxi_div_" + taxi.id).remove();
                                                $("#delete_taxidriver_dialog").dialog("close");
                                                alert("{% trans "Taxi deleted" %}");
                                            });
                                }}
                            ]
                        }).dialog("open");
            }).appendTo($taxi_div);

            return $taxi_div;
        };

        renderDriver = function(driver) {
            $("#driver_div_" + driver.id + ", #driver_header_" + driver.id).remove();

            var $driver_header = $('<h3 class="driver_header"></h3>').attr("id", "driver_header_" + driver.id)
                    .append('<span class="driver_name">' + driver.name + '</span>');

            var $driver_div = renderDriverDiv(driver);
            var append_after = getAccordionPosition($("[id^='driver_div_']"), "name", driver.name);
            renderElement("driver", $driver_header, $driver_div, append_after);
        };

        renderTaxi = function(taxi) {
            $("#taxi_div_" + taxi.id + ", #taxi_header_" + taxi.id).remove();

            var $taxi_header = $('<h3 class="taxi_header"></h3>').attr("id", "taxi_header_" + taxi.id)
                    .append('<span class="taxi_number">{% trans "Taxi #" %} ' + taxi.number + '</span>');

            var $taxi_div = renderTaxiDiv(taxi);

            var append_after = getAccordionPosition($("[id^='taxi_div_']"), "number", taxi.number);
            renderElement("taxi", $taxi_header, $taxi_div, append_after);
        };

        renderElement = function(type, $header, $div, append_after){
            if (append_after) {
                $(append_after).after($header, $div);
            }
            else{
                $("#" + type + "_accordion").prepend($header, $div);
            }
            refreshAccordions();
        };

        showTaxiDriverDialog = function(driver, taxi){
            var dialog_title = '{% trans "New Driver/Taxi" %}';
            $("#driver_form, #taxi_form").show();
            $("#select_driver, #select_taxi").empty();
            if (driver){ // add taxi to driver
                $("#choose_driver, #choose_taxi").click().blur();
                dialog_title = '{% trans "Assign Taxi to Driver" %} ' + driver.name;
                $("#select_driver").append('<option value="' + driver.id + '">' + driver.name + '</option>').val(driver.id).disable(); // confine driver
                $.each(driver.available_taxis, function(i, taxi) {
                    $("#select_taxi").append('<option value="' + taxi.id + '">' + taxi.number + '</option>');
                });
                $("#driver_form").hide();
            }
            else{
                if (taxi){ // add driver to taxi
                    $("#choose_driver, #choose_taxi").click().blur();
                    dialog_title = '{% trans "Assign Driver to Taxi" %} #' + taxi.number;
                    $("#select_taxi").append('<option value="' + taxi.id + '">' + taxi.number + '</option>').val(taxi.id).disable(); // confine taxi
                    $.each(taxi.available_drivers, function(i, driver) {
                        $("#select_driver").append('<option value="' + driver.id + '">' + driver.name + '</option>');
                    });
                    $("#taxi_form").hide();
                }
                else{ // add new driver and taxi
                    $("#new_driver, #new_taxi").click().blur();
                    $("#select_driver, #select_taxi").append('<option value="" disabled="disabled">{% trans "Updating..." %}</option>'); // reset taxi, driver
                    $.ajax({
                        url: "{% url sharing.station_controller.station_taxidrivers %}",
                        type: "GET",
                        data: {"get_taxidrivers": true},
                        dataType: 'json',
                        success: function(response){
                            $("#select_driver, #select_taxi").empty();
                            $.each(response.drivers_data, function(i, driver) {
                        $("#select_driver").append('<option value="' + driver.id + '">' + driver.name + '</option>');
                    });
                            $.each(response.taxis_data, function(i, taxi) {
                        $("#select_taxi").append('<option value="' + taxi.id + '">' + taxi.number + '</option>');
                    });
                }
                    });

            }
        }
            
            $("#new_taxidriver_form").dialog({'title': dialog_title}).dialog("open");
        };

        validateTaxiDriverDialog = function(){
            $(".save_btn").button("disable");
            var driver_valid = Boolean($("#choose_driver").attr("checked") && $("#select_driver").val()) || Boolean($("#new_driver").attr("checked") && $("#new_driver_name").val() && $("#new_driver_phone").val());
            var taxi_valid = Boolean($("#choose_taxi").attr("checked") && $("#select_taxi").val()) || Boolean($("#new_taxi").attr("checked") && $("#new_taxi_number").val());

            var is_valid = Boolean(driver_valid && taxi_valid);
            if (is_valid) {
                $(".save_btn").button("enable");
            }
            return is_valid;
        };

        initDialogs = function(){
            var dialog_options = {
                autoOpen: false,
                modal: true,
                width: 600,
                resizable: false,
            };

            $("#delete_taxidriver_dialog").dialog(dialog_options);

            asFormGroupSelector("#new_driver", "#new_driver_phone, #new_driver_name", "#select_driver");
            asFormGroupSelector("#choose_driver", "#select_driver", "#new_driver_phone, #new_driver_name");
            asFormGroupSelector("#new_taxi", "#new_taxi_number", "#select_taxi");
            asFormGroupSelector("#choose_taxi", "#select_taxi", "#new_taxi_number");

            $("#new_taxidriver_form").dialog($.extend({}, dialog_options, {
                open: function(event, ui){
                    validateTaxiDriverDialog();
                },
                buttons: [
                    {'text': "{% trans "Cancel" %}", 'click': function() {
                        $(this).dialog("close");
                    }},
                    {'text': "{% trans "Save" %}", 'class': "save_btn" ,'click': function() {
                        if (validateTaxiDriverDialog()) {
                            var driver_data = ($("#choose_driver").attr("checked")) ? {'id': $("#select_driver").val()} : {'name': $("#new_driver_name").val(), 'phone': $("#new_driver_phone").val()};
                            var taxi_data = ($("#choose_taxi").attr("checked")) ? {'id': $("#select_taxi").val()} : {'number': $("#new_taxi_number").val()};
                            createTaxiDriverRelation(driver_data, taxi_data, function() {
                                $("#new_taxidriver_form").dialog("close");
                            })
                        }
                        else {
                            alert("{% trans "Invalid driver/taxi" %}");
                        }
                    }}
                ]
            }));

            $("#new_taxidriver_form input, #new_taxidriver_form select").change(function() {
                validateTaxiDriverDialog();
            });
            $("#new_taxidriver_form input").keydown(function() {
                validateTaxiDriverDialog();
            });
        };

        asFormGroupSelector = function(radio_selector, enabled_selector, disabled_selector){
            $(radio_selector).change(function() {
                if ($(this).attr("checked")) {
                    $(enabled_selector).enable();
                    $(disabled_selector).val("").disable();
                }
            });
        };

        showDrivers = function(driver_id){
            $("#driver_accordion").empty();
            $("#title").text("{% trans "Drivers List" %}");
            $.ajax({
                url: "{% url sharing.station_controller.station_taxidrivers %}",
                type: "GET",
                data: {"get_drivers": true},
                dataType: 'json',
                success: function(response) {
                    $.each(response.drivers_data, function(i, driver) {
                        renderDriver(driver);
                    });
                }
            });
            toggleMode("taxi", "driver", driver_id);
        };

        showTaxis = function(taxi_id){
            $("#taxi_accordion").empty();
            $("#title").text("{% trans "Taxi List" %}");
            $.ajax({
                url: "{% url sharing.station_controller.station_taxidrivers %}",
                type: "GET",
                data: {"get_taxis": true},
                dataType: 'json',
                success: function(response) {
                    $.each(response.taxis_data, function(i, taxi) {
                        renderTaxi(taxi);
                    });
                }
            });
            toggleMode("driver", "taxi", taxi_id);
        };

        toggleMode = function (old_mode, new_mode, active_id) {
            $("#" + old_mode + "_accordion").hide();
            $("#show_" + old_mode + "s").button("enable").removeClass("active");
            $("#show_" + new_mode + "s").button("disable").addClass("active");
            $("#" + new_mode + "_accordion").show();
            if (active_id) {
                $("#" + new_mode + "_accordion").accordion( "option", "animated", false);
                $("#" + new_mode + "_accordion").accordion( "option", "active", false);
                $("#" + new_mode + "_accordion").accordion( "option", "animated", 'slide');
                $("#" + new_mode + "_accordion").accordion( "option", "active", "#" + new_mode + "_header_" + active_id);
            }
        };

        refreshAccordions = function(){
            var active_taxi = $("#taxi_accordion").accordion( "option", "active" );
            var active_driver = $("#driver_accordion").accordion( "option", "active" );
            var opt = $.extend({}, accordion_options, { active: active_taxi });
            $("#taxi_accordion").accordion("destroy").accordion(opt);
            opt = $.extend({}, accordion_options, { active: active_driver });
            $("#driver_accordion").accordion("destroy").accordion(opt);
        };

        $(function() {
            $(".loader").hide();

            initDialogs();

            $("#add_taxidriver_button").button().click(function() {
                showTaxiDriverDialog();
            });

            $("#driver_accordion").bind('accordionchangestart', function(event, ui) {
                ui.oldContent.find("input").each(function(i, input) {
                    $(input).val($(input).data("orig"));
                });
            });

            $("#show_drivers").button().click(function() {
                showDrivers();
            });
            $("#show_taxis").button().click(function() {
                showTaxis();
            });

            showDrivers();
        });
    </script>
{% endblock %}
