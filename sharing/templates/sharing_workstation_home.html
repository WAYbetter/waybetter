{% extends "connected_page.html" %}
{% load i18n %}

{% block bodyclass %}clean_body{% endblock %}
{% block mainclass %}clean_main{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" href="/static/css/jquery-ui-1.8.14.smoothness.css" type="text/css" media="all">
    <style>
        .ui-accordion-icons .ui-accordion-header a {
            display: inline-block;
            /*padding-left: 0;*/
        }

        .ui-accordion-icons .ui-accordion-header :nth-child(2) {
            padding-left: 2.2em;
        }
    </style>

{% endblock %}

{% block content %}

    <div id="rides_accordion"></div>

{% endblock %}

{% block doc_ready %}
    <script type="text/javascript" src="/_ah/channel/jsapi"></script>
    <script type="text/javascript">
        {% autoescape off %}
            var rides_data = {{ rides_data }};
            var drivers_data = {{ drivers_data }};
            var taxis_data = {{ taxis_data }};
            var init_token = "{{ token }}";
            var channel_opened = false;
            var channel;
            var socket;
        {% endautoescape %}

        setupChannel = function(token) {
            $("#wcs-iframe").remove();

            channel = new goog.appengine.Channel(token);
            socket = channel.open();
            socket.onerror = function() {
                trace("socket: onerror");
                onError();
            };
            socket.onclose = function() {
                trace("socket: onclose");
                onError()
            };
            socket.onopen = function() {
                trace("socket: onopen");
                channel_opened = true;
            };
            socket.onmessage = function(msg) {
                try {
                    var data = $.parseJSON(msg.data);
                    renderRide(data);
                    $.ajax({
                        url: "{% url ordering.station_controller.message_received %}",
                        type: "POST",
                        data: {data: msg.data}
                    });
                } catch (e) {
                    trace("error parsing: " + JSON.stringify(e))
                }

            };

            $(document).oneTime("10s", function() {
                if (! channel_opened) {
                    trace("Channel did not open correctly");
                    onError()
                }
            })
        };

        renderTableRow = function(point) {
            return $("<tr><td>" + point.num_passengers + "</td><td>" + point.address + "</td><td>" + point.time + "</td></tr>")
        };

        renderPickupTable = function(ride) {
            var $table = $('<table class="pickup_table"><tr><th>{% trans '# passengers' %}</th><th>{% trans 'Address' %}</th><th>{% trans 'Time' %}</th></tr></table>')
                    .attr("id", "pickup_table_" + ride.id);
            $.each(ride.pickups, function(i, p) {
                $table.append(renderTableRow(p));
            });
            return $table.prepend("{% trans 'From' %}");
        };

        renderDropoffTable = function(ride) {
            var $table = $('<table class="dropoff_table"><tr><th>{% trans '# passengers' %}</th><th>{% trans 'Address' %}</th><th>{% trans 'Time' %}</th></tr></table>')
                    .attr("id", "dropoff_table_" + ride.id);
            $.each(ride.dropoffs, function(i, d) {
                $table.append(renderTableRow(d));
            });
            return $table.prepend("{% trans 'To' %}");
        };

        renderMatcher = function(ride) {
            var $driver_label = '<label for="driver_sel_' + ride.id + '"> {% trans 'Select Driver' %}' + '</label>';
            var $driver_selector = $('<select class="driver_selector"></select>').attr("id", "driver_sel_" + ride.id);
            $.each(drivers_data, function(i, driver) {
                $driver_selector.append('<option value="' + driver.id + '">' + driver.name + '</option>');
            });

            var $taxi_label = '<label for="taxi_sel_' + ride.id + '"> {% trans 'Select Taxi' %}' + '</label>';
            var $taxi_selector = $('<select class="taxi_selector"></select>').attr("id", "taxi_sel_" + ride.id);
            $.each(taxis_data, function(i, taxi) {
                $taxi_selector.append('<option value="' + taxi.id + '">' + taxi.number + '</option>');
            });

            var $accept_button = $("<div>{% trans 'Accept Ride' %}</div>").attr("id", "match_ride_" + ride.id).button()
                    .click(function() {
                        $.ajax({
                            url: '{% url sharing.views.accept_ride %}',
                            type: 'POST',
                            data: { 'ride_id': ride.id,
                                'taxi_id': $taxi_selector.val(),
                                'driver_id': $driver_selector.val() },
                            success: function() {
                                acceptRide(ride);
                                console.log("success");
                            },
                            error: function() {
                                console.log("error");
                            }
                        });
                    });
            return $('<div class="ride_matcher" id="matcher_' + ride.id + '"></div>')
                    .append($driver_label, $driver_selector, $taxi_label, $taxi_selector, $accept_button);
        };


        renderRide = function(ride) {
            var $ride_header = $('<h3 class="ride_header"></h3>').attr("id", "ride_header_" + ride.id)
                    .append('<span>img</span>')
                    .append('<a>' + ride.pickups[0].address + ' (' + ride.depart_time + '</a>')
                    .append('<span>' + ride.status + '</span>');

            var $ride_div = $("<div></div>").attr("id", "ride_div_" + ride.id).attr("ride_time", ride.depart_time);

            $ride_div.append(renderPickupTable(ride), renderDropoffTable(ride), "<hr/>", renderMatcher(ride));

            var append_after = getRenderPosition(ride);
            if (append_after) {
                $(append_after).after($ride_header, $ride_div);
            }
            else { // put it first
                $("#rides_accordion").prepend($ride_header, $ride_div);
            }
            $("#rides_accordion").accordion("destroy").accordion();
        };

        getRenderPosition = function(ride) {
            // returns the ride_div after which to append the new ride_header and ride_div, or
            // undefined if no such ride_div exists (i.e., the new ride should be first).
            // assumes existing rides in the page are ordered by ride time.

            var time = getRideTime(ride);
            var append_after = undefined;

            $("[id^='ride_div_']").each(function(i, ride_div) {
                var div_time = getRideTime(undefined, ride_div);
                if (div_time <= time) {
                    append_after = this;
                }
                else {
                    return false; // break
                }
            });

//            var msg = (append_after) ? "after:" + $(append_after).attr("ride_time") : "first";
//            console.log(msg);

            return append_after;
        };

        getRideTime = function(ride, ride_div) {
            var hours, minutes;
            if (ride) {
                hours = ride.depart_time.split(":")[0];
                minutes = ride.depart_time.split(":")[1];
            }
            else { // ride_div element
                hours = $(ride_div).attr("ride_time").split(":")[0];
                minutes = $(ride_div).attr("ride_time").split(":")[1];
            }
            var time = new Date();
            time.setHours(hours);
            time.setMinutes(minutes);
            time.setSeconds(0);
            time.setMilliseconds(0);
            return time;
        };

        acceptRide = function(ride){
            $("#ride_header_" + ride.id).addClass("accepted");
        };

        trace = function(str) {
            var msg = new Date().toISOString() + ": " + str;
            if (window.parentSandboxBridge) {
                parentSandboxBridge.trace(msg);
            }
            if (window.console) {
                console.log(msg)
            }
        };

        $(function() {
            $.each(rides_data, function(i, ride) {
                renderRide(ride);
            });

            setupChannel(init_token);
        });
    </script>
{% endblock %}
