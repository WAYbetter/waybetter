{% extends "base.html" %}
{% load i18n %}

{% block bodyclass %}clean_body{% endblock %}
{% block mainclass %}full_screen_main clean_main{% endblock %}

{% block extrastyle %}
    <link rel="stylesheet" href="/static/css/jquery-ui-1.8.14.smoothness.css" type="text/css" media="all">
    <link rel="stylesheet" href="/static/css/sharing.css" type="text/css" media="all">
{% endblock %}

{% block content %}
    <div id="header" class="ui-widget-header">
        <div id="options_button" class="toolbar_button"></div>
        <div id="expand_collapse_button" class="toolbar_button">{% trans "Hide List" %}</div>
        <div id="summary">
            <span id="untaken_counter" class="untaken_count"></span> <span
                class="untaken_count"> {% trans "Pending" %}</span>
            |
            <span id="taken_counter" class="taken_count"></span> <span
                class="taken_count"> {% trans "Ready to go" %}</span>
        </div>
        <div id="tools_button" class="toolbar_button">{% trans "Station Account" %}</div>
        <div class="clear"></div>
    </div>
    <div id="ride_accordion_container">
        <div id="ride_accordion"></div>
    </div>
    <div id="footer" class="ui-widget-header">
        <div id="online_status" class="offline">{% trans 'Connecting' %}</div>
        <div id="station_name">{{ work_station.station.name }}</div>

    </div>
    <div id="option_menu">
        <ul>
            <li id="snap_right_action">{% trans "Snap to right corner" %}</li>
            <li id="snap_left_action">{% trans "Snap to left corner" %}</li>
        </ul>
    </div>

{% endblock %}

{% block doc_ready %}
    <script type="text/javascript" src="/_ah/channel/jsapi"></script>
    <script type="text/javascript" src="/static/js/mylibs/jquery.countdown.min.js"></script>

    <script type="text/javascript">
    var not_assigned_msg = "{% trans "Not Assigned Yet" %}";
    var missed_msg = "{% trans "Missed" %}";
    var minimize_label = "{% trans 'Hide List' %}";
    var maximize_label = "{% trans 'Show List' %}";
    var online_label = "{% trans 'Online Status: OK' %}";
    var offline_label = "{% trans 'Online Status: ERROR' %}";
    var is_minimized = false;
    var minimize_nag_interval = 30; // seconds
    var taken = 0;
    var untaken = 0;

    {% autoescape off %}
        var rides_data = {{ rides_data }};
        var taxi_driver_data = {{ taxis_data }};
        var init_token = "{{ token }}";
        var channel_opened = false;
        var channel;
        var socket;
    {% endautoescape %}

    onError = function (XMLHttpRequest, textStatus, errorThrown) {
        is_in_error = true;
        if (XMLHttpRequest) {
            last_error_text = XMLHttpRequest.responseText;
        } else {
           last_error_text = "{% trans 'No connection to server' %}";
        }
        if (window.parentSandboxBridge) {
            if (! window.parentSandboxBridge.is_error()) { // already in error state
                //TODO: fix this on the air side as well - make sure only one instance of the refresh task is running
                parentSandboxBridge.set_error_state(false);
                parentSandboxBridge.refresh();
                parentSandboxBridge.set_error_state(true);
            }
        }
    };

    setupChannel = function(token) {
        $("#wcs-iframe").remove();

        channel = new goog.appengine.Channel(token);
        socket = channel.open();
        socket.onerror = function() {
            set_online(false);
            trace("socket: onerror");
            onError();
        };
        socket.onclose = function() {
            set_online(false);
            trace("socket: onclose");
            onError()
        };
        socket.onopen = function() {
            set_online(true);
            trace("socket: onopen");
            channel_opened = true;
            air("set_error_state", false);
        };
        socket.onmessage = function(msg) {
            try {
                var ride = $.parseJSON(msg.data);
                if ($("#ride_header_" + ride.id + ", #ride_div_" + ride.id).length < 2) { // render if ride is new or rendered incorrectly
                    $("#ride_header_" + ride.id + ", #ride_div_" + ride.id).remove();
                    renderRide(ride);
                }
                $.ajax({
                    url: "{% url ordering.station_controller.message_received %}",
                    type: "POST",
                    data: {msg_data: msg.data}
                });
            } catch (e) {
                trace("error parsing: " + JSON.stringify(e))
            }

        };

        $(document).oneTime("10s", function() {
            if (! channel_opened) {
                trace("Channel did not open correctly");
                onError();
            }
        })
    };

    set_online = function(online) {
        var $online_status = $("#online_status");
        if (online) {
            $online_status.addClass("online").removeClass("offline");
            $online_status.text(online_label);
        } else {
            $online_status.addClass("offline").removeClass("online");
            $online_status.text(offline_label);
        }
    };

    populateDrivers = function($driver_select, $taxi_selector, taxi_id) {
        var prev_val = $driver_select.val();
        $driver_select.empty().disable();
        var taxi = $.grep(taxi_driver_data, function(e) {
            return e.id == taxi_id;
        })[0];
        if (taxi) {
            $.each(taxi.drivers, function(i, driver) {
                var opt = $('<option value="' + driver.id + '">' + driver.name + '</option>').appendTo($driver_select);
                if (driver.id == prev_val) {
                    $driver_select.val(prev_val);
                }
            });

            if (taxi.drivers.length > 1 && ! $taxi_selector.is(":disabled")) {
                $driver_select.enable();
            }
        }
    };

    populateTaxis = function() {

        $(".taxi_selector").each(function(i, selector) {
            $(this).empty();
            $.each(taxi_driver_data, function(i, taxi) {
                $(selector).append('<option value="' + taxi.id + '">' + taxi.number + '</option>');
            });
            $(this).val($(this).data("orig_val"));
            if ($(this).data("is_enabled")) {
                $(this).enable();
            }
            $(this).change(); // trigger populateDrivers
        });
    };

    getTaxiDriverData = function(populate) {
        if (populate) {
            $(".taxi_selector").each(function(i, e) {
                $(this).data("orig_val", $(this).val());
                $(this).data("is_enabled", $(this).is(":enabled"));
            });
            $(".taxi_selector").empty().disable().append('<option>' + "{% trans "Updating..." %}" + '</option>');
        }
        try {
            $.ajax({
                url: "{% url sharing.station_controller.station_taxidrivers %}",
                type: "GET",
                data: {"get_taxis": true},
                dataType: 'json',
                success: function(response) {
                    try {
                        taxi_driver_data = response.taxis_data;
                        if (populate) {
                            populateTaxis();
                        }
                    } catch (e) {
                        trace(e);
                        onError();
                    }
                }
            });
        } catch (e) {
            trace(e);
            onError();
        }

    };

    renderTable = function(ride) {
        var $table = $('<table><thead><tr><th>{% trans 'Time' %}</th><th>{% trans 'Address' %}</th><th>{% trans '# of Passengers' %}</th></tr></thead></table>');

        $table.append("<tr class='spacer'><td colspan=3></td></tr>"); // spacer
        $table.append("<tr class='spacer'><td colspan=3 class='table_header'>{% trans 'Pickups' %}</td></tr>"); // spacer

        $.each(ride.pickups, function(i, p) {
            var $row = $("<tr class='dropoff'><td>" + p.time + "</td><td>" + p.address + "</td><td>" + p.num_passengers + " (" + p.passenger_phones.join() + ")</td></tr>");
            $table.append($row);
        });

        $table.append("<tr class='spacer'><td colspan=3></td></tr>"); // spacer
        $table.append("<tr class='spacer'><td colspan=3 class='table_header'>{% trans 'Dropoffs' %}</td></tr>"); // spacer

        $.each(ride.dropoffs, function(i, p) {
            var $row = $("<tr class='dropoff'><td>" + p.time + "</td><td>" + p.address + "</td><td>" + p.num_passengers + "</td></tr>");
            $table.append($row);
        });


        return $table;
    };

    renderInfo = function(ride) {
        var link = "{% url sharing.station_controller.show_ride %}" + ride.id;
        var $map_link = $('<a class="map_link" href="#" target="_blank">{% trans "Show Points On Map" %}</a>')
                .click(function(e) {
                    e.preventDefault();
                    window.open(link, "Map View", 'width=800,height=600,resizable=no');
                });

        var $copy_link = $('<a class="map_link copy_link" href="#">{% trans "Copy" %}</a>').click(function() {
            if (air("copy", ride.driver_jist)) {
                flashMessage("{% trans "Ride Copied" %}");
            } else {
                flashError("{% trans "Failed Copying" %}");
            }
            return false;
        });

        var $value = $('<span class="ride_value">{% trans "Value" %}:' + ride.value + ' â‚ª</span>');

        return $('<div class="ride_info"></div>').append($value, $map_link, $copy_link, '<div class="clear"></div>');
    };

    renderMatcher = function(ride) {
        var $driver_label = '<label for="driver_sel_' + ride.id + '"> {% trans 'Driver' %}' + '</label>';
        var $driver_selector = $('<select class="driver_selector"></select>').attr("id", "driver_sel_" + ride.id);

        var $taxi_label = '<label for="taxi_sel_' + ride.id + '"> {% trans 'Taxi No.' %}' + '</label>';
        var $taxi_selector = $('<select class="taxi_selector"></select>').attr("id", "taxi_sel_" + ride.id);

        if (ride.taxi && ride.driver) { // accepted ride
            $taxi_selector.append('<option value="' + ride.taxi.id + '">' + ride.taxi.number + '</option>').disable();
            $driver_selector.append('<option value="' + ride.driver.id + '">' + ride.driver.name + '</option>').disable();
        }
        else {
            $taxi_selector.change(function() {
                populateDrivers($driver_selector, $taxi_selector, $(this).val());
            });
        }

        var $add_driver = $('<a class="add_driver">{% trans "+ Add" %}</a>');
        var $matcher_label = $("<div class='matcher_label'>{% trans "Assign Ride" %}:</div>");
        var $selectors = $('<div class="select_tools"></div>')
                .append($taxi_label, $taxi_selector, $driver_label, $driver_selector);

        var $accept_button = $('<div class="accept_button">{% trans 'Finish' %}</div>').attr("id", "accept_ride_" + ride.id).button()
                .click(function() {
                    var that = this;
                    if ($taxi_selector.val() && $driver_selector.val()) {
                        $.ajax({
                            url: '{% url sharing.station_controller.accept_ride %}',
                            type: 'POST',
                            dataType: "json",
                            data: { 'ride_id': ride.id,
                                'taxi_id': $taxi_selector.val(),
                                'driver_id': $driver_selector.val() },
                            beforeSend: function() {
                                $(that).button("disable");
                            },
                            success: function(response) {
                                try {
                                    acceptRide(response.ride);
                                } catch (e) {
                                    trace(e);
                                    onError();
                                }
                            },
                            error: function(response) {
                                trace(response);
                                alert(response.responseText);
                                $(that).button("enable");
                            }
                        });
                    }
                    else {
                        alert("{% trans "Please choose taxi and driver" %}");
                    }
                });
        return $('<div class="ride_matcher" id="matcher_' + ride.id + '"></div>')
                .append($matcher_label, $accept_button, $selectors, '<div class="clear"></div>');
    };


    renderRide = function(ride) {
        updateCounters({{ assigned }});
        ride.depart_time = new Date(ride.depart_time);
        var $ride_header = $('<h3 class="ride_header"></h3>').attr("id", "ride_header_" + ride.id)
                .append('<span class="date">' + getFullDate(ride.depart_time) + '</span>')
                .append('<span class="seperator"> - </span>')
                .append('<span class="pickup">' + ride.pickups[0].address + '</span>')
                .append('<span class="status not_assigned">' + not_assigned_msg + '</span>')

                .data("status", ride.status);

        // if ride is today, show exact time
        if (ride.depart_time.getDate() == (new Date()).getDate()) {
            $ride_header.find(".date").html('{% trans "Today" %}, ' + getFullTime(ride.depart_time));
        }

        var $ride_div = $('<div class="ride_div"></div>').attr("id", "ride_div_" + ride.id).data("ride_time", ride.depart_time);
        $ride_div.append(renderTable(ride), renderInfo(ride), renderMatcher(ride));

        if (ride.debug) {
            var $close_btn = $('<span href="#" class="action_link"></span>').text('x').click(function(e) {
                var that = this;
                $.ajax({
                    url: '{% url sharing.station_controller.complete_ride %}',
                    type: 'POST',
                    data: { 'ride_id': ride.id, 'force': 1 },
                    beforeSend: function() {
                        $(that).button("disable");
                    },
                    success: function() {
                        $ride_header.remove();
                        $ride_div.remove();
                        updateCounters({{ accepted }});
                        updateCounters({{ completed }});
                    },
                    error: function() {
                        $(that).button("enable");
                        alert("error closing");
                    }
                });
                return false; // prevent the accordion opening
            });
            $ride_header.prepend($close_btn);
        }

        // re-create the accordion and open it where it was opened
        var $accordion = $("#ride_accordion");
        var $active_header = $("[id^=ride_header_]")[$accordion.accordion("option", "active")];
        var append_after = getRenderPosition(ride);
        if (append_after) {
            $(append_after).after($ride_header, $ride_div);
        }
        else { // put it first
            $accordion.prepend($ride_header, $ride_div);
        }

        $accordion.accordion("destroy").accordion({ active: $("[id^=ride_header_]").index($active_header) });
        // install timer
        $("#ride_header_" + ride.id).oneTime(Math.max(ride.depart_time - new Date(), 0), function() {
            if ($(this).data("status") == {{ assigned }}) {
                timeoutRide(ride);
            }
        });

        populateTaxis();
    };

    getRenderPosition = function(ride) {
        // returns the ride_div after which to append the new ride_header and ride_div, or
        // undefined if no such ride_div exists (i.e., the new ride should be first).
        // assumes existing rides in the page are ordered by ride time.

        var append_after = undefined;

        $("[id^='ride_div_']").each(function(i, ride_div) {
            if ($(this).data("ride_time") <= ride.depart_time) {
                append_after = this;
            }
            else {
                return false; // break
            }
        });
        return append_after;
    };

    timeoutRide = function(ride) {
        var $rh = $("#ride_header_" + ride.id);
        $rh.data("status", {{ timed_out }}).addClass("timed_out");
        $rh.find(".status").empty().text(missed_msg);

        var $rd = $("#ride_div_" + ride.id);
        $rd.find("select").attr("disabled", "");
        $rd.find(".accept_button").button("disable");
        // ajax to server?
    };

    acceptRide = function(ride) {
        var $rh = $("#ride_header_" + ride.id);
        $rh.data("status", {{ accepted }}).addClass("accepted");
        $rh.find(".pickup").after('<span class="seperator"> - </span>',
                '<span class="taxi"> {% trans 'Taxi No.' %}' + ride.taxi.number + ' </span>');

        var $rd = $("#ride_div_" + ride.id);
        $rd.find("select").disable();
        $rd.find(".accept_button").button("disable");

        var $complete_ride = $('<span href="#" class="action_link"></span>').text("{% trans 'Ride Started' %}").click(function(e) {
            var that = this;
            $.ajax({
                url: '{% url sharing.station_controller.complete_ride %}',
                type: 'POST',
                data: { 'ride_id': ride.id },
                beforeSend: function() {
                    $(that).button("disable");
                },
                success: function() {
                    $rh.remove();
                    $rd.remove();
                },
                error: function() {
                    $(that).button("enable");
                    alert("error marking ride as finished");
                }
            });
            return false; // prevent the accordion opening
        });

        ride.depart_time = new Date(ride.depart_time);
        if (ride.depart_time > new Date()) { // future order, show countdown
            var $countdown = $('<span></span>').countdown(
                    { compact: true, format: 'MS', until: ride.depart_time,
                        onExpiry:function() {
                            $rh.find(".status").empty().append($complete_ride);
                        }
                    });
            $rh.find(".status").empty().removeClass("not_assigned").append("{% trans 'Ride in'%} ", $countdown, " {% trans 'min' %}");
        }
        else {
            $rh.find(".status").empty().append($complete_ride);
        }

        updateCounters({{ accepted }});

    };

    updateCounters = function(status) {
        taken = parseInt($("#taken_counter").text(), 10);
        untaken = parseInt($("#untaken_counter").text(), 10);

        switch (status) {
            case {{ assigned }}:
                $("#untaken_counter").text(++untaken);
                break;
            case {{ accepted }}:
                $("#taken_counter").text(++taken);
                $("#untaken_counter").text(--untaken);
                break;
            case {{ completed }}:
                $("#taken_counter").text(--taken);

        }
        if (taken + untaken > 0) {
            maximize();
            $("#expand_collapse_button").enable()
        } else {
            minimize();
            $("#expand_collapse_button").disable()
        }
    };

    trace = function(str) {
        air("trace", str);
        if (window.console) {
            console.log(str)
        }
    };

    maximize = function() {
        air("maximize");
        $("#expand_collapse_button").button("option", "label", minimize_label).removeClass("not_taken");
        $("#ride_accordion_container").add("#summary").show();
        is_minimized = false;
    };
    minimize = function() {
        air("minimize");
        $("#expand_collapse_button").button("option", "label", maximize_label);
        if (taken + untaken > 0) {
            $("#expand_collapse_button").addClass("not_taken");
            $(document).stopTime("minimize_nag");
            $(document).oneTime(minimize_nag_interval * 1000, "minimize_nag", function() {
                maximize();
            });
        }
        $("#ride_accordion_container").add("#summary").hide();
        is_minimized = true;


    };
    toggleExpandCollapse = function() {
        if (is_minimized) {
            maximize();
        } else {
            minimize();
        }
    };
    init = function() {
        $("#tools_button").button().click(function(e) {
            var win = window.open("{% url sharing.station_controller.station_tools %}", "station_tools", "width=800,height=600,resizable=0,scrollbars=1");
            var x, y;
            y = window.screenTop;
            if (window.screenLeft > 0) { // module is snapped to right
                x = window.screenLeft - 800 - 10;
            } else {
                x = $(window).width() + 10;
            }
            win.moveTo(x, y);

        });
        $("#options_button").button({
            icons: {
                primary: "ui-icon-gear"
            },
            text: false
        }).click(function() {
            var $menu = $("#option_menu");
            if ($menu.is(":visible")) {
                $menu.fadeOut("fast");
            } else {
                var pos = $(this).offset();
                var width = $(this).width();
                //show the menu directly over the placeholder

                $menu.css({ "left": (pos.left + width + 5) + "px", "top":pos.top + "px" });
                $menu.fadeIn("fast");
            }
        });

        $("#option_menu li").click(function() {
            $("#option_menu").fadeOut("fast")
        });

        $("#snap_left_action").click(function() {
            air("snap_left");
            if (!is_minimized) {
                air("maximize");
            }
        });
        $("#snap_right_action").click(function() {
            air("snap_right");
            if (!is_minimized) {
                air("maximize");
            }
        });

        $("#expand_collapse_button").text(minimize_label).button().click(toggleExpandCollapse);

        $("#untaken_counter, #taken_counter").text(0);

        $.each(rides_data, function(i, ride) {
            renderRide(ride);

            if (ride.status == {{ accepted }}) {
                acceptRide(ride);
            }
            if (ride.status == {{ timed_out }}) {
                timeoutRide(ride);
            }
        });

        updateCounters();
        air("set_visible", true);
        setupChannel(init_token);
    };

    $(function() {
        try {
            init();
        } catch (e) {
            trace(e);
            onError();
        }
    });
    </script>
{% endblock %}
