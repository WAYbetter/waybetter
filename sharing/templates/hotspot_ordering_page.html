{% extends "base_passenger.html" %}
{% load i18n %}

{% block bodyclass %}clean_body{% endblock %}
{% block mainclass %}clean_main full_screen_main{% endblock %}

{% block extrastyle %}
    <link rel="stylesheet" href="/static/css/jquery-ui-1.8.14.smoothness.css" type="text/css" media="all">
    <link rel="stylesheet" href="/static/css/sharing.css" type="text/css" media="all">
{% endblock %}


{% block content %}
    <div id="map_container">
        <div id="map"></div>
    </div>

    <form id="order_form" method="post" action="{% url hotspot_select %}">
        {% csrf_token %}
        {% for field in hidden_fields %}
            <input type="hidden" id="id_p1_{{ field }}" name="p1_{{ field }}"/>
        {% endfor %}
        <input type="hidden" id="id_geocoded_p1_raw" name="geocoded_p1_raw"/>

        <ul>
            <span id="from">{% trans 'From' %}</span>
            <li id="hotspot">
                <select id="id_hotspot_select" name="hotspot_id">
                    {% for hotspot in hotspots %}
                        <option value="{{ hotspot.id }}" lat="{{ hotspot.lat }}" lon="{{ hotspot.lon }}">
                            {{ hotspot.name }}
                        </option>
                    {% endfor %}
                </select>
                <input type="text" id="id_hotspot_datepicker" name="hotspot_date">
                <select id="id_hotspot_time" name="hotspot_time"></select>
            </li>
            <span id="to">{% trans 'To' %}</span>
            <li id="p1" class="point">
                <input type=text class="big_text b_marker marker_disabled address_ac_to" id="id_p1_raw"
                       name="p1_raw"
                       placeholder="{% trans 'Enter drop-off address' %}"/>
                <span class="price"></span>
            </li>
        </ul>

        <h3>{% trans "More (optional)" %}</h3>
        <p>
            <label for="id_computation_set_name">{% trans "Name" %}</label>
            <input type="text" id="id_computation_set_name" name="computation_set_name">
        </p>
        {{ constraints_form.as_p }}

        <button type=submit class="order_button" id="order_button">{% trans 'Pick Me Up' %}</button>
    </form>


    <a href="#" id="add_point">{% trans 'Add point' %}</a>
    <a href="#" id="toggle_hotspot">{% trans 'Switch Direction' %}</a>

{% endblock %}


{% block doc_ready %}
    {{ block.super }}
    <script src="http://api.navigator.telmap.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">

        var pickup = "pickup",
                dropoff = "dropoff",
                hotspot_type = pickup,
                point_counter = 1;

        function addPoint(address) {
            point_counter ++;
            var address_type = "p" + point_counter;
            OrderingHelper.createHiddenFields(address_type);

            var $input = $('<input type=text class="big_text marker_disabled"/>').attr("id", 'id_p' + point_counter + '_raw').attr("name", 'p' + point_counter + '_raw');
            var $remove = $('<a href="#" dir="rtl">X</a>').click(function(e) {
                e.preventDefault();
                OrderingHelper.deleteHiddenFields(address_type);
                OrderingHelper.removePoint(address_type);
                $(this).parent().remove();
            });
            var $price = $('<span class="price"></span>');

            var $point = $('<li class="point" id="' + address_type + '"></li>').append($remove, $input, $price);
            $(".point").last().after($point);

            var point_type = (hotspot_type == pickup) ? dropoff : pickup;
            if (point_type == pickup) {
                OrderingHelper.asPickup("#" + address_type);
            }
            else {
                OrderingHelper.asDropoff("#" + address_type);
            }

            OrderingHelper._makeAddressInput($input);

            if (address){
                address.address_type = address_type;
                address.populateFields();
            }
        }

        function asHotSpotInput(hotspot_selector, datepicker_selector, times_selector) {

            var $hotspot = $(hotspot_selector);
            var $datepicker = $(datepicker_selector);
            var $times = $(times_selector);

            $datepicker.data("cached_dates", []);
            $datepicker.data("cached_months", []);
            var cached_dates = $datepicker.data("cached_dates");
            var cached_months = $datepicker.data("cached_months");

            $datepicker.datepicker("destroy");
            $times.empty().disable().append("<option>{% trans "Choose Date" %}</option>");

            function onChangeMonthYear(year, month, inst) {
                if ($.inArray(month, cached_months) < 0) {
                    // get dates for this month
                    $.ajax({
                        url: "{% url sharing.passenger_controller.get_hotspot_dates %}",
                        dataType: "json",
                        data: {'month': month, 'year': year, 'hotspot_id': $hotspot.val()},
                        success: function(response) {
                            var new_dates = $.map(response.dates, function(date, i) {
                                return (new Date(date)).toDateString();
                            });
                            cached_dates = cached_dates.concat(new_dates);
                            cached_months[cached_months.length] = month;
                            inst.input.datepicker("refresh");
                        },
                        error: function() {
                            alert("Error loading hotspot dates data");
                        }
                    });
                }
            }

            function onSelect(dateText, inst) {
                $times.empty().disable().append("<option>{% trans "Updating..." %}</option>");

                $.ajax({
                    url: "{% url sharing.passenger_controller.get_hotspot_times %}",
                    dataType: "json",
                    data: {'day': dateText, 'hotspot_id': $hotspot.val()},
                    success: function(response) {
                        $times.empty();
                        $.each(response.times, function(i, d) {
                            $times.append("<option>" + d + "</option>");
                        });
                        $times.enable();
                        $times.change();
                    },
                    error: function() {
                        alert("Error loading hotspot times data");
                    }
                });
            }

            $datepicker.datepicker({
                dateFormat: 'dd/mm/yy',
                firstDay: 0,
                minDate: new Date(),
                isRTL: true,
                beforeShowDay: function(date) {
                    return ($.inArray(date.toDateString(), cached_dates) !== -1) ? [true, "", ""] : [false, "", ""];
                },
                onChangeMonthYear: onChangeMonthYear,
                onSelect: onSelect
            });

            var today = getFullDate(new Date());
            $datepicker.datepicker("setDate", today);
            onSelect(today, undefined);
        }

        function refrestHotspotMarker() {
            var lat = $("#id_hotspot_select :selected").attr("lat");
            var lon = $("#id_hotspot_select :selected").attr("lon");
            var icon_image = new telmap.maps.MarkerImage("/static/images/hotspot_marker.png", undefined, undefined, {x:20, y:20});
            var point = new telmap.maps.Marker({
                map:        OrderingHelper.map,
                position:   new telmap.maps.LatLng(lat, lon),
                draggable:  false,
                icon:       icon_image,
                title:      'Hotspot'
            });

            OrderingHelper.removePoint("hotspot");
            OrderingHelper.map_markers["hotspot"] = point;
            OrderingHelper.renderMapMarkers();
        }

        function updatePrice(address) {
            if (address.lon && address.lat) {
                var $price = $("#id_" + address.address_type + "_raw").siblings(".price");
                $.ajax({
                    url: "{% url sharing.passenger_controller.get_hotspot_price %}",
                    dataType: "json",
                    data: { 'lon': address.lon,
                            'lat': address.lat,
                            'hotspot_id': $("#id_hotspot_select").val(),
                            'day': $("#id_hotspot_datepicker").val(),
                            'time': $("#id_hotspot_time").val()
                    },
                    beforeSend: function(){
                        $price.text("{% trans "Updating..." %}");
                    },
                    success: function(response) {
                        var price = (response.price) ? response.price + "â‚ª" : "No price defined";
                        $price.text(price);
                    },
                    error: function() {
                        $price.text("Err");
                        alert("Error loading price");
                    }
                });
            }
        }

        $(function() {

            $("#id_hotspot_select").change(function() {
                asHotSpotInput("#id_hotspot_select", "#id_hotspot_datepicker", "#id_hotspot_time");
                refrestHotspotMarker();
                $(".price").text("");
            });
            $("#id_hotspot_select").change();

            $("#id_hotspot_time").change(function() {
                $(".address_ac_to").each(function(i, e) {
                    var address = Address.fromInput(e);
                    updatePrice(address);
                });
            });

            {% autoescape off %}
                OrderingHelper.config.hidden_fields = {{ hidden_fields }};
                OrderingHelper.config.update_address_callback = updatePrice;
            {% endautoescape %}

            $("#toggle_hotspot").click(function(e) {
                e.preventDefault();
                hotspot_type = (hotspot_type == pickup) ? dropoff : pickup;
                if (hotspot_type == pickup) {
                    OrderingHelper.asDropoff(".point");
                    $("#to").before($("#hotspot")).after($(".point"));
                }
                else {
                    OrderingHelper.asPickup(".point");
                    $("#to").before($(".point")).after($("#hotspot"));
                }
                OrderingHelper.initPoints();
            });

            $("#add_point").click(function(e) {
                e.preventDefault();
                addPoint();
            });

            $("#order_form").submit(function() {
                $(this).append('<input type="hidden" name="hotspot_type" value="' + hotspot_type + '"/>');

                if ($("#id_time_const_min").val() && $("#id_time_const_frac").val()) {
                    alert("Please specify only one time constraint");
                    return false;
                }
                else {
                    if ($("#id_time_const_frac").val()) {
                        $(this).append('<input type="hidden" name="time_const_frac" value="' + $("#id_time_const_frac").val() + '"/>');
                    }
                    if ($("#id_time_const_const").val()) {
                        $(this).append('<input type="hidden" name="time_const_min" value="' + $("#id_time_const_min").val() + '"/>');
                    }
                }
            });

            telmap.maps.event.addListener(OrderingHelper.map, 'click', function(e) {
                $.ajax({
                    url: "{% url ordering.passenger_controller.resolve_coordinates %}",
                    type: "GET",
                    data: { lat: e.latLng.lat(),
                        lon: e.latLng.lng()  },
                    dataType: "json",
                    success: function(resolve_result) {
                        var new_address = Address.fromServerResponse(resolve_result);
                        if (new_address.street_address) {   // only update to new address if it contains a valid street
                            if ($(":focus").parent().hasClass("point")) {
                                new_address.address_type = $(":focus").parent().attr("id");
                                new_address.populateFields();
                            }
                            else {
                                addPoint(new_address);
                            }
                            OrderingHelper.updateAddressChoice(new_address);
                            $('#id_' + new_address.address_type + '_raw').effect("highlight", 2000);
                        } else {                    // set previous address
                            alert("No street address where you clicked");
                        }
                    }
                });
            });

        });
    </script>

{% endblock %}