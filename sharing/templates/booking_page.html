{% extends "wb_base_site.html" %}
{% load i18n %}
{% load value_from_settings %}

{% block bodyclass %}booking-page{% endblock %}

{% block headertext %}{% trans "Book a Ride" %}{% endblock %}

{% block content %}
    <div id="content" ng-app="BookingApp">
        <div class="container" ng-controller="BookingCtrl" ng-init="sync()" ng-cloak>
            <div class="row-fluid">

                <div class="span4">

                    <!-- 1. Booking Form -->
                    <div id="booking-form" class="booking-panel" ng-hide="offers.length">
                        <form class="form-horizontal">
                            <div class="row-fluid">
                                <div class="input-prepend span12">
                                    <span class="add-on"><i class="icon-map-marker"></i></span>
                                    <input class="span11" type="text" placeholder="{% trans "Pickup Address" %}" wb-pac
                                           address="pickup" value="(( pickup.formatted_address ))">
                                </div>
                            </div>
                            <div class="row-fluid">
                                <div class="input-prepend span12">
                                    <span class="add-on"><i class="icon-map-marker"></i></span>
                                    <input class="span11" type="text" placeholder="{% trans "Dropoff Address" %}" wb-pac
                                           address="dropoff" value="(( dropoff.formatted_address ))">
                                </div>
                            </div>

                            <hr class="dashed">

                            <div class="control-group">
                                <label class="control-label time span2"></label>

                                <div class="controls controls-row span10">
                                    <div class="row-fluid">
                                        <select class="span6 btn" ng-model="pickup_date"
                                                ng-options="item as item | wb_date:'EEE d/M' for item in pickup_date_options()"></select>
                                        <select id="pickup-time" class="span6 btn" ng-model="pickup_time"
                                                ng-options="item as item for item in pickup_time_options()"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label ride-type span2"></label>

                                <div class="controls controls-row span10">
                                    <select class="btn btn-block" ng-model="is_private"
                                            ng-options="item.value as item.label for item in [{label: '{% trans 'Shared' %}', value:false}, {label: '{% trans 'Private' %}', value:true}]">>
                                    </select>
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label luggage span2"></label>

                                <div class="controls controls-row span10">
                                    <select class="btn btn-block" ng-model="has_luggage"
                                            ng-options="item.value as item.label for item in [{label: '{% trans 'No Luggage' %}', value:false}, {label: '{% trans 'With Luggage' %}', value:true}]">
                                    </select>
                                </div>
                            </div>
                            <div class="control-group" ng-hide="private_price">
                                <label class="control-label seats span2"></label>

                                <div class="controls controls-row span10">
                                    <select class="btn btn-block" ng-model="num_seats"
                                            ng-options="item for item in [1,2]"></select>
                                </div>
                            </div>
                            <div id="private-price" ng-show="private_price">
                                <p class="text-info">
                                    <strong>{% trans "Private ride price" %} (( private_price | currency:"₪"))</strong>
                                </p>
                            </div>

                            <hr class="dashed">
                            <button class="btn btn-large btn-block btn-warning btn-large"
                                    ng-disabled="!ready_to_order() || loading"
                                    ng-click="get_offers()"
                                    type="submit">{% trans "Find a Ride" %}</button>
                        </form>

                        <alerts></alerts>

                    </div>

                    <!-- 2. Booking Details -->
                    <div class="booking-panel" ng-show="offers.length">
                        <h3>{% trans "Your Order Details" %}</h3>
                        <hr class="dashed">
                        <p>{% trans "From" %}: (( pickup.formatted_address ))</p>

                        <p>{% trans "To" %}: (( dropoff.formatted_address ))</p>
                        <hr class="dashed">
                        <p ng-switch on="has_luggage">
                            <span ng-switch-when="false">{% trans "No Luggage" %}</span>
                            <span ng-switch-when="true">{% trans "With Luggage" %}</span>
                        </p>

                        <p>(( num_seats )) Seat</p> <!-- todo ngPluralize -->
                        <p class="pull-right">
                            <a href="#" ng-click="reset()" ng-show="!loading && !booking_approved">{% trans "change order settings" %}</a>
                        </p>

                        <div class="clearfix"></div>
                    </div>
                </div>

                <div class="span8">
                    <!-- 1. Map -->
                    <div id="map-container" ng-hide="offers.length">
                        <div id="map" wb-map></div>
                    </div>

                    <!-- 2. Offers -->
                    <div ng-show="offers.length && !booking_approved">
                        <div id="offers-container" class="wb-container rides-container" ng-class="{'blur': selected_offer}">
                            <div class="rides-cat">
                                <div class="rides-cat-header">{% trans "Choose a Ride to Join" %}</div>
                                <div class="no-match" ng-hide="existing_ride_offers().length"
                                     ng-class="{'disabled': selected_offer}">
                                    לא נמצאו נסיעות מתאימות.
                                    <br>
                                    הזמינו נסיעה חדשה, ואחרים יצטרפו אליכם!
                                </div>
                                <div class="rides-list"
                                     ng-repeat="offer in existing_ride_offers() | orderBy:'pickup_time'">
                                    <offer class="existing" ng-click="choose_offer(offer)" ng-class="{'focus': selected_offer == offer}"></offer>
                                    <offer-action type="existing" ng-show="selected_offer == offer" ng-class="{'focus': selected_offer == offer}"></offer-action>
                                    <ride-sep></ride-sep>
                                </div>
                            </div>
                            <div class="rides-cat">
                                <div class="rides-cat-header">{% trans "Start a New Ride" %}</div>
                                <div class="rides-list" ng-repeat="offer in new_ride_offers() | orderBy:'pickup_time'">
                                    <offer class="new" ng-click="choose_offer(offer)" ng-class="{'focus': selected_offer == offer}"></offer>
                                    <offer-action type="new" ng-show="selected_offer == offer" ng-class="{'focus': selected_offer == offer}"></offer-action>
                                </div>
                            </div>
                        </div>

                        <alerts></alerts>

                        <div id="offers-disclaimer">
                            {% trans "Price are determined by the Price Chart that is computed based on station cost." %}
                        </div>
                    </div>

                    <!-- 3. Order Approved -->
                    <div class="wb-container" ng-show="booking_approved">
                        <div id="summary-header">
                            <h2><i class="icon-ok"></i>{% trans "Order Accepted" %}</h2>
                        </div>

                        <hr class="dashed">

                        <!-- booking result -->
                        <div class="rides-container">
                            <div class="ride existing">
                                <div class="row-fluid">
                                    <div class="ride-passengers span4">
                                        <div class="type-indicator"></div>
                                        <div class="ride-pics">
                                            <div class="ride-pics-col"
                                                 ng-repeat="passenger in booking_result.passengers"
                                                 ng-switch on="passenger.is_you">
                                                <ride-pics-passenger ng-switch-when="false"></ride-pics-passenger>
                                                <ride-pics-you ng-switch-when="true"></ride-pics-you>
                                            </div>
                                            <ride-pics-seat
                                                    ng-repeat="x in []|range:booking_result.seats_left"></ride-pics-seat>
                                        </div>
                                    </div>
                                    <div class="ride-pickup-details span4">
                                        <strong>Pickup: (( booking_result.pickup_dt | wb_date:"EEE d/M" )) ((
                                            booking_result.pickup_dt | date:"H:mm" ))</strong>

                                        <div>(( booking_result.seats_left )) {% trans "Availabe Seats" %}</div>
                                    </div>
                                    <div class="ride-price-details span4">
                                        <strong class="price">(( booking_result.price | currency:"₪"
                                            ))</strong><span> {% trans "or less" %}</span>
                                    </div>
                                </div>
                            </div>
                            <ride-sep></ride-sep>
                        </div>
                        <div id="summary-footer">
                            <div id="summary-info">
                                <ul>
                                    <li>{% trans "Taxi live tracking will be available upon notification" %}</li>
                                    <li>{% trans "We will notify you in case a better taxi is found or if someone had joined your ride" %}</li>
                                    <li>
                                        {% trans "Detailed verification email was sent to " %}{{ request.user.email }}</li>
                                </ul>
                            </div>
                            <hr class="dashed">
                            <h4>{% trans "Invite friends to join WAYbetter" %}</h4>

                            <div id="summary-buttons" class="row-fluid">
                                <div class="span6">
                                    <a href="{% url ordering.ordering_controller.fb_share %}"
                                       class="btn btn-large btn-primary">
                                        <i class="icon-facebook"></i> {% trans "Share on Facebook" %}</a>
                                </div>
                                <div class="span6">
                                    <a href="{% url wb_home %}"
                                       class="btn btn-large btn-warning pull-right">{% trans "Back To Home" %}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}

    <script type="text/javascript" src="/static/js/wb.geolib.js"></script>
    <script type="text/javascript" src="/static/js/wb-ng/controllers.js"></script>
    <script type="text/javascript" src="/static/js/wb-ng/services.js"></script>
    <script type="text/javascript" src="/static/js/wb-ng/directives.js"></script>
    <script type="text/javascript" src="/static/js/wb-ng/defaults.js"></script>
    <script type="text/javascript" src="/static/js/wb-ng/geo.controllers.js"></script>
    <script type="text/javascript" src="/static/js/wb-ng/geo.services.js"></script>
    <script type="text/javascript" src="/static/js/wb-ng/geo.directives.js"></script>

    <script type="text/javascript">
        var app = angular.module('BookingApp', ['wbControllers', 'wbDirectives', 'wbGeoDirectives', 'wbFilters']);
        app.config(function ($interpolateProvider, $httpProvider) {
            $interpolateProvider.startSymbol('((');
            $interpolateProvider.endSymbol('))');

            $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';
            $httpProvider.defaults.transformRequest.push(function (data, headersGetter) {
                if (data) {
                    return jQuery.param(angular.fromJson(data));
                } else {
                    return data;
                }
            });
        });
        app.directive('alerts', function () {
            return {
                restrict: 'E',
                replace: true,
                template:
                        '<div class="alerts" ng-show="loading_message || booking_error">' +
                                '<div class="progress progress-striped active" ng-show="loading_message"> <div class="bar" style="width: 100%;"></div> </div>' +
                                '<div ng-show="loading_message"> (( loading_message ))</div>' +
                            '<div class="alert alert-error" ng-show="booking_error"> (( booking_error ))</div>' +
                        '</div>'
            }

        });
    </script>
{% endblock %}
