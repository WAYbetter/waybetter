{% extends "wb_base_mobile.html" %}
{% load i18n %}
{% load value_from_settings %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .address_type_indicator {
            font-style: italic;
            font-weight: normal;
            font-size: 12px;
            margin: 0 5px;
        }

        .err_msg {
            color: red;
        }
    </style>
{% endblock %}

{% block doc_ready %}
    {{ block.super }}

    <script defer="defer">
    //<![CDATA[
    var hotspots = [];

    var choose_pickup_time_msg = "{% trans 'Choose Pickup Time' %}";
    var choose_dropoff_time_msg = "{% trans 'Choose Dropoff Time' %}";
    var pickup_time_msg = "{% trans 'Pickup Time' %}";
    var dropoff_time_msg = "{% trans 'Dropoff Time' %}";
    var pickup_msg = "{% trans 'Pickup' %}";
    var dropoff_msg = "{% trans 'Dropoff' %}";

    function showDialog(dialog_name) {
        alert(dialog_name);
    }

    function showNoServiceDialog(address) {
        showDialog("{% trans "Currently we can't offer service in " %} " + address.name);
    }

    function showError(msg) {
        {% block show_error %}
        alert(msg);
        {% endblock show_error %}
    }
    function showNotification(msg, title) {
    {% block show_notification %}
        alert(msg);
    {% endblock show_notification %}
    }

    function getIntervals(select_nearest_interval, allow_page_change) {
        if (! isTimePickingAllowed() ) {
            return; // do nothing if hotspot_type is not pickup or address and hotspot are not defined yet
        }
        log("get intervals");
        var day = $("#ride-date").val();
        var $time_sel = $("#ride-time");
        var data = {
            hotspot_id: MobileHelper.hotspot.id,
            day: day,
            hotspot_type: MobileHelper.hotspot_type,
            time_type: MobileHelper.hotspot_type
        };
        if (MobileHelper.address) {
            $.extend(data, {
                lat: MobileHelper.address.lat,
                lon: MobileHelper.address.lon
            })
        }
        HotspotHelper.getIntervals({
            data: data,
            success: function(response) {
                if (response.times) {
                    $time_sel.empty();
                    $.each(response.times, function(i, t) {
                        $time_sel.append("<option>" + t + "</option>");
                    });
                    $time_sel.selectmenu().selectmenu('refresh', true);
                    if (select_nearest_interval) {
                        $("#select-interval-form").submit();
                    }
                    if (allow_page_change) {
                        if (MobileHelper.ride_time && response.times.indexOf(MobileHelper.ride_time) == -1 && ($.mobile.activePage.attr("id") != "welcome_page")) {
                            $.mobile.changePage("#interval_page");
                        } else if ($.mobile.activePage.attr("id") == "hotspot_page" || $.mobile.activePage.attr("id") == "booking_page" || $.mobile.activePage.attr("id") == "address_page") {
                            $.mobile.changePage("#booking_page", {reverse: true});
                        }
                    }

                }
            },
            complete: function() {
                updateChooseTimesButton();
            }
        });
    }

    function isTimePickingAllowed() {
        return (MobileHelper.hotspot && (MobileHelper.hotspot_type == "pickup" || MobileHelper.address));
    }
    function updateChooseTimesButton() {
        var $parent_ul = $("#choose_time_btn").closest("ul");
        var $links = $parent_ul.find("a");
        $parent_ul.children().remove();

        $.each($links, function(i, e) {
            var $new_li = $("<li></li>").attr("data-theme", "a").attr("data-icon", "arrow-l");
            $new_li.append(e);
            if ($(e).attr("id") == "choose_time_btn" && ! isTimePickingAllowed() ) {
                $new_li.attr("data-theme", "e").attr("data-icon", "none");
                renderHotspotType();
            }

            $parent_ul.append($new_li);
        });

        try {
            $parent_ul.listview("refresh");
        } catch (e) {
            log("listview refresh failed");
            if ($parent_ul.closest(".ui-page").length > 0) { // safely call listview()
                $parent_ul.listview();
            }
        }

    }

    function renderNumseats(){
        var text = undefined, label = undefined;
        if (MobileHelper.num_seats == 1) {
            text = "{% trans 'One seat' %}";
        } else {
            label = "{% trans 'Seats' %}";
            text = MobileHelper.num_seats + " " + label;
        }
        $("#numseats_btn h1").text(text);
        $("#ride_details_page .more_details .numseats").text(text);
    }

    function resetAddress() {
        MobileHelper.address = undefined;
        $("#choose_address_btn").find(".header").text("{% trans 'Enter Address' %}");
        $("#address-form")[0].reset();
    }
    function populateAddressFields(address){
        $("#id_city").val(address.city).selectmenu().selectmenu('refresh');
        $("#id_street").val(address.street_address);
        $("#id_house_number").val(address.house_number);
        $("#address_page button").button().button("enable");
    }
    // TODO_WB: check hotspot_type to decide where the updated text should go
    function selectAddress(address) {
        var city_ids = $.map(MobileHelper.sharing_cities, function(el, i) {
            return el.id;
        });

        if ($.inArray(address.city, city_ids) < 0) {
            return; // no service in this city
        }

        log("select address");
        MobileHelper.address = address;
        $("#choose_address_btn").find(".header").text(address.name);
        populateAddressFields(address);

        getIntervals(false, true);


    }

    function resetHotspot() {
        MobileHelper.hotspot = undefined;
        $("#choose_hotspot_btn").find(".header").text("{% trans 'Choose Hotspot' %}");
        $("#choose_hotspot_btn").find(".desc").text("");
    }
    // TODO_WB: check hotspot_type to decide where the updated text should go
    function selectHotspot(hotspot) {
        if (hotspot == MobileHelper.hotspot) {
            $.mobile.changePage("#booking_page");
        }
        else {
            log("select hotspot");
            MobileHelper.hotspot = hotspot;
            MobileHelper.ride_date = undefined;
            MobileHelper.ride_time = undefined;

            $("#choose_hotspot_btn").find(".header").text(hotspot.name);
            $("#choose_hotspot_btn").find(".desc").text(hotspot.description);

            var msg = window["choose_" + MobileHelper.hotspot_type + "_time_msg"];
            $("#interval_page").find("[data-role=header] h1, label[for='ride-time']").text(msg);
            $("#choose_time_btn").find(".header").text(msg);

            var $date_sel = $("#ride-date").empty();

            // set hotspot dates
            $.each(hotspot.next_dates, function(i, date) {
                var d = getFullDate(new Date(date));
                var today = getFullDate(new Date());
                var $option = $('<option value="' + d + '">' + ((d == today) ? "{% trans "Today" %}" : d ) + '</option>');
                $date_sel.append($option);
            });

            getIntervals(false, true);
        }
    }

    function resetIntervals() {
        MobileHelper.ride_time = MobileHelper.ride_date = undefined ;
        $("#ride-time").empty().selectmenu().selectmenu("refresh");
        $("#ride-date").empty().selectmenu().selectmenu("refresh");
        $("#choose_time_btn").find(".desc").text("");
        updateChooseTimesButton();
    }

    function resetSeats() {
        MobileHelper.num_seats = 1;
        renderNumseats();
    }

    function getRideDetails() {
        log("ride details");
        $.ajax({
            url: "{% url sharing.passenger_controller.get_hotspot_price %}",
            dataType: "json",
            data: {
                'num_seats': MobileHelper.num_seats,
                'lat': MobileHelper.address.lat,
                'lon': MobileHelper.address.lon,
                'hotspot_id': MobileHelper.hotspot.id,
                'hotspot_type': MobileHelper.hotspot_type,
                'day': MobileHelper.ride_date,
                'time': MobileHelper.ride_time,
                'ride_duration': HotspotHelper.ride_duration
            },
            success: function(response) {
                if (response.sharing_price && response.sharing_time && response.private_price && response.private_time) {
                    $("#sharing_price .value").text(response.sharing_price);
                    $("#sharing_time .value").text(response.sharing_time);
                    $("#private_price .value").text(response.private_price);
                    $("#private_time .value").text(response.private_time);
                    $(".ride_summary .ride_discount").text("{% trans 'SAVE' %} " + response.savings + "%");
                    $(".order_button").enable();
                    $.mobile.changePage("#choose_ride_page");
                } else {
                    var error = response.error || "{% trans "Currently, there is no service to this address at the selected hour." %}";
                    showError(error);
                }
            },
            error: function() {
                showError("{% trans "We have encountered an error. Please try again." %}");
            }
        });
    }

    function renderHotspotType() {
        var msg = window["choose_" + MobileHelper.hotspot_type + "_time_msg"];
        var desc_text = "";
        $("#interval_page").find("[data-role=header] h1, label[for='ride-time']").text(msg);

        if (MobileHelper.ride_date && MobileHelper.ride_time) {
            if (isTimePickingAllowed()) {
                msg = window[MobileHelper.hotspot_type + "_time_msg"] + ": ";
                desc_text = MobileHelper.ride_time;
            }
        }
        $("#choose_time_btn").find(".desc").text(desc_text);
        $("#choose_time_btn").find(".header").text(msg);

    }

    function switchOrderingDirection(direction) {
        if (direction && MobileHelper.hotspot_type == direction) {
            return; // do nothing
        }

        $(".booking_widget").eq(0).swapElement($(".booking_widget").eq(1));

        var typ1 = $(".booking_label .type").eq(0);
        var typ2 = $(".booking_label .type").eq(1);
        typ1.swapElement(typ2);
        typ1.redraw();
        typ2.redraw();

        $("#ride_details_page .dropoff .details_label").swapElement($("#ride_details_page .pickup .details_label"));
        $("#ride_details_page .dt_cntr").eq(0).swapElement($("#ride_details_page .dt_cntr").eq(1));

        if (MobileHelper.hotspot_type == "pickup") {
            MobileHelper.hotspot_type = "dropoff";
        } else {
            MobileHelper.hotspot_type = "pickup";
        }
        renderHotspotType();
        if (isTimePickingAllowed()) {
            getIntervals(false, MobileHelper.ride_date && MobileHelper.ride_time);
        } else {
            updateChooseTimesButton();
        }
    }

    function bookRide(is_private) {
        var $form = $("<form></form>");

        var hidden_inputs = {
            is_private: is_private,
            num_seats: MobileHelper.num_seats,
            time_type: MobileHelper.hotspot_type,
            ride_duration: HotspotHelper.ride_duration,
            hotspot_id: MobileHelper.hotspot.id,
            hotspot_type: MobileHelper.hotspot_type,
            hotspot_time: MobileHelper.ride_time,
            hotspot_date: MobileHelper.ride_date,
            id_city: $("#id_city").val(),
            street_address: MobileHelper.address.street_address,
            house_number: MobileHelper.address.house_number,
            lat: MobileHelper.address.lat,
            lon: MobileHelper.address.lon
        };

        $.each(hidden_inputs, function(k, v) {
            $form.find("input[name='" + k + "']").remove();
            $form.append($('<input type="hidden"/>').attr("name", k).attr("value", v));
        });

        $.ajax({
            url: "{% url sharing.passenger_controller.book_ride %}",
            data: $form.serialize(),
            type: "POST",
            beforeSend: function() {
                $(".order_button").disable();
            },
            success: function(response) {
                {% block book_ride_success %}
                if (response.status && response.status == "booked" && response.redirect) {
                    if (! response.authenticated ) {
                        $.mobile.changePage("#login_or_register_page");
                    } else {
                        window.location.href = response.redirect;
                    }
                }
                else {
                    //TODO_WB: redirect to error page
                    var message = "{% trans "We have encountered an error. Please try again." %}";
                    if (response.message) {
                        message = response.message;
                    }
                    showError(message);
                    $(".order_button").enable();
                }
                {% endblock book_ride_success %}

            },
            error: function() {
                // TODO_WB: show error message/redirect to error page
                $(".order_button").enable();
            }
        });
    }

    function chooseHotspotViaCurrentLocation() {
        MobileHelper.getCurrentLocation({
            locationSuccess: function(p) {
                var current_location_hotspot = undefined;
                $.each(hotspots, function(i, hs) {
                    if (MobileHelper.distance(p.coords.latitude, p.coords.longitude, hs.lat, hs.lon) <= hs.radius) {
                        log("IN HOTSPOT", hs, hs.radius);
                        current_location_hotspot = hs;
                        return false; //break
                    }
                });

                if (current_location_hotspot) {
                    selectHotspot(current_location_hotspot);
                    resetAddress();
                    switchOrderingDirection("pickup");
                } else {
                    MobileHelper.resolveLonLat(p.coords.longitude, p.coords.latitude, {onNewAddress: selectAddress});
                }
            }
        });
    }


    function init() {

        log("init");
        $(document).ajaxStart(function() {
            log("ajaxStart");
            $.mobile.showPageLoadingMsg();
        });
        $(document).ajaxStop(function() {
            log("ajaxStop");
            $.mobile.hidePageLoadingMsg();
        });

        // helpers init

        MobileHelper.init({
            urls:{
                resolve_coordinates     : "{% url ordering.passenger_controller.resolve_coordinates %}",
                get_myrides_data        : "{% url sharing.passenger_controller.get_myrides_data %}",
                cancel_order            : "{% url sharing.passenger_controller.cancel_order %}",
                get_order_status        : "{% url sharing.passenger_controller.get_order_status %}",
                get_sharing_cities      : "{% url get_sharing_cities %}"
            },
            labels: {
                pickup      : "{% trans 'From' %}",
                pickupat    : "{% trans '_pickupat' %}",
                dropoff     : "{% trans 'To' %}",
                price       : "{% trans 'Price' %}",
                cancel_ride : "{% trans 'Cancel Ride' %}",
                report_ride : "{% trans 'Report Ride' %}",
                sms_sent    : "{% trans 'An SMS notification will be sent (at no charge) prior to your pickup' %}.",
                final_pickup: "{% trans 'Final Pickup Time' %}",
                taxi_number : "{% trans 'Taxi Number' %}",
                taxi_station: "{% trans 'Taxi Station' %}",
                order_cancelled: "{% trans 'Order Cancelled' %}"
            },
            selectors: {
                ride_details_page   : "#myride_details_page",
                my_rides_page       : "#myrides_page",
                ride_details        : "#myride_details_page .ride_summary",
                ride_details_btn    : "#ride_details_btn"
            },
            callbacks:{
                locationSuccess: function (position) {
                    MobileHelper.resolveLonLat(position.coords.longitude, position.coords.latitude, {
                        onNewAddress: function(address) {
                            var city_ids = $.map(MobileHelper.sharing_cities, function(el, i) {
                                return el.id;
                            });
                            if (address && $.inArray(address.city, city_ids) < 0) {
                                showNoServiceDialog(address);
                            }
                            else{
                                populateAddressFields(address);
                            }
                        }
                    });
                },
                locationError: function() {

                }
            }
        });

        MobileHelper.getSharingCities({
            success: function(){
                var $city_sel = $("#id_city");
                $.each(MobileHelper.sharing_cities, function(i, city){
                    var $opt = $('<option></option>').val(city.id).text(city.name);
                    $city_sel.append($opt);
                });
                $city_sel.selectmenu().selectmenu("refresh");
            }
        });

        HotspotHelper.init({
            labels: {
                choose_date: "{% trans "Choose Date" %}",
                updating: "{% trans "Updating..." %}"
            },
            urls: {
                get_hotspot_data: "{% url sharing.passenger_controller.get_hotspots_data %}",
                get_hotspot_dates: "{% url sharing.passenger_controller.get_hotspot_dates %}",
                get_hotspot_times: "{% url sharing.passenger_controller.get_hotspot_times %}"
            }
        });

        HotspotHelper.getHotspotData({
            data: {numdays: 7},
            beforeSend: function() {
            },
            success: function(response) {
                var $hotspot_list = $("#hotspot_list");
                var hs_by_city_name = {};
                $.each(response.data, function(i, hotspot) {
                    hotspots.push(hotspot);
                    if (hs_by_city_name[hotspot.city_name]) {
                        hs_by_city_name[hotspot.city_name].push(hotspot);
                    }
                    else {
                        hs_by_city_name[hotspot.city_name] = [hotspot];
                    }
                });
                $.each(hs_by_city_name, function(city_name, hotspots) {
                    $hotspot_list.append('<li data-role="list-divider">' + city_name + '</li>');
                    $.each(hotspots, function(i, hotspot) {
                        var $a = $('<a href="#"><h1>' + hotspot.name + '</h1><p>' + hotspot.description + '</p></a>');
                        var $li = $('<li data-icon="arrow-l"></li>').prepend($a);
                        $a.click(function() {
                            selectHotspot(hotspot);
                        });
                        $hotspot_list.append($li);
                    });
                });

                var $suggest_li = $("<li data-icon='arrow-l'></li>").addClass("suggest_hotspot");
                var $suggest_link = $("<a><h1>" + "{% trans 'Suggest a new hotspot' %}" + "</h1></a>").attr("href", "mailto:support@waybetter.com?subject=My suggested hotspot");
                $suggest_li.append($suggest_link);
                $hotspot_list.append($suggest_li);

                chooseHotspotViaCurrentLocation();
            }
        });

        AddressHelper.init({
            urls:{
                structured_resolve_url: "{% url sharing.passenger_controller.resolve_structured_address %}"
            }
        });

        {% block init %}{% endblock %}

        // booking page
        $("#switch_direction_btn").click(function() {
            switchOrderingDirection()
        });

        $("#choose_time_btn").live("click", function() { // use live, see updateChooseTimesButton
            if ($(this).closest("li").attr("data-theme") != "e") {
                $.mobile.changePage("#interval_page");
            }
        });

        $("#calculate_ride_btn").button().button("disable");
        $("#calculate_ride_btn").click(function() {
            getRideDetails();
        });

        $("#reset_booking_page").click(function() {
            resetAddress();
            resetHotspot();
            resetIntervals();
            switchOrderingDirection("dropoff");
            renderHotspotType();
            resetSeats();
            $("#calculate_ride_btn").button("disable");
//            chooseHotspotViaCurrentLocation();
        });

        // numseats page
        $(".choose-numseats").click(function(){
            MobileHelper.num_seats = $(this).data("numseats");
            renderNumseats();
        });

        // address page
        $("#address_page").bind("pagebeforeshow", function(e, data) {
            if (MobileHelper.address) {
                $("#id_street").val(MobileHelper.address.street_address);
                $("#id_house_number").val(MobileHelper.address.house_number);
            }
            $("#address_page button").button().button("enable");
        });
        $("#address_page input").keyup(
                function() {
                    var valid = Boolean($("#id_house_number").val() && $("#id_street").val());
                    if (valid) {
                        $("#address_page button").button().button("enable");
                    }
                    else {
                        $("#address_page button").button().button("disable");
                    }
                }).trigger("keyup");

        $("#gps").click(function() {
            MobileHelper.getCurrentLocation();
        });
        $("#address-form").submit(function() {
            var that = this;
            var $sa_input = $("#id_street"),
                    $hn_input = $("#id_house_number");

            AddressHelper.resolveStructured({
                city_selector       : "#id_city",
                street_input        : $sa_input,
                hn_input            : $hn_input,
                return_multiple     : true,
                callbacks           :{
                    beforeSend: function() {
                        $("#hn_error, #street_error").text("");
                    },
                    resolved:function(results) {
                        if (results.length > 1) {
                            var $addresss_list = $("#address_list");
                            $addresss_list.empty();

                            $.each(results, function (i, result) {
                                var $a = $("<a href='#'>" + result.name + "</a>");
                                $a.click(function() {
                                    $.mobile.changePage("#booking_page");
                                    selectAddress(result);
                                });
                                $addresss_list.append($a);
                                $a.wrap("<li/>")
                            });
                            $.mobile.changePage("#address_list_page");
                            $addresss_list.listview("refresh");

                        } else {
                            selectAddress(results[0]);
                            if (!MobileHelper.hotspot) {
                                $.mobile.changePage("#booking_page");
                            } // otherwise selectAddress calls getIntervals which redirects to interval page
                        }
                    },
                    unresolved:function(errors) {
                        if (errors.house_number) {
                            $("#hn_error").text(errors.house_number);
                        }
                        else if (errors.street) {
                            $("#street_error").text(errors.street);
                        }
                        else {
                            showError("{% trans 'Could not resolve address' %}");
                        }
                    }
                }
            });
            return false;
        });

        $("#home").bind("pagebeforeshow", function() {
            MobileHelper.updateMyRidesBubble("#myrides_btn");
        });

        // intervals page
        $("#ride-date").change(function() {
            getIntervals(false);
        });

        $("#interval_page").bind("pagebeforeshow", function(e, data) {
            if (MobileHelper.ride_date) {
                $("#ride-date").val(MobileHelper.ride_date);
            }
            if (MobileHelper.ride_time) {
                $("#ride-time").val(MobileHelper.ride_time);
            }
            $("#ride-date").selectmenu("refresh");
            $("#ride-time").selectmenu("refresh");
        });
        $("#select-interval-form").submit(function() {
            MobileHelper.ride_date = $("#ride-date").val();
            MobileHelper.ride_time = $("#ride-time").val();
            if (MobileHelper.ride_date && MobileHelper.ride_time) {
                $("#ride-date").jqmData("saved_val", MobileHelper.ride_date);
                $("#ride-time").jqmData("saved_val", MobileHelper.ride_time);
                var msg = window[MobileHelper.hotspot_type + "_time_msg"];
                $("#choose_time_btn").find(".desc").text($("#ride-date :selected").text() + " " + MobileHelper.ride_time);
                $("#choose_time_btn").find(".header").text(msg + ": ");
                $("#calculate_ride_btn").button("enable");
            } else {
                $("#calculate_ride_btn").button("disable");
            }

            return false;
        });
        $("#select-interval-form button").click(function() {
            $("#select-interval-form").submit();
            $.mobile.changePage("#booking_page");
            return false;
        });

        // choose ride page
        $(".order_button").disable();
        $("#book_sharing").click(function() {
            bookRide(false);
        });

        $("#book_private").click(function() {
            bookRide(true);
        });
        $("#choose_ride_page").bind("pagebeforeshow", function(e, data) {
            if ((data.prevPage.attr("id") == "login_or_register_page")) {
                $(".order_button").enable();
            }
        });

        // ride details page
        $("#ride_details_page").bind("pagebeforeshow", function() {
            if (MobileHelper.address && MobileHelper.hotspot && MobileHelper.ride_date && MobileHelper.ride_time) {
                $("#ride_details_page .address .name").text(MobileHelper.address.name);
                $("#ride_details_page .address .desc").text("");
                $("#ride_details_page .hotspot .name").text(MobileHelper.hotspot.name);
                $("#ride_details_page .hotspot .desc").text(MobileHelper.hotspot.description);
                $("#ride_details_page .when p").text(MobileHelper.ride_date + " " + MobileHelper.ride_time);
                if (MobileHelper.hotspot_type == "pickup") {
                    $("#ride_details_page .when .details_label_type").text(pickup_time_msg);
                } else {
                    $("#ride_details_page .when .details_label_type").text(dropoff_time_msg);
                }
            }
        });

        // my rides page
        $("#myrides_page").bind("pagebeforeshow", function(e, data) {
            if ((data.prevPage.attr("id") == "myride_details_page")) {
                // if we get here from a ride details page dont get new data
            }
            else{
                $("#upcoming_rides_btn").click();
            }
        });
        $("#upcoming_rides_btn").click(function() {
            MobileHelper.getMyRidesData({get_next_rides: true}, "#rides_list", "#ride_details_page");
        });
        $("#ride_history_btn").click(function() {
            MobileHelper.getMyRidesData({get_previous_rides: true}, "#rides_list", "#ride_details_page");
        });

        {% block sharing_link %}
        // share page
//        $("#share_fb").click(function(e) {
//            window.location.href = SocialHelper.getFacebookShareLink(true);
//            e.preventDefault();
//        });
        $("#like_fb").click(function(e) {
            window.location.href = SocialHelper.getFacebookLikeLink(true);
            e.preventDefault();
        });
        {% endblock sharing_link %}

        $("#share_email").click(function() {
            window.location.href = SocialHelper.getEmailShareLink();
        });

        {% block welcome_page %}
        {% if not request.user.is_authenticated %}
            $.mobile.changePage("#welcome_page");
        {% endif %}
        {% endblock welcome_page %}

    }

    {% block init_call %}
    $(document).one("pageinit", init);
    {% endblock init_call %}
    //]]>
    </script>

{% endblock doc_ready %}

{% block body %}
    <div id="home" data-role="page" data-theme="a">
        <div data-role="header" class="wb-header"></div>
        <div class="sub-header">{% trans 'Shared Taxis to Central Locations' %}</div>
        <div data-role="content">
            <div class="ui-grid-a"> {#  2-column grid #}
                <div class="ui-block-a">
                    <a href="#booking_page" id="home_book_order_btn" data-role="button" data-iconpos="top"
                       data-icon="wb_custom">
                        {% trans 'Order Now' %}
                    </a>
                </div>

                <div class="ui-block-b">
                    {% block myrides_btn %}
                    <a id="myrides_btn" data-role="button" data-iconpos="top" data-icon="wb_custom"
                            {% if request.user.is_authenticated %}
                            href="#myrides_page"
                            {% else %}
                            href="{% url mobile_auth_login %}" data-ajax="false"
                            {% endif %}
                        >{% trans 'My Rides' %}
                    </a>
                    {% endblock myrides_btn %}
                </div>
            </div>
            <div class="ui-grid-a">
                <div class="ui-block-a">
                    <a href="mailto:support@waybetter.com" id="feedback_btn" data-role="button"
                       data-iconpos="top" data-icon="wb_custom">{% trans 'Feedback' %}</a>
                </div>

                <div class="ui-block-b">
                    <a href="#settings_page" id="settings_btn" data-role="button" data-iconpos="top"
                       data-icon="wb_custom">{% trans 'More' %}</a>
                </div>
            </div>
            <div class="ui-grid-b"> {#  3-column grid #}
                <div class="ui-block-a quarter"></div>
                <div class="ui-block-b half">
                    <a href="#share_page" id="share_btn" data-role="button" data-iconpos="top"
                       data-icon="wb_custom">{% trans 'Share' %}</a>
                </div>
                <div class="ui-block-c quarter"></div>
            </div>

        </div>
    </div>

    <div id="welcome_page" data-role="page" data-theme="a">
        <div data-role="header" class="wb-header"></div>
        <div data-role="content" class="center">
            <div class="text">
                <p><strong>{% trans 'Welcome' %}</strong></p>

                <p>{% trans "mobile_app_welcome_txt" %}</p>

                <p><strong>{% trans 'This app is free (as in free beer)' %}</strong></p>
            </div>
            <hr/>
            <div class="buttons">
                <a href="#home" data-role="button" data-transition="fade" data-theme="d"
                   class="first">{% trans 'Enter App' %}</a>
                <a href="#login_or_register_page" data-ajax="false" data-role="button"
                   data-theme="f">{% trans 'Login/Join Now' %}</a>
            </div>

            <div class="welcome-img"></div>
        </div>
    </div>

    <div id="login_or_register_page" data-role="page" data-theme="a">
        <div data-role="header">
            <h1>{% trans "Login To Your Account" %}</h1>
            <a href="#" data-rel="back" data-theme="h" class="ui-btn-right">{% trans 'Back' %}</a>
        </div>
        <div data-role="content" class="center">
            <div class="bold center">{% trans "Login to enjoy WAYbetter taxi service" %}</div>

            <p></p>
            <a data-ajax="false" href="{% url join %}" data-role="button" data-theme="d">{% trans 'New Member? Join Now!' %}</a>
            <p></p>
            <a data-ajax="false" href="{% url mobile_auth_login %}?next={% url login_redirect %}" data-role="button" data-theme="d">{% trans 'Memebers Entrance' %}</a>

            <hr/>

            <div id="advtgs">
                <div class="bold">יתרונות השירות:</div>
                <ul>
                    <li>אין דמי מנוי. אתה חוסך, כולם מרוויחים</li>
                    <li>סע בלי מזומן! תשלום באשראי מהאפליקציה</li>
                    <li>תזכורת חינם ב-SMS בטרם הגעת המונית</li>
                    <li>חסכון מובטח של עשרות שקלים בכל נסיעה</li>
                    <li>ניהול נסיעות, חשבונית מס חודשית מפורטת</li>
                    <li>שירות יעיל, ירוק וידידותי לסביבה ולאדם</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="booking_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" id="reset_booking_page" data-icon="wb_reset" data-theme="h" data-iconpos="notext" data-transition="pop"></a>
            <h1>{% trans 'Your WAY' %}</h1>
            <a href="#home" data-icon="wb_custom" data-theme="h" data-iconpos="notext" data-transition="pop"></a>

        </div>
        <div data-role="content">
            <div class="booking_label from_label">
                <span class="label_box">{% trans "From" %}</span>
                <span class="type">{% trans "Address" %}</span>
            </div>

            <div class="booking_widget">
                <ul data-role="listview" class="rtl-listview narrow" data-inset="true">
                    <li data-icon="arrow-l">
                        <a href="#address_page" id="choose_address_btn">
                            <h1 class="header">{% trans "Enter Address" %}</h1>
                            <p class="desc"></p>
                        </a>
                    </li>
                </ul>
            </div>

            <div id="switch_direction_container">
                <button type="button" id="switch_direction_btn"
                        data-theme="f">{% trans "Switch Ride Direction" %}</button>
                <div id="switch-dir-img"></div>
            </div>

            <div class="booking_label to_label">
                <span class="label_box">{% trans "To" %}</span>
                <span class="type">{% trans "Central Location" %}</span>
            </div>

            <div class="booking_widget">
                <ul data-role="listview" class="rtl-listview narrow" data-inset="true">
                    <li data-icon="arrow-l">
                        <a href="#hotspot_page" id="choose_hotspot_btn">
                            <h1 class="header">{% trans "Choose Hotspot" %}</h1>
                            <p class="desc"></p>
                        </a>
                    </li>
                    <li data-icon="none" data-theme="e">
                        <a href="#" id="choose_time_btn">
                            <h1 class="header">{% trans 'Choose Dropoff Time' %}</h1>
                            <p class="desc"></p>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="booking_widget" id="seat_selector_wrapper" >
                <ul data-role="listview" class="rtl-listview narrow" data-inset="true">
                    <li data-icon="arrow-l">
                        <a href="#numseats_page" id="numseats_btn">
                            <h1 class="header">{% trans "One seat" %}</h1>
                            <p class="desc"></p>
                        </a>
                    </li>
                </ul>
            </div>
            <button type="button" id="calculate_ride_btn" data-theme="d">{% trans "Calculate Ride" %}</button>
        </div>
    </div>

    <div id="numseats_page" data-role="page">
        <div data-role="header">
            <a href="#" data-rel="back" class="ui-btn-right" data-theme="h">{% trans "Back" %}</a>
            <h1>{% trans 'Number of Seats' %}</h1>
        </div>
        <div data-role="content">
            <ul data-role="listview" class="rtl-listview" data-inset="true">
                <li data-icon="arrow-l">
                    <a href="#" class="choose-numseats" data-numseats="1" data-rel="back">{% trans "Order 1 seat" %}</a>
                </li>
                {% for i in "234" %}
                    <li data-icon="arrow-l">
                        <a href="#" class="choose-numseats" data-numseats="{{ i }}" data-rel="back">{% blocktrans %}Order {{ i }} seats{% endblocktrans %}</a>
                    </li>
                {% endfor %}


            </ul>
        </div>
    </div>

    <div id="choose_ride_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-rel="back" class="ui-btn-right" data-theme="h">{% trans "Back" %}</a>

            <h1>{% trans 'Your WAY' %}</h1>
            {#            <a href="#">{% trans 'Map' %}</a>#}
        </div>
        <div data-role="content">
            <div class="order-details-link">
                <a href="#ride_details_page" data-transition="flip">
                    {% trans 'View Order Details' %}
                </a>
            </div>
            {% csrf_token %}

            <div class="ride_summary">
                <div class="ride_discount"></div>
                <h3 class="shared">{% trans "Shared Taxi Ride" %}</h3>

                <div class="details">
                    <p id="sharing_price" class="price">{% trans "Fixed Ride Price" %}: <span class="value">0</span>
                        <span class="label"> ₪</span></p>

                    <p id="sharing_time" class="time">{% trans "Est. Ride Duration" %}: <span
                            class="value">0</span> {% trans "min" %}</p>
                </div>
                <button id="book_sharing" class="order_button" data-theme="d">{% trans 'Book Shared Taxi' %}</button>

                <hr/>

                <h3 class="private">{% trans "Private Taxi Ride" %}</h3>

                <div class="details">
                    <p id="private_price" class="price">{% trans "Fixed Ride Price" %}: <span class="value">0</span>
                        <span class="label"> ₪</span></p>

                    <p id="private_time" class="time">{% trans "Est. Ride Duration" %}: <span
                            class="value">0</span> {% trans "min" %}</p>
                </div>
                <button id="book_private" class="order_button" data-theme="c">{% trans 'Book Private Taxi' %}</button>
            </div>
        </div>
    </div>

    <div id="myrides_page" data-role="page">
        <div data-role="header">
            <a href="#home" data-icon="wb_custom" data-theme="h" data-iconpos="notext" data-transition="pop"
               class="ui-btn-right"></a>

            <h1>{% trans "My Rides" %}</h1>

            <div data-role="navbar">
                <ul class="ui-body-g">
                    <li><a id="upcoming_rides_btn" href="#" class="ui-btn-active">{% trans 'Upcoming Rides' %}</a></li>
                    <li><a id="ride_history_btn" href="#">{% trans 'Ride History' %}</a></li>
                </ul>
            </div>
        </div>
        <div data-role="content">
            <ul id="rides_list" data-role="listview" class="rtl-listview" data-theme="a">
            </ul>
        </div>
    </div>

    <div id="myride_details_page" data-role="page">
        <div data-role="header">
            <a href="#" data-rel="back" data-theme="h" class="ui-btn-right">{% trans 'Back' %}</a>

            <h1>{% trans "Ride Details" %}</h1>
        </div>
        <div data-role="content">
            <div class="ride_summary">
                <div class="pickup">
                    <span class="details_label">{% trans "From" %}</span>
                    <div class="text"></div>
                </div>
                <hr/>
                <div class="dropoff">
                    <span class="details_label">{% trans "To" %}</span>
                    <div class="text"></div>
                </div>
                <hr/>
                <div class="when">
                    <span class="details_label">{% trans "_pickupat" %}: </span>
                    <span class="text"></span>
                </div>
                <div class="price">
                    <span class="details_label">{% trans "Price" %}: </span>
                    <span class="text"></span>
                </div>
            </div>

            <div class="ride_details_comment"></div>
            <a id="ride_details_btn" data-role="button" href="#" data-theme="f"></a>
        </div>
    </div>

    <div id="ride_details_page" data-role="page">
        <div data-role="header">
            <a href="#" data-rel="back" data-theme="h" class="ui-btn-right">{% trans "Back" %}</a>

            <h1>{% trans 'Ride Details' %}</h1>
            <a href="#booking_page" data-theme="h" class="ui-btn-left">{% trans "Edit" %}</a>
        </div>
        <div data-role="content">
            <div class="order-details-link">
                <a href="#" data-rel="back" data-transition="flip">
                    {% trans 'Back To Ride Order' %}
                </a>
            </div>

            <div class="ride_summary">
                <div class="pickup">
                    <div class="dt_cntr">
                        <div class="address">
                            <span class="details_label">{% trans "Pickup" %}</span>
                            <span class="details_label_type"> {% trans 'Address' %} </span>
                            <p class="name"></p>
                            <p class="desc"></p>
                        </div>
                    </div>

                </div>
                <hr/>
                <div class="dropoff">
                    <div class="dt_cntr">
                        <div class="hotspot">
                            <span class="details_label">{% trans "Dropoff" %}</span>
                            <span class="details_label_type"> {% trans 'Hotspot' %} </span>
                            <p class="name"></p>
                            <p class="desc"></p>
                        </div>
                        <hr/>
                        <div class="when">
                            <span class="details_label_type"></span>
                            <p></p>
                        </div>
                    </div>
                </div>
                <div class="more_details">
                    <div class="numseats"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="hotspot_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-rel="back" class="ui-btn-right" data-theme="h">{% trans 'Cancel' %}</a>

            <h1>{% trans 'Choose Hotspot' %}</h1>
        </div>
        <div data-role="content">
            <ul id="hotspot_list" class="rtl-listview" data-role="listview" data-theme="a">
            </ul>
        </div>
    </div>

    <div id="address_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-rel="back" data-theme="h" class="ui-btn-right">{% trans 'Cancel' %}</a>

            <h1>{% trans 'Enter Address' %}</h1>
            <a id="gps" data-theme="h" class="ui-btn-left">{% trans 'GPS' %}</a>

        </div>
        <div data-role="content">
            <form id="address-form">
                <select id="id_city" name="id_city" data-theme="a"></select>

                <div class="street-hn-cntr">
                    <div class="street-cntr">
                        <input type="text" name="street" id="id_street" placeholder="{% trans 'Street' %}"/>
                        <span id="street_error" class="err_msg"></span>
                    </div>
                    <div class="hn-cntr">
                        <input type="tel" name="house_number" id="id_house_number" placeholder="{% trans 'House #' %}"/>
                        <span id="hn_error" class="err_msg"></span>
                    </div>
                </div>

                <button data-theme="b">{% trans 'Next' %}</button>
            </form>
        </div>
    </div>

    <div id="address_list_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-theme="h" data-rel="back">{% trans 'Back' %}</a>

            <h1>{% trans 'Select Address' %}</h1>
        </div>
        <div data-role="content">
            <ul data-role="listview" id="address_list" data-theme="a"></ul>
        </div>
    </div>

    <div id="interval_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-rel="back" class="ui-btn-right" data-theme="h">{% trans 'Cancel' %}</a>

            <h1></h1>
        </div>

        <div data-role="content">
            <form action="" id="select-interval-form">
                <label for="ride-date">{% trans "Choose day" %}</label>
                <select name="ride-date" id="ride-date" data-theme="a"></select>
                <label for="ride-time">{% trans "Choose time" %}</label>
                <select name="ride-time" id="ride-time" data-theme="a"></select>
                <button data-theme="b">{% trans 'Next' %}</button>
            </form>
        </div>
    </div>

    <div id="share_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#home" data-icon="wb_custom" data-theme="h" data-iconpos="notext" data-transition="pop"
               class="ui-btn-right"></a>

            <h1>{% trans "Share" %}</h1>
        </div>
        <div data-role="content">
            <ul class="rtl-listview" data-role="listview" data-inset="true">
{#                <li data-icon="arrow-l"><a id="share_fb" href="#" data-ajax="false">{% trans "Share on Facebook" %}</a></li>#}
                <li data-icon="arrow-l"><a id="like_fb" href="#" data-ajax="false">{% trans "Like us" %}</a></li>
                <li data-icon="arrow-l"><a id="share_email" href="#">{% trans "Tell a Friend (email)" %}</a></li>
                <li data-icon="arrow-l"><a target="_blank" rel="external" id="rate_on_itunes" href="{% value_from_settings "APPLE_WAYBETTER_ITUNES_URL" %}">{% trans "Rate Us" %}</a></li>
            </ul>
            <div class="note">{% trans "Remember, the more passengers using this app the better it becomes (higher efficiency, cheaper rides and better availablity). <br/><br/>Thanks :)" %}</div>
        </div>
    </div>

    <div id="settings_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#home" data-icon="wb_custom" data-theme="h" data-iconpos="notext" data-transition="pop"
               class="ui-btn-right"></a>
            <h1>{% trans "More" %}...</h1>
        </div>
        <div data-role="content">
            <ul id="settings_list" class="rtl-listview" data-role="listview" data-inset="true">
                <li data-icon="arrow-l"><a href="#about_page">{% trans "About" %}</a></li>
                <li data-icon="arrow-l"><a href="{% url faq %}" data-ajax="false">{% trans "FAQ" %}</a></li>
            </ul>
            <ul class="rtl-listview" data-role="listview" data-inset="true">
                <li data-icon="arrow-l"><a href="{% url privacy %}" data-ajax="false">{% trans "Privacy Policy" %}</a></li>
                <li data-icon="arrow-l"><a href="{% url terms %}" data-ajax="false">{% trans "Terms of Use" %}</a></li>
            </ul>

            <ul id="auth_list" class="rtl-listview" data-role="listview" data-inset="true">
                {% block settings_list %}
                {% if request.user.is_authenticated %}
                <li data-icon="arrow-l"><a data-ajax="false" href="{% url auth_logout %}">{% trans "Logout" %} ({{ request.user.username }})</a></li>
                {% else %}
                <li data-icon="arrow-l"><a data-ajax="false" href="{% url mobile_auth_login %}">{% trans "Login" %}</a></li>
                {% endif %}
                {% endblock settings_list %}
            </ul>

        </div>
    </div>

    <div id="about_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-rel="back" data-theme="h" class="ui-btn-right">{% trans 'Back' %}</a>

            <h1>{% trans "About" %}</h1>
        </div>
        <div data-role="content">
            <div class="ui-grid-a">
                <div class="ui-block-a">
                    <div class="about_icon"></div>
                </div>
                <div class="about_header ui-block-b">
                    <h1>WAYbetter</h1>
                    <p>1.0</p>
                </div>
            </div>
            <div class="copyright" class="ltr">© 2011 WAYbetter™ LTD. All rights reserved.<br/><span class="bold">Patent pending.</span></div>
            <div id="partners_logos"></div>
        </div>
    </div>

{% endblock body %}
