{% extends "wb_base_mobile.html" %}
{% load i18n %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .ride_summary {
            background: white;
            padding: 15px;
            border: 1px solid black;
        }

        .ride_summary h3 {
            text-align: center;
            margin: 0;
        }

        .address_type_indicator {
            font-style: italic;
            font-weight: normal;
            font-size: 12px;
            margin: 0 5px;
        }
    </style>
{% endblock %}

{% block doc_ready %}
    {{ block.super }}

    <script defer="defer">
    var hotspots = [];
    var current_hotspot = undefined;

    function showError(msg) {
        alert(msg);
    }

    function getIntervals(select_nearest_interval) {
        if (! (MobileHelper.hotspot && MobileHelper.address)) {
            return; // do nothing if hotspot and address are not defined yet
        }

        console.log("get intervals");
        var day = $("#ride-date").val();
        var $time_sel = $("#ride-time");
        HotspotHelper.getIntervals({
            data: {
                hotspot_id: MobileHelper.hotspot.id,
                day: day,
                hotspot_type: MobileHelper.hotspot_type,
                time_type: MobileHelper.time_type,
                lat: MobileHelper.address.lat,
                lon: MobileHelper.address.lon },
            success: function(response) {
                if (response.times) {
                    $time_sel.empty();
                    $.each(response.times, function(i, t) {
                        $time_sel.append("<option>" + t + "</option>");
                    });
                    if (response.ride_duration) {
                        $time_sel.data("ride_duration", response.ride_duration);
                    }
                    $time_sel.selectmenu().selectmenu('refresh', true);
                    if (select_nearest_interval) {
                        $("#select-interval-form").submit();
                    }
                }
            }
        });
    }

    // TODO_WB: check hotspot_type to decide where the updated text should go
    function selectAddress(address) {
        $.each(hotspots, function(i, hs) {
            if (MobileHelper.distance(address.lat, address.lon, hs.lat, hs.lon) <= 0.4) {
                console.log("IN HOTSPOT");
                console.log(hs);
                current_hotspot = hs;
            }
        });
        if (!(MobileHelper.address && MobileHelper.address.description == address.description)) {
            console.log("select address");
            MobileHelper.address = address;
            $("#pickup_name").text(address.description);
            getIntervals(true);
        }
    }

    // TODO_WB: check hotspot_type to decide where the updated text should go
    function selectHotspot(hotspot) {
        if (hotspot !== MobileHelper.hotspot) {
            console.log("select hotspot");
            MobileHelper.hotspot = hotspot;
            $("#dropoff_name").text(hotspot.name + ", " + hotspot.address);
            var $date_sel = $("#ride-date").empty();

            // set hotspot dates
            $.each(hotspot.next_dates, function(i, date) {
                var d = getFullDate(new Date(date));
                var $option = $('<option value="' + d + '">' + d + '</option>');
                $date_sel.append($option);
            });

            // update intervals
            getIntervals(true);
        }
    }

    function getRideDetails() {
        console.log("ride details");
        $.ajax({
            url: "{% url sharing.passenger_controller.get_hotspot_price %}",
            dataType: "json",
            data: {
                'lat': MobileHelper.address.lat,
                'lon': MobileHelper.address.lon,
                'hotspot_id': MobileHelper.hotspot.id,
                'day': $("#ride-date").val(),
                'time': $("#ride-time").val()
            },
            success: function(response) {
                if (response.sharing_price && response.sharing_time && response.private_price && response.private_time) {
                    $("#sharing_price .value").text(response.sharing_price);
                    $("#sharing_time .value").text(response.sharing_time);
                    $("#private_price .value").text(response.private_price);
                    $("#private_time .value").text(response.private_time);
                    $(".order_button").enable();
                    $.mobile.changePage("#choose_ride_page");
                } else {
                    showError("{% trans "Currently, there is no service to this address." %}");
                }
            },
            error: function() {
                showError("{% trans "We have encountered an error. Please try again." %}");
            }
        });
    }

    function getCurrentLocation() {
        MobileHelper.getCurrentLocation();
        $("#pickup_name").text('{% trans "Finding your location" %}');
    }

    function locationError() {
        $("#pickup_name").text("{% trans 'Could not find your current location' %}");
        MobileHelper.address = undefined;
    }

    function switchOrderingDirection(direction) {
        if (direction && MobileHelper.hotspot_type==direction) {
            return; // do nothing
        }
        
        var $ul_list = $("#booking_page div[data-role=content] ul");
        var $first_ul = $ul_list.first();
        var $second_ul = $($ul_list[1]);
        var $first_address_type = $first_ul.find("h1 .address_type_indicator");
        var $second_address_type = $second_ul.find("h1 .address_type_indicator");
        
        $first_ul.find("h1").text("{% trans 'To' %}").prepend($first_address_type);
        $second_ul.find("h1").text("{% trans 'From' %}").prepend($second_address_type);

        $first_ul.swap($second_ul);

        if (MobileHelper.hotspot_type == "pickup") {
            MobileHelper.hotspot_type = "dropoff";
        } else {
            MobileHelper.hotspot_type = "pickup";
        }
        getIntervals(true);
    }

    function bookRide(is_private) {
        var $form = $("#order_form");

        var hidden_inputs = {
            is_private: is_private,
            time_type: MobileHelper.time_type,
            ride_duration: $("#ride-time").data("ride_duration"),
            hotspot_id: MobileHelper.hotspot.id,
            hotspot_type: MobileHelper.hotspot_type,
            hotspot_time: $("#ride-time").val(),
            hotspot_date: $("#ride-date").val(),
            id_city: $("#id_city").val(),
            street_address: MobileHelper.address.street_address,
            house_number: MobileHelper.address.house_number,
            lat: MobileHelper.address.lat,
            lon: MobileHelper.address.lon
        };

        $.each(hidden_inputs, function(k, v) {
            $form.find("input[name='" + k + "']").remove();
            $form.append($('<input type="hidden"/>').attr("name", k).attr("value", v));
        });

        $form.ajaxSubmit({
            url: "{% url sharing.passenger_controller.book_ride %}",
            type: "POST",
            beforeSend: function() {
                $(".order_button").disable();
            },
            success: function(response) {
                if (response.status && response.status == "booked" && response.redirect) {
                    window.location.href = response.redirect;
                }
                else {
                    //TODO_WB: redirect to error page
                    var message = "{% trans "We have encountered an error. Please try again." %}";
                    if (response.message) {
                        message = response.message;
                    }
                    alert(message);
                    $(".order_button").enable();
                }
            },
            error: function() {
                // TODO_WB: show error message/redirect to error page
                $(".order_button").enable();
            }
        });
    }
    $(function() {
        $(document).ajaxSend(function() {
            $.mobile.showPageLoadingMsg();
        });
        $(document).ajaxComplete(function() {
            $.mobile.hidePageLoadingMsg();
        });
        $.mobile.changePage("#home", { transition: "none"});

        MobileHelper.init({
            urls:{
                resolve_coordinates: "{% url ordering.passenger_controller.resolve_coordinates %}"
            },
            callbacks:{
                onNewAddress: selectAddress,
                locationError: locationError
            }
        });

        HotspotHelper.init({
            labels: {
                choose_date: "{% trans "Choose Date" %}",
                updating: "{% trans "Updating..." %}"
            },
            urls: {
                get_hotspot_data: "{% url sharing.passenger_controller.get_hotspots_data %}",
                get_hotspot_dates: "{% url sharing.passenger_controller.get_hotspot_dates %}",
                get_hotspot_times: "{% url sharing.passenger_controller.get_hotspot_times %}"
            }
        });

        AddressHelper.init({
            urls:{
                structured_resolve_url: "{% url sharing.passenger_controller.resolve_structured_address %}"
            }
        });

        // try and find the current location
        getCurrentLocation();
        
        HotspotHelper.getHotspotData({
            data: {numdays: 7},
            beforeSend: function() {
            },
            success: function(response) {
                var $hotspot_list = $("#hotspot_list");
                var hs_by_city_name = {};
                $.each(response.data, function(i, hotspot) {
                    hotspots.push(hotspot);
                    if (hs_by_city_name[hotspot.city_name]) {
                        hs_by_city_name[hotspot.city_name].push(hotspot);
                    }
                    else {
                        hs_by_city_name[hotspot.city_name] = [hotspot];
                    }
                });
                $.each(hs_by_city_name, function(city_name, hotspots) {
                    $hotspot_list.append('<li data-role="list-divider">' + city_name + '</li>');
                    $.each(hotspots, function(i, hotspot) {
                        var $a = $('<a href="#"><h1>' + hotspot.name + '</h1><p>' + hotspot.address + '</p></a>');
                        var $li = $('<li></li>').prepend($a);
                        $a.click(function() {
                            $.mobile.changePage("#booking_page");
                            selectHotspot(hotspot);
                        });
                        $hotspot_list.append($li);
                    });
                });
            }
        });

        $("#ride-date").change(function() {
            getIntervals();
        });

        $("#gps").click(function() {
            getCurrentLocation();
            $.mobile.changePage("#booking_page");
        });

        $(".order_button").disable();
        $("#book_sharing").click(function() {
            bookRide(false);
        });
        $("#book_private").click(function() {
            bookRide(true);
        });

        // TODO_WB: remove jqmData usage from here
        $("#interval_page").bind("pagebeforeshow", function(e, data) {
            $("#ride-date").val($("#ride-date").jqmData("saved_val")).selectmenu("refresh");
            $("#ride-time").val($("#ride-time").jqmData("saved_val")).selectmenu("refresh");
        });

        $("#select-interval-form").submit(function() {
            $("#ride-date").jqmData("saved_val", $("#ride-date").val());
            $("#ride-time").jqmData("saved_val", $("#ride-time").val());
            $("#when").text($("#ride-date").val() + " " + $("#ride-time").val());
            return false;
        });
        $("#select-interval-form button").click(function() {
            $("#select-interval-form").submit();
            $.mobile.changePage("#booking_page");
            return false;
        });
        $("#calculate_ride_btn").click(function() {
            getRideDetails();
        });

        $("#switch_direction_btn").click(function() {
            switchOrderingDirection()
        });

        $("#home_book_order_btn").click(function() {
            if (current_hotspot) { // user is very close to a hotspot
                selectHotspot(current_hotspot);
                MobileHelper.address = undefined;
                $("#pickup_name").text('');
                switchOrderingDirection("pickup");
            } else if (MobileHelper.address) {
                switchOrderingDirection("dropoff");
            }

            $.mobile.changePage("#booking_page");

        });

        $("#address-form").submit(function() {
            var that = this;
            var $sa_input = $("#id_street"),
                    $hn_input = $("#id_house_number");

            AddressHelper.resolveStructured({
                city_selector       : "#id_city",
                street_input        : $sa_input,
                hn_input            : $hn_input,
                return_multiple     : true,
                callbacks           :{
                    resolved:function(results) {
                        if (results.length > 1) {
                            var $addresss_list = $("#address_list");
                            $addresss_list.empty();

                            $.each(results, function (i, result) {
                                var $a = $("<a href='#'>" + result.name + "</a>");
                                $a.click(function() {
                                    $.mobile.changePage("#booking_page");
                                    selectAddress(result);
                                });
                                $addresss_list.append($a);
                                $a.wrap("<li/>")
                            });
                            $.mobile.changePage("#address_list_page");
                            $addresss_list.listview("refresh");

                        } else {
                            $.mobile.changePage("#booking_page");
                            selectAddress(results[0]);
                        }
                    },
                    unresolved:function(errors) {
                        alert("{% trans 'Could not resolve address' %}");
                    }
                }
            });
            return false;
        });
    });
    </script>

{% endblock doc_ready %}

{% block body %}

    <div id="home" data-role="page" data-theme="a">
        <div data-role="header">
            <h1>WAYbetter</h1>
        </div>
        <div data-role="content">
            <div class="ui-grid-a"> {#  2-column grid #}
                <div class="ui-block-a">
                    <a href="#" id="home_book_order_btn" data-role="button" data-iconpos="top" data-icon="check">
                        {% trans 'Order a Ride' %}
                    </a>
                </div>
                <div class="ui-block-b">
                    <a href="{% url mobile_auth_login %}" data-role="button" data-iconpos="top" data-icon="check">
                        {% trans 'Login' %}
                    </a>
                </div>
                <div class="ui-block-a">
                    <a href="#" data-role="button" data-iconpos="top" data-icon="check">
                        {% trans 'Feedback' %}
                    </a>
                </div>
                <div class="ui-block-b">
                    <a href="#" data-role="button" data-iconpos="top" data-icon="check">
                        {% trans 'More' %}
                    </a>
                </div>
            </div>
            <div class="ui-grid-b"> {# 3-column grid #}
                <div class="ui-block-a"></div>
                <div class="ui-block-b">
                    <a href="#" data-role="button" data-iconpos="top" data-icon="check">
                        {% trans 'Share' %}
                    </a>
                </div>
                <div class="ui-block-c"></div>
            </div>
        </div>
    </div>

    <div id="booking_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#home" data-icon="grid" data-iconpos="notext" data-transition="pop"></a>

            <h1>{% trans 'Your WAY' %}</h1>
            <a href="#">{% trans 'Map' %}</a>
        </div>
        <div data-role="content">
            <ul data-role="listview" data-inset="true" data-theme="a">
                <li>
                    <a href="#address_page">
                        <h1><span id="first_address_type" class="address_type_indicator">{% trans 'Enter Address' %}</span>{% trans "From" %}</h1>

                        <p id="pickup_name"></p>
                    </a>
                </li>
            </ul>
            <button id="switch_direction_btn" type="button" data-role="none">&#8645;</button>
            <ul data-role="listview" data-inset="true" data-theme="a">
                <li>
                    <a href="#hotspot_page">
                        <h1><span id="second_address_type" class="address_type_indicator">{% trans 'Choose Hotspot' %}</span>{% trans "To" %}</h1>
                        <p id="dropoff_name"></p>
                    </a>
                </li>
            </ul>
            <hr/>
            <ul data-role="listview" data-inset="true" data-theme="a">
                <li>
                    <a href="#interval_page">
                        <h1>{% trans "When" %}</h1>

                        <p id="when"></p>
                    </a>
                </li>
            </ul>
            <hr/>
            <button type="button" id="calculate_ride_btn" data-theme="b">{% trans "Calculate Ride" %}</button>
        </div>
    </div>


    <div id="choose_ride_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-rel="back">{% trans "Back" %}</a>

            <h1>{% trans 'Your WAY' %}</h1>
            <a href="#">{% trans 'Map' %}</a>
        </div>
        <div data-role="content">
            <form id="order_form">
                {% csrf_token %}
                <div class="ride_summary">
                    <h3>{% trans "WAYbetter Taxi Ride" %}</h3>

                    <div>
                        <p id="sharing_price">{% trans "Ride Price" %}: <span class="value">0</span> ₪</p>

                        <p id="sharing_time">{% trans "Est. Ride Duration" %}: <span
                                class="value">0</span> {% trans "min" %}</p>
                    </div>
                    <button id="book_sharing" data-theme="d">{% trans 'Book WAYbetter' %}</button>

                </div>
                <p/>

                <div class="ride_summary">
                    <h3>{% trans "Private Taxi Ride" %}</h3>

                    <div>
                        <p id="private_price">{% trans "Ride Price" %}: <span class="value">0</span> ₪</p>

                        <p id="private_time">{% trans "Est. Ride Duration" %}: <span
                                class="value">0</span> {% trans "min" %}</p>
                    </div>
                    <button id="book_private" data-theme="c">{% trans 'Book Private' %}</button>

                </div>
            </form>
        </div>
    </div>
    <div id="hotspot_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-rel="back">{% trans 'Cancel' %}</a>

            <h1>{% trans 'Select HotSpot' %}</h1>
        </div>
        <div data-role="content">
            <ul id="hotspot_list" data-role="listview" data-theme="a">
                <li data-theme="d">
                    {% trans 'Hotspots are areas where WAYbetter offers cheap taxis' %}
                </li>
            </ul>
        </div>
    </div>

    <div id="address_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-rel="back">{% trans 'Cancel' %}</a>

            <h1>{% trans 'Enter Address' %}</h1>
            <a id="gps">{% trans 'GPS' %}</a>

        </div>
        <div data-role="content">
            <form action="" id="address-form">
                <div data-role="fieldcontain">
                    <select id="id_city" name="id_city">
                        {% for city in cities %}
                            <option value="{{ city.id }}">{{ city.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" name="street" id="id_street" placeholder="{% trans 'Street' %}"/>
                    <input type="tel" name="house_number" id="id_house_number" placeholder="{% trans 'House #' %}"/>
                </div>
                <button>{% trans 'Next' %}</button>
            </form>
        </div>
    </div>

    <div id="address_list_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#" data-rel="back">{% trans 'Back' %}</a>

            <h1>{% trans 'Select Address' %}</h1>
        </div>
        <div data-role="content">
            <ul data-role="listview" id="address_list" data-theme="a"></ul>
        </div>
    </div>

    <div id="interval_page" data-role="page" data-theme="a">
        <div data-role="header">
            <a href="#booking_page" data-rel="back">{% trans "Cancel" %}</a>

            <h1>{% trans 'Pickup Time' %}</h1>
        </div>

        <div data-role="content">
            <form action="" id="select-interval-form">
                <label for="ride-date">{% trans "Choose day" %}</label>
                <select name="ride-date" id="ride-date" data-theme="a"></select>
                <label for="ride-time">{% trans "Choose time" %}</label>
                <select name="ride-time" id="ride-time" data-theme="a"></select>
                <button>{% trans 'Next' %}</button>
            </form>
        </div>
    </div>

{% endblock body %}
