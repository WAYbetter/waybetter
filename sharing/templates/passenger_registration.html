{% extends "wb_base_site.html" %}
{% load i18n %}

{% block pre_content %}
    <div id="top-container">
        <div id="top-header">
            {% trans "First Time? Join the Movement...  " %}
        </div>
        <div id="top-login">
            {% trans "Already a member?" %} <span class="wb_link">{% trans "Sign In" %}</span>
        </div>
        <div class="clear"></div>
    </div>

{% endblock %}

{% block content %}
    {% if order %}
        <div>
            Order Details:<br>{{ order }}<br> {{ order.value }} NIS
        </div>
    {% endif %}

    <form id="validation">
        <div class="header">
            1. {% trans "Ride notifications are sent via free SMS:" %}
        </div>
        <div class="container">
            <div class="float-l">
                <label for="local_phone">
                    {% trans "Mobile Phone" %}
                </label>
                <input id="local_phone" name="local_phone" type="text"/>
                <button type="button" id="validate_phone">{% trans "Get Code" %}</button>
            </div>
            <div class="float-r">
                <label for="verification_code">
                    {% trans "Code" %}
                </label>
                <input id="verification_code" name="verification_code" type="text"/>
                <input name="country_code" type="hidden" value="{{ country_code }}"/>
                <span id="verification_status"></span>
            </div>
        </div>
    </form>

    <table id="registration_details">
        <tr>
            <td colspan="3">
                <span class="header">
                    2. {% trans "Setup your account:" %}
                </span>
            </td>
        </tr>

        <tr>
            <td>
                {% trans "Use your Facebook account for fast registration:" %}
                <div id="fb_connect"></div>
            </td>
            <td>
                <div class="vrule"></div>
                <div>{% trans "OR" %}</div>
                <div class="vrule"></div>
            </td>
            <td>
                {% load ajax_form_utils %}
                <form id="passenger_form" action="{% url register %}" method="POST">
                    {% csrf_token %}
                    <table id="user_details">
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                        {% for field in form.visible_fields %}
                            {% if field.html_name != "agree_to_terms" %}
                                <tr>
                                    <th>{{ field.label_tag }}</th>
                                    <td>{{ field }}</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    <input type="checkbox" name="agree_to_terms" id="id_agree_to_terms"/>
                    <label for="id_agree_to_terms">{% trans "I agree to the" %}
                        <span class="wb_link">{% trans "Terms Of Use" %} </span>
                        {% trans "and" %} <span class="wb_link">{% trans "Privacy Statement" %}</span>
                    </label>
                    <button id="finish_registration">{% trans "Next" %} >></button>
                </form>
            </td>
        </tr>
    </table>


{% endblock %}

{% block doc_ready %}
    <script src="/static/js/mylibs/jquery.ajax_forms.js"></script>
    <script src="/static/js/mylibs/jquery.ajax_forms.validation.js"></script>
    <script src="/static/js/mylibs/jquery.form.js"></script>
    <script src="/static/js/helpers.js"></script>
    <script type="text/javascript">
        function updateValidatePhoneButtonState() {
            if ($("#local_phone").val()) {
                $("#validate_phone").enable();
            } else {
                $("#validate_phone").disable();
            }
        }

        function setPassengerFormStatus(enable) {
            var sel = "#passenger_form input, #passenger_form button";
            if (enable) {
                $(sel).enable();
            } else {
                $(sel).disable();
            }
        }
        $(function() {
            var validations =  {% render_ajax_fields form %};
            $('#passenger_form').validation(validations);

            updateValidatePhoneButtonState();
            setPassengerFormStatus(false);

            $("#local_phone").keyup(function() {
                updateValidatePhoneButtonState()
            });
            $("#verification_code").keyup(
                    function() {
                        var val = $(this).val();
                        if (val && val.length == 4) {
                            var data = $("#validation").serialize();
                            $("#verification_code").disable();
                            $("#verification_status").addClass("sending");

                            $.ajax({
                                url: "{% url validate_phone %}",
                                type: "POST",
                                data: data,
                                success: function() {
                                    $("#verification_status").addClass("success");
                                    $("#validation input").disable();
                                    setPassengerFormStatus(true);
                                },
                                error: function() {
                                    $("#verification_status").addClass("error");
                                    $("#verification_code").enable();
                                },
                                complete: function() {
                                    $("#verification_status").removeClass("sending");
                                }

                            })
                        }
                    }).keydown(function(event) {
                        var permittedKeys = [8,37,38,39,40,46];

                        if ($(this).val().length >= 4 && $.inArray(event.which, permittedKeys) < 0) {
                            return false;
                        }
                    });
            $("#validate_phone").click(function() {
                $.ajax({
                    url: "{% url send_verification_code %}",
                    data: $("#validation").serialize(),
                    type: "POST",
                    success: function(d) {
                        alert(d)
                    },
                    error: function() {
                        alert("error")
                    }
                })
            })
        });
    </script>
{% endblock %}
