{% extends "base_passenger.html" %}
{% load i18n %}

{% block bodyclass %}clean_body{% endblock %}
{% block mainclass %}clean_main full_screen_main{% endblock %}

{% block extrastyle %}
<style>
    #verification_status {
        width: 20px;
        height: 20px;
        border:  1px solid black;
        display: inline-block;
    }
    #verification_status.success {
        background-color: #008000;
    }
    #verification_status.error {
        background-color: red;
    }
    #verification_status.sending {
        background-color: orange;
    }

</style>
{% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        <p>Welcome, {{ user.username }}. Thanks for logging in.</p>
    {% else %}
        <p>Welcome, new user. Please log in.</p>
    {% endif %}
    
    {% if order %}
        <div>
            Order Details:<br>{{ order }}<br> {{ order.value }} NIS
        </div>
    {% endif %}
    <div>
        Phone validation:
        <form id="validation">
            <label for="local_phone">
                {% trans "Mobile Phone" %}
            </label>
            <input id="local_phone" name="local_phone" type="text"/>
            <button type="button" id="validate_phone">{% trans "Get Code" %}</button>
            <label for="verification_code">
                {% trans "Verification Code" %}
            </label>
            <input id="verification_code" name="verification_code" type="text"/>
            <input name="country_code" type="hidden" value="{{ country_code }}"/>
            <span id="verification_status"></span>
        </form>
    </div>
    <div>
        {% load ajax_form_utils %}
        <form id="passenger_form" action="{% url register %}" method="POST">
            {% csrf_token %}
            {{ form }}

            <button id="finish_registration">{% trans "Next" %} >></button>
        </form>
    </div>
{% endblock %}

{% block doc_ready %}
    <script src="/static/js/helpers.js"></script>
    <script type="text/javascript">
    function updateValidatePhoneButtonState() {
        if ($("#local_phone").val()) {
            $("#validate_phone").enable();
        } else {
            $("#validate_phone").disable();
        }
    }

    function setPassengerFormStatus(enable) {
        var sel = "#passenger_form input, #passenger_form button";
        if (enable) {
            $(sel).enable();
        } else {
            $(sel).disable();
        }
    }
    $(function() {
        var validations =  {% render_ajax_fields form %};
        $('#passenger_form').validation(validations);
        
        updateValidatePhoneButtonState();
        setPassengerFormStatus(false);

        $("#local_phone").keyup(function() {
            updateValidatePhoneButtonState()
        });
        $("#verification_code").keyup(function() {
            var val = $(this).val();
            if (val && val.length == 4) {
                var data = $("#validation").serialize();
                $("#verification_code").disable();
                $("#verification_status").addClass("sending");

                $.ajax({
                    url: "{% url validate_phone %}",
                    type: "POST",
                    data: data,
                    success: function() {
                        $("#verification_status").addClass("success");
                        $("#validation input").disable();
                        setPassengerFormStatus(true);
                    },
                    error: function() {
                        $("#verification_status").addClass("error");
                        $("#verification_code").enable();
                    },
                    complete: function() {
                        $("#verification_status").removeClass("sending");
                    }

                })
            }
        }).keydown(function(event) {
            var permittedKeys = [8,37,38,39,40,46];

            if ($(this).val().length >= 4 && $.inArray(event.which, permittedKeys) < 0) {
                return false;
            }
        });
        $("#validate_phone").click(function() {
            $.ajax({
                url: "{% url send_verification_code %}",
                data: $("#validation").serialize(),
                type: "POST",
                success: function(d) {
                    alert(d)
                },
                error: function() {
                    alert("error")
                }
            })
        })
    });
    </script>
{% endblock %}
