{% extends "base_passenger.html" %}
{% load i18n %}

{% block bodyclass %}clean_body{% endblock %}
{% block mainclass %}clean_main full_screen_main{% endblock %}

{% block extrastyle %}
    <link rel="stylesheet" href="/static/css/jquery-ui-1.8.14.smoothness.css" type="text/css" media="all">
    <link rel="stylesheet" href="/static/css/sharing.css" type="text/css" media="all">
{% endblock %}


{% block content %}
    <div id="map_container">
        <div id="map"></div>
    </div>

    <form id="order_form" method="post" action="{% url sharing.passenger_controller.book_ride %}">
        {% csrf_token %}
        {% for field in hidden_fields %}
            <input type="hidden" id="id_p1_{{ field }}" name="p1_{{ field }}"/>
        {% endfor %}
        <input type="hidden" id="id_geocoded_p1_raw" name="geocoded_p1_raw"/>

        <div>
            <span id="from">{% trans 'From' %}</span>
            <li id="hotspot">
                <select id="id_hotspot_select" name="hotspot_id"></select>
                <input type="text" id="id_hotspot_datepicker" name="hotspot_date">
                <select id="id_hotspot_time" name="hotspot_time"></select>
            </div>

            <span id="to">{% trans 'To' %}</span>

            <div id="p1" class="point">
                <input type=text id="id_p1_raw" name="p1_raw" placeholder="{% trans 'Enter drop-off address' %}"/>
                <span class="price"></span>
            </div>
        <button type=submit class="order_button" id="order_button">{% trans 'Send' %}</button>
        </div>
    </form>
{% endblock %}


{% block doc_ready %}
    {{ block.super }}
    <script src="http://api.navigator.telmap.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">

        var pickup = "pickup",
                dropoff = "dropoff",
                hotspot_type = pickup;

        function updatePrice(address) {
            if (address.lon && address.lat) {
                var $price = $("#id_" + address.address_type + "_raw").siblings(".price");
                $.ajax({
                    url: "{% url sharing.passenger_controller.get_hotspot_price %}",
                    dataType: "json",
                    data: { 'lon': address.lon,
                        'lat': address.lat,
                        'hotspot_id': $("#id_hotspot_select").val(),
                        'day': $("#id_hotspot_datepicker").val(),
                        'time': $("#id_hotspot_time").val()
                    },
                    beforeSend: function() {
                        $price.text("{% trans "Updating..." %}");
                    },
                    success: function(response) {
                        var price = (response.price) ? response.price + "â‚ª" : "No price defined";
                        $price.text(price);
                    },
                    error: function() {
                        $price.text("Err");
                        alert("Error loading price");
                    }
                });
            }
        }

        $(function() {

            HotspotHelper.makeHotSpotSelector("#id_hotspot_select", "#id_hotspot_datepicker", "#id_hotspot_time");

            $("#id_hotspot_select").change(function() {
                $(".price").text("");
            });

            $("#id_hotspot_time").change(function() {
                var address = Address.fromInput($("#id_p1_raw"));
                updatePrice(address);
            });

            {% autoescape off %}
                OrderingHelper.config.hidden_fields = {{ hidden_fields }};
                OrderingHelper.config.update_address_callback = updatePrice;
            {% endautoescape %}

            $("#order_form").submit(function() {
                var that = this;
                $(this).append('<input type="hidden" name="hotspot_type" value="' + hotspot_type + '"/>');
                $(this).ajaxSubmit({
                    beforeSend: function() {
                        $(that).find("button[type='submit']").text("{% trans "Sending" %}").button("disable");
                    },
                    complete: function() {
                        $(that).find("button[type='submit']").text("{% trans "Send" %}").button("enable");
                    },
                    success: function(response) {
                        if (response.status && response.status == "booked") {
                            alert("{% trans "Order booked" %}");
                        }
                    }
                });
                return false;
            });


            telmap.maps.event.addListener(OrderingHelper.map, 'click', function(e) {
                $.ajax({
                    url: "{% url ordering.passenger_controller.resolve_coordinates %}",
                    type: "GET",
                    data: { lat: e.latLng.lat(),
                        lon: e.latLng.lng()  },
                    dataType: "json",
                    success: function(resolve_result) {
                        var new_address = Address.fromServerResponse(resolve_result);
                        if (new_address.street_address) {   // only update to new address if it contains a valid street
                            new_address.address_type = "p1";
                            new_address.populateFields();
                            OrderingHelper.updateAddressChoice(new_address);
                            $('#id_' + new_address.address_type + '_raw').effect("highlight", 2000);
                        } else {                    // set previous address
                            flashMessage("No street address where you clicked");
                        }
                    }
                });
            });

        });
    </script>

{% endblock %}